<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SyncVent</title>
  <meta name="description" content="SyncVent — Plataforma educacional para raciocínio clínico em ventilação mecânica no adulto." />

  <style>
    :root{
      --bg:#0b0f17;
      --panel:#0f1624;
      --panel2:#0c1320;
      --text:#eaf0ff;
      --muted:#a9b6d6;
      --line:rgba(180,200,255,.16);
      --blue:#2d7dff;
      --blue2:#5aa0ff;
      --shadow: 0 10px 30px rgba(0,0,0,.45);
      --radius:16px;
    }
    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "Helvetica Neue", sans-serif;
      background: radial-gradient(1200px 600px at 20% 0%, rgba(45,125,255,.25), transparent 55%),
                  radial-gradient(900px 500px at 80% 20%, rgba(90,160,255,.18), transparent 55%),
                  linear-gradient(180deg, #070a10 0%, #0b0f17 100%);
      color:var(--text);
      overflow-x:hidden;
    }
    a{ color:var(--blue2); text-decoration:none; }
    a:hover{ text-decoration:underline; }

    /* Splash */
    #splash{
      position:fixed; inset:0;
      background: linear-gradient(180deg, #000 0%, #070a10 45%, #0b0f17 100%);
      display:flex; align-items:center; justify-content:center;
      z-index:9999;
      padding:24px;
    }
    .splashCard{
      width:min(760px, 100%);
      border:1px solid rgba(255,255,255,.10);
      border-radius:24px;
      background: rgba(15,22,36,.55);
      backdrop-filter: blur(10px);
      box-shadow: var(--shadow);
      padding:28px;
    }
    .brandRow{
      display:flex; align-items:center; gap:14px;
      margin-bottom:10px;
    }
    .logo{
      width:48px; height:48px;
      border-radius:14px;
      background: linear-gradient(135deg, rgba(45,125,255,1) 0%, rgba(90,160,255,1) 55%, rgba(255,255,255,.9) 130%);
      box-shadow: 0 10px 30px rgba(45,125,255,.35);
      position:relative;
    }
    .logo:after{
      content:"";
      position:absolute; inset:10px;
      border-radius:10px;
      background: rgba(0,0,0,.25);
      border:1px solid rgba(255,255,255,.22);
    }
    .brandTitle{
      display:flex; flex-direction:column;
      gap:2px;
    }
    .brandTitle h1{
      margin:0; font-size:28px; letter-spacing:.4px;
    }
    .brandTitle .sub{
      margin:0; color:var(--muted); font-size:13px;
    }
    .splashBody{
      margin-top:14px;
      display:grid;
      grid-template-columns: 1.1fr .9fr;
      gap:18px;
    }
    @media (max-width:860px){
      .splashBody{ grid-template-columns:1fr; }
    }
    .splashBox{
      border:1px solid var(--line);
      border-radius:18px;
      background: rgba(12,19,32,.55);
      padding:14px;
    }
    .splashBox h2{
      margin:0 0 8px 0;
      font-size:14px;
      color:#dce6ff;
      letter-spacing:.2px;
    }
    .splashBox p{
      margin:0;
      color:var(--muted);
      line-height:1.5;
      font-size:13px;
    }
    .btnRow{
      display:flex; gap:10px; justify-content:flex-end; align-items:center;
      margin-top:14px;
    }
    .btn{
      border:1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.06);
      color:var(--text);
      padding:10px 14px;
      border-radius:14px;
      cursor:pointer;
      font-weight:700;
      letter-spacing:.2px;
    }
    .btnPrimary{
      border-color: rgba(45,125,255,.55);
      background: linear-gradient(135deg, rgba(45,125,255,.95) 0%, rgba(90,160,255,.95) 100%);
      box-shadow: 0 12px 26px rgba(45,125,255,.22);
      color:#081022;
    }
    .btn:active{ transform: translateY(1px); }

    /* App shell */
    header{
      position:sticky; top:0; z-index:50;
      border-bottom:1px solid var(--line);
      background: rgba(7,10,16,.55);
      backdrop-filter: blur(10px);
    }
    .wrap{ width:min(1180px, 100%); margin:0 auto; padding:16px 16px; }
    .topRow{
      display:flex; align-items:center; justify-content:space-between;
      gap:14px;
    }
    .topLeft{
      display:flex; align-items:center; gap:12px;
      min-width: 240px;
    }
    .miniLogo{
      width:34px; height:34px; border-radius:12px;
      background: linear-gradient(135deg, rgba(45,125,255,1) 0%, rgba(90,160,255,1) 55%, rgba(255,255,255,.9) 130%);
      border:1px solid rgba(255,255,255,.12);
    }
    .appName{
      display:flex; flex-direction:column;
      line-height:1.1;
    }
    .appName strong{ font-size:15px; letter-spacing:.2px; }
    .appName span{ font-size:12px; color:var(--muted); }
    nav{
      display:flex; gap:8px; flex-wrap:wrap;
      justify-content:flex-end;
    }
    .tab{
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      color:var(--text);
      padding:9px 12px;
      border-radius:999px;
      cursor:pointer;
      font-weight:700;
      font-size:13px;
    }
    .tab.active{
      border-color: rgba(45,125,255,.55);
      background: rgba(45,125,255,.16);
      box-shadow: inset 0 0 0 1px rgba(45,125,255,.10);
    }

    main{ padding:18px 0 28px; }
    .grid{
      display:grid;
      grid-template-columns: 1.05fr .95fr;
      gap:14px;
    }
    @media (max-width:980px){ .grid{ grid-template-columns:1fr; } }
    .card{
      border:1px solid var(--line);
      border-radius: var(--radius);
      background: rgba(15,22,36,.55);
      backdrop-filter: blur(8px);
      box-shadow: var(--shadow);
      padding:14px;
    }
    .card h2{
      margin:0 0 10px 0;
      font-size:14px;
      letter-spacing:.2px;
      color:#dce6ff;
      display:flex; align-items:center; justify-content:space-between; gap:8px;
    }
    .hint{
      color:var(--muted);
      font-size:12px;
      line-height:1.5;
      margin:0 0 12px 0;
    }
    .row{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    @media (max-width:640px){ .row{ grid-template-columns:1fr; } }
    label{
      display:block;
      font-size:12px;
      color:#cfe0ff;
      margin-bottom:6px;
      font-weight:800;
      letter-spacing:.15px;
    }
    select, input{
      width:100%;
      padding:10px 11px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.22);
      color:var(--text);
      outline:none;
    }
    select:focus, input:focus{
      border-color: rgba(90,160,255,.75);
      box-shadow: 0 0 0 3px rgba(90,160,255,.16);
    }
    .mutedSmall{ color:var(--muted); font-size:12px; margin-top:6px; line-height:1.45; }
    .pill{
      display:inline-flex; align-items:center; gap:6px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.04);
      color:#dce6ff;
      font-size:12px;
      font-weight:800;
    }
    .actions{
      display:flex; gap:10px; flex-wrap:wrap;
      align-items:center; justify-content:flex-end;
      margin-top:10px;
    }
    .btnSmall{
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color:var(--text);
      padding:9px 12px;
      border-radius:14px;
      cursor:pointer;
      font-weight:800;
      font-size:13px;
    }
    .btnSmall.primary{
      border-color: rgba(45,125,255,.55);
      background: rgba(45,125,255,.18);
    }
    .btnSmall.danger{
      border-color: rgba(255,255,255,.16);
      background: rgba(255,80,80,.12);
    }

    .resultBox{
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      border-radius: 16px;
      padding:12px;
      min-height: 160px;
      white-space: pre-wrap;
      line-height: 1.55;
      font-size: 13px;
      color:#eaf0ff;
    }
    .subgrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    @media (max-width:860px){ .subgrid{ grid-template-columns:1fr; } }

    details{
      border:1px solid rgba(255,255,255,.10);
      border-radius: 16px;
      background: rgba(0,0,0,.18);
      padding:10px 12px;
    }
    details summary{
      cursor:pointer;
      font-weight:900;
      letter-spacing:.2px;
      color:#dce6ff;
      font-size:13px;
      list-style:none;
    }
    details summary::-webkit-details-marker{ display:none; }
    .sigList{
      margin:10px 0 0 0;
      padding:0;
      list-style:none;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:8px;
    }
    @media (max-width:720px){ .sigList{ grid-template-columns:1fr; } }
    .sigItem{
      display:flex; align-items:flex-start; gap:10px;
      border:1px solid rgba(255,255,255,.10);
      border-radius:14px;
      padding:10px;
      background: rgba(255,255,255,.03);
    }
    .sigItem input{ width:auto; margin-top:2px; }
    .sigItem span{
      color:var(--text);
      font-size:13px;
      line-height:1.35;
    }

    .imgGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }
    @media (max-width:980px){ .imgGrid{ grid-template-columns:1fr; } }
    .imgCard{
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      border-radius: 18px;
      padding:12px;
    }
    .imgCard h3{
      margin:0 0 8px 0;
      font-size:13px;
      color:#dce6ff;
    }
    .imgCard img{
      width:100%;
      height:auto;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.10);
      background:#000;
      display:block;
    }
    .imgNote{
      margin:8px 0 0 0;
      font-size:12px;
      color:var(--muted);
      line-height:1.5;
    }

    footer{
      border-top:1px solid var(--line);
      margin-top:20px;
      padding:14px 0 24px;
      color:var(--muted);
      font-size:12px;
      line-height:1.55;
    }
    .legal strong{ color:#dce6ff; }
  </style>
</head>

<body>
  <!-- Splash -->
  <div id="splash" aria-hidden="false">
    <div class="splashCard">
      <div class="brandRow">
        <div class="logo" aria-hidden="true"></div>
        <div class="brandTitle">
          <h1>SyncVent</h1>
          <p class="sub">Plataforma educacional — Ventilação mecânica no adulto (checklist + raciocínio clínico)</p>
        </div>
      </div>

      <div class="splashBody">
        <div class="splashBox">
          <h2>Uso e limites</h2>
          <p>
            Instrumento exclusivamente educacional para organizar raciocínio clínico e estudo.
            Não substitui julgamento profissional, protocolos locais ou decisões assistenciais.
          </p>
        </div>
        <div class="splashBox">
          <h2>Autoria e direitos</h2>
          <p>
            Conteúdo e estrutura protegidos. Uso não autorizado, reprodução ou exploração comercial são vedados.
          </p>
        </div>
      </div>

      <div class="btnRow">
        <button class="btn" type="button" id="btnSplashInfo">Termos</button>
        <button class="btn btnPrimary" type="button" id="btnEnter">Entrar</button>
      </div>
    </div>
  </div>

  <header>
    <div class="wrap">
      <div class="topRow">
        <div class="topLeft">
          <div class="miniLogo" aria-hidden="true"></div>
          <div class="appName">
            <strong>SyncVent</strong>
            <span>Adulto • Checklist compacto + análise expandida</span>
          </div>
        </div>

        <nav aria-label="Navegação principal">
          <button class="tab active" id="tabCompact" type="button">Checklist compacto</button>
          <button class="tab" id="tabExpanded" type="button">Análise expandida</button>
          <button class="tab" id="tabNormals" type="button">Curvas normais</button>
          <button class="tab" id="tabAbout" type="button">Sobre & Termos</button>
        </nav>
      </div>
    </div>
  </header>

  <main class="wrap">
    <!-- =================== Compact =================== -->
    <section id="secCompact">
      <div class="grid">
        <div class="card">
          <h2>
            Checklist compacto
            <span class="pill" id="pillAdultOnly">Adulto-only</span>
          </h2>
          <p class="hint">
            Preencha o contexto mínimo. A síntese compacta abre automaticamente os módulos da análise expandida quando elegíveis.
          </p>

          <div class="row">
            <div>
              <label>Adulto (≥ 18 anos)</label>
              <select id="adult_18_plus">
                <option value="sim">Sim</option>
                <option value="nao">Não</option>
              </select>
            </div>

            <div>
              <label>Tipo de suporte</label>
              <select id="support_type">
                <option value="invasivo">Invasivo (TET/Traqueostomia)</option>
                <option value="niv">NIV</option>
                <option value="hfno">HFNO</option>
                <option value="o2_conv">O₂ convencional</option>
              </select>
            </div>
          </div>

          <div class="card" style="margin-top:12px; padding:12px; background:rgba(0,0,0,.18);">
            <h2 style="margin-bottom:8px;">
              Painel ventilatório atual (dados)
              <span class="pill" id="pillVentPanel">contexto</span>
            </h2>

            <div class="row" id="panelInvasive">
              <div>
                <label>Modo ventilatório (invasivo)</label>
                <select id="vent_mode">
                  <option value="vc">VC</option>
                  <option value="pc">PC</option>
                  <option value="psv">PSV</option>
                  <option value="prvc">PRVC</option>
                  <option value="outro">Outro</option>
                </select>
              </div>
              <div>
                <label>FiO₂ (fração)</label>
                <input id="fio2" type="number" step="0.01" min="0.21" max="1" placeholder="Ex.: 0.40" />
              </div>
              <div>
                <label>PEEP (cmH₂O)</label>
                <input id="peep" type="number" step="1" min="0" max="30" placeholder="Ex.: 8" />
              </div>
              <div>
                <label>FR total (rpm)</label>
                <input id="rr_total" type="number" step="1" min="0" max="80" placeholder="Ex.: 22" />
              </div>
              <div>
                <label>VT exalado (mL)</label>
                <input id="vt_exhaled_ml" type="number" step="1" min="0" max="1200" placeholder="Ex.: 420" />
              </div>
              <div>
                <label>VM (L/min)</label>
                <input id="minute_vent_lmin" type="number" step="0.1" min="0" max="40" placeholder="Ex.: 9.2" />
              </div>
              <div>
                <label>Ppico (cmH₂O)</label>
                <input id="ppeak" type="number" step="1" min="0" max="80" placeholder="Ex.: 28" />
              </div>
              <div>
                <label>Pplat (cmH₂O)</label>
                <input id="pplat" type="number" step="1" min="0" max="80" placeholder="Ex.: 22" />
              </div>
            </div>

            <div class="row" id="panelNIV" style="display:none;">
              <div>
                <label>Interface (NIV)</label>
                <select id="niv_interface">
                  <option value="facial">Máscara facial</option>
                  <option value="total_face">Total face</option>
                  <option value="nasal">Nasal</option>
                  <option value="helmet">Helmet</option>
                  <option value="outra">Outra</option>
                </select>
              </div>
              <div>
                <label>FiO₂ (fração)</label>
                <input id="fio2_niv" type="number" step="0.01" min="0.21" max="1" placeholder="Ex.: 0.50" />
              </div>
              <div>
                <label>EPAP/CPAP (cmH₂O)</label>
                <input id="epap" type="number" step="1" min="0" max="30" placeholder="Ex.: 10" />
              </div>
              <div>
                <label>IPAP/PS (cmH₂O)</label>
                <input id="ipap" type="number" step="1" min="0" max="40" placeholder="Ex.: 18" />
              </div>
              <div>
                <label>FR total (rpm)</label>
                <input id="rr_total_niv" type="number" step="1" min="0" max="80" placeholder="Ex.: 28" />
              </div>
              <div>
                <label>VT (se disponível)</label>
                <input id="vt_niv" type="number" step="1" min="0" max="1200" placeholder="Ex.: 380" />
              </div>
            </div>

            <div class="row" id="panelHFNO" style="display:none;">
              <div>
                <label>Fluxo (L/min)</label>
                <input id="hfno_flow" type="number" step="1" min="0" max="80" placeholder="Ex.: 50" />
              </div>
              <div>
                <label>FiO₂ (fração)</label>
                <input id="fio2_hfno" type="number" step="0.01" min="0.21" max="1" placeholder="Ex.: 0.60" />
              </div>
              <div>
                <label>FR total (rpm)</label>
                <input id="rr_total_hfno" type="number" step="1" min="0" max="80" placeholder="Ex.: 30" />
              </div>
              <div style="display:none;"></div>
            </div>

            <div class="mutedSmall" id="dpInfo"></div>
          </div>

          <details style="margin-top:12px;" open>
            <summary>PBW + VT normalizado (ferramenta)</summary>
            <div class="row" style="margin-top:10px;">
              <div>
                <label>Sexo para PBW</label>
                <select id="pbw_sex">
                  <option value="nao_disponivel">Não disponível</option>
                  <option value="masculino">Masculino</option>
                  <option value="feminino">Feminino</option>
                </select>
                <div class="mutedSmall">PBW é estimado por altura/sexo para padronização (não é peso real).</div>
              </div>
              <div>
                <label>Altura (cm)</label>
                <input id="height_cm" type="number" step="0.1" min="120" max="220" placeholder="Ex.: 168" />
              </div>
              <div>
                <label>PBW calculado (kg)</label>
                <input id="pbw_kg" type="text" readonly />
              </div>
              <div>
                <label>VT (mL) para cálculo</label>
                <input id="vt_for_calc" type="number" step="1" min="0" max="1200" placeholder="Se invasivo, pode copiar do VT exalado" />
              </div>
              <div>
                <label>VT (mL/kg PBW)</label>
                <input id="vt_ml_per_kg" type="text" readonly />
              </div>
              <div>
                <label>Confiabilidade do VT</label>
                <select id="vt_reliability">
                  <option value="nao_disponivel">Não disponível</option>
                  <option value="alta">Alta</option>
                  <option value="media">Média</option>
                  <option value="baixa">Baixa</option>
                </select>
              </div>
            </div>
          </details>

          <details style="margin-top:12px;" open>
            <summary>Intubação / via aérea / tempo / imagem</summary>

            <div id="invOnlyBlocks" style="margin-top:10px;">
              <div class="row">
                <div>
                  <label>Causa principal da intubação</label>
                  <select id="intubation_cause">
                    <option value="hipoxemia">Hipoxemia / insuficiência respiratória hipoxêmica</option>
                    <option value="hipercapnia">Hipercapnia / insuficiência ventilatória</option>
                    <option value="protecao_via_aerea">Rebaixamento de consciência / proteção de via aérea</option>
                    <option value="choque">Choque / instabilidade hemodinâmica</option>
                    <option value="pcr">Parada cardiorrespiratória</option>
                    <option value="trauma">Trauma</option>
                    <option value="procedimento">Procedimento/cirurgia</option>
                    <option value="falha_niv_hfno">Falha de NIV/HFNO</option>
                    <option value="outra">Outra</option>
                  </select>
                </div>
                <div>
                  <label>Dispositivo</label>
                  <select id="airway_device">
                    <option value="tet">Tubo orotraqueal (TET)</option>
                    <option value="traqueostomia">Traqueostomia</option>
                  </select>
                </div>
              </div>

              <div class="row">
                <div>
                  <label>Tamanho do tubo (ID, mm) — máximo 9,0</label>
                  <input id="tube_id_mm" type="number" step="0.5" min="5" max="9" placeholder="Ex.: 7.5" />
                </div>
                <div>
                  <label>Fixação na rima (cm) — máximo 26</label>
                  <input id="tube_rima_cm" type="number" step="1" min="18" max="26" placeholder="Ex.: 23" />
                </div>
              </div>

              <div class="row">
                <div>
                  <label>Impacto mecânico relacionado à via aérea artificial</label>
                  <select id="airway_mechanical_impact">
                    <option value="nao">Não</option>
                    <option value="sim">Sim</option>
                    <option value="incerto">Incerto</option>
                  </select>
                </div>
                <div>
                  <label>Dias desde intubação</label>
                  <input id="days_since_intubation" type="number" step="1" min="0" max="365" placeholder="Ex.: 6" />
                </div>
                <div>
                  <label>Dias em ventilação mecânica invasiva</label>
                  <input id="days_on_invasive_mv" type="number" step="1" min="0" max="365" placeholder="Ex.: 6" />
                </div>
                <div>
                  <label>Extubação/reintubação nesta internação</label>
                  <select id="reintubation_this_stay">
                    <option value="nao">Não</option>
                    <option value="sim">Sim</option>
                    <option value="incerto">Incerto</option>
                  </select>
                </div>
              </div>
            </div>

            <div class="row" style="margin-top:10px;">
              <div>
                <label>Imagem disponível</label>
                <select id="imaging_type">
                  <option value="rx">Rx tórax</option>
                  <option value="tc">TC tórax</option>
                  <option value="us">US pulmonar</option>
                  <option value="nenhum">Nenhum</option>
                </select>
              </div>
              <div>
                <label>Data/hora da imagem (opcional)</label>
                <input id="imaging_datetime" type="datetime-local" />
              </div>
            </div>

            <div class="row" style="margin-top:10px;">
              <div>
                <label>Achados radiológicos (seleção múltipla)</label>
                <select id="imaging_findings" multiple size="6">
                  <option value="bilateral_difuso">Opacidades bilaterais difusas</option>
                  <option value="unilateral_predominante">Opacidades unilaterais predominantes</option>
                  <option value="consolidacao_focal">Consolidação focal</option>
                  <option value="atelectasia">Atelectasia</option>
                  <option value="derrame_pleural">Derrame pleural</option>
                  <option value="pneumotorax">Pneumotórax</option>
                  <option value="intersticial_reticular">Padrão intersticial/reticular</option>
                  <option value="hiperinsuflacao">Hiperinsuflação</option>
                  <option value="incerto">Incerto</option>
                </select>
                <div class="mutedSmall">No desktop: Ctrl+clique para múltiplos itens.</div>
              </div>
              <div>
                <label>Confiabilidade</label>
                <select id="imaging_reliability">
                  <option value="laudo">Laudo disponível</option>
                  <option value="descricao">Descrição clínica sem laudo</option>
                  <option value="incerta">Incerta</option>
                </select>

                <div style="margin-top:10px;">
                  <label>SARA compatível</label>
                  <select id="ards_compatible">
                    <option value="nao">Não</option>
                    <option value="sim">Sim</option>
                    <option value="incompleto">Incompleto</option>
                  </select>
                </div>

                <div style="margin-top:10px;">
                  <label>Sepse</label>
                  <select id="sepsis_status">
                    <option value="nao">Não</option>
                    <option value="provavel">Provável</option>
                    <option value="sim">Sim</option>
                  </select>
                </div>

                <div style="margin-top:10px;">
                  <label>Choque séptico provável</label>
                  <select id="septic_shock_probable">
                    <option value="nao">Não</option>
                    <option value="sim">Sim</option>
                    <option value="incerto">Incerto</option>
                  </select>
                </div>
              </div>
            </div>
          </details>

          <details style="margin-top:12px;" open>
            <summary>Fenótipos e moduladores (compacto)</summary>

            <div class="row" style="margin-top:10px;">
              <div>
                <label>Hipoxemia predominante</label>
                <select id="predominant_hypoxemia">
                  <option value="nao">Não</option>
                  <option value="sim">Sim</option>
                </select>
              </div>
              <div>
                <label>Hipercapnia predominante</label>
                <select id="predominant_hypercapnia">
                  <option value="nao">Não</option>
                  <option value="sim">Sim</option>
                </select>
              </div>
              <div>
                <label>Falha por bomba (suspeita)</label>
                <select id="pump_failure_suspected">
                  <option value="nao">Não</option>
                  <option value="sim">Sim</option>
                  <option value="incerto">Incerto</option>
                </select>
              </div>
              <div>
                <label>Padrão obstrutivo (suspeita)</label>
                <select id="obstructive_pattern_suspected">
                  <option value="nao">Não</option>
                  <option value="sim">Sim</option>
                  <option value="incerto">Incerto</option>
                </select>
              </div>
              <div>
                <label>Padrão restritivo (suspeita)</label>
                <select id="restrictive_pattern_suspected">
                  <option value="nao">Não</option>
                  <option value="sim">Sim</option>
                  <option value="incerto">Incerto</option>
                </select>
              </div>
              <div>
                <label>Aumento de resistência (suspeita)</label>
                <select id="increased_resistance_suspected">
                  <option value="nao">Não</option>
                  <option value="sim">Sim</option>
                  <option value="incerto">Incerto</option>
                </select>
              </div>
              <div>
                <label>Alto esforço (suspeita)</label>
                <select id="high_effort_suspected">
                  <option value="nao">Não</option>
                  <option value="sim">Sim</option>
                  <option value="incerto">Incerto</option>
                </select>
              </div>
              <div>
                <label>Assincronia relevante (suspeita)</label>
                <select id="major_asynchrony_suspected">
                  <option value="nao">Não</option>
                  <option value="sim">Sim</option>
                  <option value="incerto">Incerto</option>
                </select>
              </div>
              <div>
                <label>Neurocrítico</label>
                <select id="neuro_critical">
                  <option value="nao">Não</option>
                  <option value="sim">Sim</option>
                </select>
              </div>
              <div>
                <label>Doença neuromuscular</label>
                <select id="neuromuscular_disease">
                  <option value="nao">Não</option>
                  <option value="sim">Sim</option>
                </select>
              </div>
              <div>
                <label>DPOC conhecida</label>
                <select id="known_copd">
                  <option value="nao">Não</option>
                  <option value="sim">Sim</option>
                </select>
              </div>
              <div>
                <label>Restritiva conhecida/suspeita</label>
                <select id="known_or_suspected_restrictive_dz">
                  <option value="nao">Não</option>
                  <option value="sim">Sim</option>
                  <option value="incerto">Incerto</option>
                </select>
              </div>
              <div>
                <label>Trauma recente</label>
                <select id="recent_trauma">
                  <option value="nao">Não</option>
                  <option value="sim">Sim</option>
                </select>
              </div>
              <div>
                <label>Doença unilateral grave</label>
                <select id="severe_unilateral_lung_disease">
                  <option value="nao">Não</option>
                  <option value="sim">Sim</option>
                </select>
              </div>
              <div>
                <label>Obesidade relevante</label>
                <select id="obesity_relevant">
                  <option value="nao">Não</option>
                  <option value="sim">Sim</option>
                </select>
              </div>
              <div>
                <label>Insuficiência cardíaca coexistente</label>
                <select id="heart_failure_coexisting">
                  <option value="nao">Não</option>
                  <option value="sim">Sim</option>
                  <option value="incerto">Incerto</option>
                </select>
              </div>
            </div>
          </details>

          <div class="actions">
            <button class="btnSmall danger" type="button" id="btnReset">Limpar</button>
            <button class="btnSmall" type="button" id="btnSave">Salvar</button>
            <button class="btnSmall primary" type="button" id="btnRunCompact">Gerar síntese compacta</button>
          </div>
        </div>

        <div class="card">
          <h2>
            Síntese compacta (gerada)
            <span class="pill" id="pillConfidence">confiança</span>
          </h2>
          <p class="hint">
            Saída educacional baseada nos dados preenchidos. A análise expandida detalha justificativas por sinais observáveis.
          </p>
          <div class="resultBox" id="compactResult"></div>

          <div class="actions" style="justify-content:flex-start; margin-top:12px;">
            <button class="btnSmall primary" type="button" id="btnGoExpanded">Abrir análise expandida</button>
          </div>
        </div>
      </div>
    </section>

    <!-- =================== Expanded =================== -->
    <section id="secExpanded" style="display:none;">
      <div class="grid">
        <div class="card">
          <h2>
            Análise expandida (módulos elegíveis)
            <span class="pill" id="pillModules">módulos</span>
          </h2>
          <p class="hint">
            Selecione sinais observáveis. Cada módulo exige pelo menos 1 sinal marcado para gerar inferências educacionais.
          </p>

          <div class="subgrid" id="modulesContainer"></div>

          <div class="actions">
            <button class="btnSmall" type="button" id="btnRunExpanded">Gerar justificativa expandida</button>
          </div>
        </div>

        <div class="card">
          <h2>
            Justificativa expandida (gerada)
            <span class="pill" id="pillExpandedConfidence">confiança</span>
          </h2>
          <p class="hint">
            O texto abaixo descreve quais sinais sustentam inferências e como isso impacta a confiança, sem orientar ajuste.
          </p>
          <div class="resultBox" id="expandedResult"></div>
        </div>
      </div>
    </section>

    <!-- =================== Normal Curves =================== -->
    <section id="secNormals" style="display:none;">
      <div class="card">
        <h2>Curvas normais – PCV e VCV</h2>
        <p class="hint">
          Referências visuais educacionais. Para funcionar, os arquivos PNG devem estar no repositório com os nomes abaixo.
        </p>

        <div class="imgGrid">
          <div class="imgCard">
            <h3>PCV – curvas normais</h3>
            <img src="pcv_normal.png" alt="Curvas normais PCV" />
            <p class="imgNote">Arquivo esperado: <strong>pcv_normal.png</strong> (na raiz do repositório).</p>
          </div>

          <div class="imgCard">
            <h3>VCV – curvas normais</h3>
            <img src="vcv_normal.png" alt="Curvas normais VCV" />
            <p class="imgNote">Arquivo esperado: <strong>vcv_normal.png</strong> (na raiz do repositório).</p>
          </div>
        </div>
      </div>
    </section>

    <!-- =================== About/Terms =================== -->
    <section id="secAbout" style="display:none;">
      <div class="card">
        <h2>Sobre & Termos</h2>
        <p class="hint">
          SyncVent é uma plataforma educacional destinada a adultos, focada em checklist e raciocínio clínico em ventilação mecânica.
        </p>

        <div class="card" style="background:rgba(0,0,0,.18); box-shadow:none;">
          <h2>Uso educacional</h2>
          <p class="hint" style="margin:0;">
            Este software não fornece prescrição, ajuste ventilatório ou decisão terapêutica. Não substitui protocolos locais, avaliação
            multiprofissional e julgamento clínico. O conteúdo é apresentado para estudo e treinamento.
          </p>
        </div>

        <div class="card" style="margin-top:12px; background:rgba(0,0,0,.18); box-shadow:none;">
          <h2>Direitos autorais e restrições</h2>
          <p class="hint" style="margin:0;">
            © 2026 Leticia Moreira. Todos os direitos reservados. É proibida a reprodução total ou parcial, distribuição, adaptação,
            engenharia reversa, disponibilização pública, ou qualquer uso comercial do conteúdo, estrutura, textos, lógica e interface
            do SyncVent sem autorização expressa e por escrito da autora.
          </p>
        </div>
      </div>
    </section>

    <footer>
      <div class="legal">
        <strong>SyncVent</strong> — © 2026 <strong>Leticia Moreira</strong>. Todos os direitos reservados.<br/>
        Uso educacional. Não constitui orientação clínica. Proibida reprodução e uso comercial sem autorização expressa.
      </div>
    </footer>
  </main>

  <script>
    "use strict";

    /* ======== Basic deterrents (UI) ======== */
    document.addEventListener("contextmenu", (e) => e.preventDefault());
    document.addEventListener("dragstart", (e) => e.preventDefault());

    /* ======== Tabs ======== */
    const tabCompact  = document.getElementById("tabCompact");
    const tabExpanded = document.getElementById("tabExpanded");
    const tabNormals  = document.getElementById("tabNormals");
    const tabAbout    = document.getElementById("tabAbout");

    const secCompact  = document.getElementById("secCompact");
    const secExpanded = document.getElementById("secExpanded");
    const secNormals  = document.getElementById("secNormals");
    const secAbout    = document.getElementById("secAbout");

    function setTab(which){
      const tabs = [
        {btn:tabCompact, sec:secCompact, key:"compact"},
        {btn:tabExpanded, sec:secExpanded, key:"expanded"},
        {btn:tabNormals, sec:secNormals, key:"normals"},
        {btn:tabAbout, sec:secAbout, key:"about"}
      ];
      tabs.forEach(t=>{
        const on = (t.key===which);
        t.btn.classList.toggle("active", on);
        t.sec.style.display = on ? "block" : "none";
      });
      window.scrollTo({top:0, behavior:"smooth"});
    }
    tabCompact.onclick  = () => setTab("compact");
    tabExpanded.onclick = () => setTab("expanded");
    tabNormals.onclick  = () => setTab("normals");
    tabAbout.onclick    = () => setTab("about");

    /* ======== Splash ======== */
    const splash = document.getElementById("splash");
    document.getElementById("btnEnter").onclick = () => {
      splash.style.display = "none";
      splash.setAttribute("aria-hidden","true");
    };
    document.getElementById("btnSplashInfo").onclick = () => {
      splash.style.display = "none";
      splash.setAttribute("aria-hidden","true");
      setTab("about");
    };

    /* ======== Elements ======== */
    const E = (id)=>document.getElementById(id);

    const adult_18_plus = E("adult_18_plus");
    const support_type = E("support_type");

    const panelInvasive = E("panelInvasive");
    const panelNIV = E("panelNIV");
    const panelHFNO = E("panelHFNO");
    const invOnlyBlocks = E("invOnlyBlocks");

    const vent_mode = E("vent_mode");
    const fio2 = E("fio2");
    const peep = E("peep");
    const rr_total = E("rr_total");
    const vt_exhaled_ml = E("vt_exhaled_ml");
    const minute_vent_lmin = E("minute_vent_lmin");
    const ppeak = E("ppeak");
    const pplat = E("pplat");

    const pbw_sex = E("pbw_sex");
    const height_cm = E("height_cm");
    const pbw_kg = E("pbw_kg");
    const vt_for_calc = E("vt_for_calc");
    const vt_ml_per_kg = E("vt_ml_per_kg");
    const vt_reliability = E("vt_reliability");

    const intubation_cause = E("intubation_cause");
    const airway_device = E("airway_device");
    const tube_id_mm = E("tube_id_mm");
    const tube_rima_cm = E("tube_rima_cm");
    const airway_mechanical_impact = E("airway_mechanical_impact");
    const days_since_intubation = E("days_since_intubation");
    const days_on_invasive_mv = E("days_on_invasive_mv");
    const reintubation_this_stay = E("reintubation_this_stay");

    const imaging_type = E("imaging_type");
    const imaging_datetime = E("imaging_datetime");
    const imaging_findings = E("imaging_findings");
    const imaging_reliability = E("imaging_reliability");

    const ards_compatible = E("ards_compatible");
    const sepsis_status = E("sepsis_status");
    const septic_shock_probable = E("septic_shock_probable");

    const predominant_hypoxemia = E("predominant_hypoxemia");
    const predominant_hypercapnia = E("predominant_hypercapnia");
    const pump_failure_suspected = E("pump_failure_suspected");
    const obstructive_pattern_suspected = E("obstructive_pattern_suspected");
    const restrictive_pattern_suspected = E("restrictive_pattern_suspected");
    const increased_resistance_suspected = E("increased_resistance_suspected");
    const high_effort_suspected = E("high_effort_suspected");
    const major_asynchrony_suspected = E("major_asynchrony_suspected");

    const neuro_critical = E("neuro_critical");
    const neuromuscular_disease = E("neuromuscular_disease");
    const known_copd = E("known_copd");
    const known_or_suspected_restrictive_dz = E("known_or_suspected_restrictive_dz");
    const recent_trauma = E("recent_trauma");
    const severe_unilateral_lung_disease = E("severe_unilateral_lung_disease");
    const obesity_relevant = E("obesity_relevant");
    const heart_failure_coexisting = E("heart_failure_coexisting");

    const dpInfo = E("dpInfo");
    const compactResult = E("compactResult");
    const expandedResult = E("expandedResult");
    const modulesContainer = E("modulesContainer");

    const pillConfidence = E("pillConfidence");
    const pillExpandedConfidence = E("pillExpandedConfidence");
    const pillModules = E("pillModules");

    /* ======== Storage ======== */
    const LS_KEY = "syncvent_v1_state";

    function getSelectedMulti(selectEl){
      return Array.from(selectEl.selectedOptions).map(o=>o.value);
    }
    function setSelectedMulti(selectEl, values){
      const set = new Set(values || []);
      Array.from(selectEl.options).forEach(opt=>{ opt.selected = set.has(opt.value); });
    }

    function getState(){
      const st = {
        adult_18_plus: adult_18_plus.value,
        support_type: support_type.value,

        vent_mode: vent_mode.value,
        fio2: fio2.value,
        peep: peep.value,
        rr_total: rr_total.value,
        vt_exhaled_ml: vt_exhaled_ml.value,
        minute_vent_lmin: minute_vent_lmin.value,
        ppeak: ppeak.value,
        pplat: pplat.value,

        pbw_sex: pbw_sex.value,
        height_cm: height_cm.value,
        vt_for_calc: vt_for_calc.value,
        vt_reliability: vt_reliability.value,

        intubation_cause: intubation_cause.value,
        airway_device: airway_device.value,
        tube_id_mm: tube_id_mm.value,
        tube_rima_cm: tube_rima_cm.value,
        airway_mechanical_impact: airway_mechanical_impact.value,
        days_since_intubation: days_since_intubation.value,
        days_on_invasive_mv: days_on_invasive_mv.value,
        reintubation_this_stay: reintubation_this_stay.value,

        imaging_type: imaging_type.value,
        imaging_datetime: imaging_datetime.value,
        imaging_findings: getSelectedMulti(imaging_findings),
        imaging_reliability: imaging_reliability.value,

        ards_compatible: ards_compatible.value,
        sepsis_status: sepsis_status.value,
        septic_shock_probable: septic_shock_probable.value,

        predominant_hypoxemia: predominant_hypoxemia.value,
        predominant_hypercapnia: predominant_hypercapnia.value,
        pump_failure_suspected: pump_failure_suspected.value,
        obstructive_pattern_suspected: obstructive_pattern_suspected.value,
        restrictive_pattern_suspected: restrictive_pattern_suspected.value,
        increased_resistance_suspected: increased_resistance_suspected.value,
        high_effort_suspected: high_effort_suspected.value,
        major_asynchrony_suspected: major_asynchrony_suspected.value,

        neuro_critical: neuro_critical.value,
        neuromuscular_disease: neuromuscular_disease.value,
        known_copd: known_copd.value,
        known_or_suspected_restrictive_dz: known_or_suspected_restrictive_dz.value,
        recent_trauma: recent_trauma.value,
        severe_unilateral_lung_disease: severe_unilateral_lung_disease.value,
        obesity_relevant: obesity_relevant.value,
        heart_failure_coexisting: heart_failure_coexisting.value
      };
      return st;
    }

    function setState(st){
      if(!st) return;

      adult_18_plus.value = st.adult_18_plus ?? "sim";
      support_type.value = st.support_type ?? "invasivo";

      vent_mode.value = st.vent_mode ?? "vc";
      fio2.value = st.fio2 ?? "";
      peep.value = st.peep ?? "";
      rr_total.value = st.rr_total ?? "";
      vt_exhaled_ml.value = st.vt_exhaled_ml ?? "";
      minute_vent_lmin.value = st.minute_vent_lmin ?? "";
      ppeak.value = st.ppeak ?? "";
      pplat.value = st.pplat ?? "";

      pbw_sex.value = st.pbw_sex ?? "nao_disponivel";
      height_cm.value = st.height_cm ?? "";
      vt_for_calc.value = st.vt_for_calc ?? "";
      vt_reliability.value = st.vt_reliability ?? "nao_disponivel";

      intubation_cause.value = st.intubation_cause ?? "hipoxemia";
      airway_device.value = st.airway_device ?? "tet";
      tube_id_mm.value = st.tube_id_mm ?? "";
      tube_rima_cm.value = st.tube_rima_cm ?? "";
      airway_mechanical_impact.value = st.airway_mechanical_impact ?? "nao";
      days_since_intubation.value = st.days_since_intubation ?? "";
      days_on_invasive_mv.value = st.days_on_invasive_mv ?? "";
      reintubation_this_stay.value = st.reintubation_this_stay ?? "nao";

      imaging_type.value = st.imaging_type ?? "rx";
      imaging_datetime.value = st.imaging_datetime ?? "";
      setSelectedMulti(imaging_findings, st.imaging_findings ?? []);
      imaging_reliability.value = st.imaging_reliability ?? "laudo";

      ards_compatible.value = st.ards_compatible ?? "nao";
      sepsis_status.value = st.sepsis_status ?? "nao";
      septic_shock_probable.value = st.septic_shock_probable ?? "nao";

      predominant_hypoxemia.value = st.predominant_hypoxemia ?? "nao";
      predominant_hypercapnia.value = st.predominant_hypercapnia ?? "nao";
      pump_failure_suspected.value = st.pump_failure_suspected ?? "nao";
      obstructive_pattern_suspected.value = st.obstructive_pattern_suspected ?? "nao";
      restrictive_pattern_suspected.value = st.restrictive_pattern_suspected ?? "nao";
      increased_resistance_suspected.value = st.increased_resistance_suspected ?? "nao";
      high_effort_suspected.value = st.high_effort_suspected ?? "nao";
      major_asynchrony_suspected.value = st.major_asynchrony_suspected ?? "nao";

      neuro_critical.value = st.neuro_critical ?? "nao";
      neuromuscular_disease.value = st.neuromuscular_disease ?? "nao";
      known_copd.value = st.known_copd ?? "nao";
      known_or_suspected_restrictive_dz.value = st.known_or_suspected_restrictive_dz ?? "nao";
      recent_trauma.value = st.recent_trauma ?? "nao";
      severe_unilateral_lung_disease.value = st.severe_unilateral_lung_disease ?? "nao";
      obesity_relevant.value = st.obesity_relevant ?? "nao";
      heart_failure_coexisting.value = st.heart_failure_coexisting ?? "nao";

      refreshUI();
      computePBW();
      computeDP();
      autoVTForCalc();
      computeVTperPBW();
    }

    function saveState(){
      localStorage.setItem(LS_KEY, JSON.stringify(getState()));
    }

    function resetState(){
      localStorage.removeItem(LS_KEY);
      location.reload();
    }

    /* ======== UI logic ======== */
    function refreshUI(){
      const st = getState();

      const inv = (st.support_type === "invasivo");
      panelInvasive.style.display = inv ? "grid" : "none";
      invOnlyBlocks.style.display = inv ? "block" : "none";

      panelNIV.style.display  = (st.support_type === "niv") ? "grid" : "none";
      panelHFNO.style.display = (st.support_type === "hfno") ? "grid" : "none";

      // Tube fields only relevant for TET
      const isTET = inv && (st.airway_device === "tet");
      tube_id_mm.disabled = !isTET;
      tube_rima_cm.disabled = !isTET;

      // Imaging blocks
      const imgNone = (st.imaging_type === "nenhum");
      imaging_datetime.disabled = imgNone;
      imaging_findings.disabled = imgNone;
      imaging_reliability.disabled = imgNone;

      // Adult-only gate
      if(st.adult_18_plus !== "sim"){
        compactResult.textContent = "Instrumento aplicável apenas a pacientes adultos (≥ 18 anos).";
        modulesContainer.innerHTML = "";
        expandedResult.textContent = "";
        pillConfidence.textContent = "bloqueado";
        pillExpandedConfidence.textContent = "bloqueado";
      }
    }

    /* ======== Calculations ======== */
    function computePBW(){
      const sex = pbw_sex.value;
      const h = parseFloat(height_cm.value);
      if(!(sex==="masculino" || sex==="feminino") || !isFinite(h)){
        pbw_kg.value = "";
        return null;
      }
      const base = (sex==="masculino") ? 50 : 45.5;
      const pbw = base + 0.91 * (h - 152.4);
      const pbwFixed = Math.round(pbw * 10) / 10;
      pbw_kg.value = String(pbwFixed);
      return pbwFixed;
    }

    function computeDP(){
      const pplatV = parseFloat(pplat.value);
      const peepV  = parseFloat(peep.value);
      if(isFinite(pplatV) && isFinite(peepV)){
        const dp = pplatV - peepV;
        dpInfo.textContent = `ΔP (Pplat - PEEP): ${dp.toFixed(1)} cmH₂O (cálculo educacional).`;
        return dp;
      }
      dpInfo.textContent = "";
      return null;
    }

    function autoVTForCalc(){
      // If VT exalado exists, prefill calc VT unless user already typed a different value
      const vtex = parseFloat(vt_exhaled_ml.value);
      const vtc  = parseFloat(vt_for_calc.value);
      if(isFinite(vtex) && !isFinite(vtc)){
        vt_for_calc.value = String(Math.round(vtex));
      }
    }

    function computeVTperPBW(){
      const pbw = computePBW();
      const vt = parseFloat(vt_for_calc.value);
      if(isFinite(pbw) && isFinite(vt) && pbw > 0){
        const val = vt / pbw;
        vt_ml_per_kg.value = val.toFixed(2);
        return val;
      }
      vt_ml_per_kg.value = "";
      return null;
    }

    /* ======== Expanded modules (core set) ======== */
    const MODULES = [
      {
        id:"M_OXYGENATION_MECHANISMS",
        title:"Oxigenação – mecanismos (educacional)",
        eligibility: (st)=> ["invasivo","niv","hfno"].includes(st.support_type) && st.predominant_hypoxemia==="sim",
        signals: [
          {id:"spo2_variability", label:"Oscilações frequentes de SpO₂"},
          {id:"desaturation_events", label:"Dessaturações recorrentes"},
          {id:"positional_effect", label:"Efeito posicional sugerido"},
          {id:"secretion_relation", label:"Relação com secreção/aspiração sugerida"},
          {id:"heterogeneity_suspected", label:"Heterogeneidade/colapso sugeridos (conceito)"}
        ],
        inferText: (sel)=> {
          const lines = [];
          if(sel.size===0) return "";
          lines.push("Leitura educacional: instabilidade de oxigenação pode refletir heterogeneidade/colapso, shunt, V/Q desigual ou fatores transitórios.");
          lines.push("Pendências típicas: coerência com imagem, tendência de oxigenação e eventos associados.");
          return lines.join("\n");
        }
      },
      {
        id:"M_CO2_VENTILATION",
        title:"Ventilação – CO₂ (educacional)",
        eligibility: (st)=> st.predominant_hypercapnia==="sim" || st.intubation_cause==="hipercapnia",
        signals: [
          {id:"rising_co2_trend", label:"Tendência de CO₂ em elevação (se disponível)"},
          {id:"sudden_co2_change", label:"Mudança abrupta recente de CO₂ (se disponível)"},
          {id:"effort_related_co2", label:"Relação entre esforço e CO₂ sugerida"},
          {id:"dead_space_suspected", label:"Espaço morto aumentado sugerido (conceito)"},
          {id:"hypoventilation_suspected", label:"Hipoventilação sugerida (conceito)"}
        ],
        inferText: (sel)=> {
          if(sel.size===0) return "";
          return [
            "Leitura educacional: hipercapnia pode decorrer de hipoventilação, aumento de espaço morto ou interação paciente–ventilador.",
            "Pendências típicas: tendência temporal, coerência com mecânica/curvas e contexto clínico."
          ].join("\n");
        }
      },
      {
        id:"M_ARDS_CONFIRMATION",
        title:"SARA – confirmação e fenótipo (adulto)",
        eligibility: (st)=> (st.ards_compatible==="sim" || st.ards_compatible==="incompleto") && st.imaging_type!=="nenhum",
        signals: [
          {id:"onset_within_7d", label:"Início ≤ 7 dias (confirmado)"},
          {id:"bilateral_opacities", label:"Opacidades bilaterais em imagem"},
          {id:"non_cardiogenic_dominant", label:"Edema cardiogênico não dominante (descrição/eco)"},
          {id:"pf_ratio_known", label:"PaO₂/FiO₂ conhecido (se disponível)"},
          {id:"peep_cpap_ge5", label:"PEEP/CPAP ≥ 5 (se aplicável)"}
        ],
        inferText: (sel)=> {
          if(sel.size===0) return "";
          const hit = ["onset_within_7d","bilateral_opacities","non_cardiogenic_dominant"].filter(x=>sel.has(x)).length;
          const conf = hit>=2 ? "média/alta" : "baixa/média";
          return [
            "Leitura educacional: sinais selecionados sustentam maior completude de critérios de SARA em adulto.",
            `Coerência de critérios: ${conf}.`,
            "Pendências típicas: exclusão de cardiogênico, dados objetivos de oxigenação e tendência temporal."
          ].join("\n");
        }
      },
      {
        id:"M_SEPSIS_CONFIRMATION",
        title:"Sepse – confirmação (Sepsis-3, adulto)",
        eligibility: (st)=> st.sepsis_status==="sim" || st.sepsis_status==="provavel" || st.septic_shock_probable==="sim",
        signals: [
          {id:"infection_suspected", label:"Infecção suspeita/confirmada"},
          {id:"organ_dysfunction", label:"Disfunção orgânica presente (descrição)"},
          {id:"sofa_delta_ge2", label:"ΔSOFA ≥ 2 (confirmado)"},
          {id:"vasopressor", label:"Necessidade de vasopressor (descrição)"},
          {id:"lactate_high", label:"Lactato elevado (se disponível)"}
        ],
        inferText: (sel)=> {
          if(sel.size===0) return "";
          const shockLikely = sel.has("vasopressor") && sel.has("lactate_high");
          return [
            "Leitura educacional: sepse/choque são definidos por infecção com disfunção orgânica (e, no choque, anormalidade circulatória/metabólica).",
            shockLikely ? "Sinais selecionados aumentam a probabilidade educacional de choque séptico." : "Sinais selecionados sustentam sepse/sepse provável, conforme completude do SOFA e dados metabólicos.",
            "Pendências típicas: rastreabilidade por sistemas e tendência de perfusão."
          ].join("\n");
        }
      },
      {
        id:"M_AIRWAY_ARTIFICIAL_MECHANICS",
        title:"Via aérea artificial – impacto na mecânica (educacional)",
        eligibility: (st)=> st.support_type==="invasivo" && (st.airway_mechanical_impact==="sim" || st.airway_mechanical_impact==="incerto" || st.increased_resistance_suspected!=="nao" || st.predominant_hypercapnia==="sim"),
        signals: [
          {id:"sudden_mechanics_worse", label:"Piora súbita de mecânica sem explicação pulmonar clara"},
          {id:"hypercapnia_disproportionate", label:"Hipercapnia desproporcional ao quadro radiológico (conceito)"},
          {id:"secretion_plug", label:"Secreção/rolha suspeita (descrição)"},
          {id:"post_manipulation", label:"Mudança temporal após manipulação do tubo (descrição)"},
          {id:"tube_depth_extreme", label:"Fixação na rima em valores extremos (dentro do intervalo)"}
        ],
        inferText: (sel)=> {
          if(sel.size===0) return "";
          return [
            "Leitura educacional: um fator relacionado à via aérea artificial pode contribuir para aumento de resistência/carga ventilatória.",
            "Pendências típicas: coerência com imagem, ausculta e tendência das curvas (sem orientar intervenção)."
          ].join("\n");
        }
      },
      {
        id:"M_VT_PBW_NORMALIZATION",
        title:"Normalização por PBW – VT (mL/kg) (educacional)",
        eligibility: (st)=> st.support_type==="invasivo" && st.vt_reliability!=="nao_disponivel" && !!computeVTperPBW(),
        signals: [
          {id:"pbw_inputs_reliable", label:"Altura e sexo confiáveis para PBW"},
          {id:"vt_reliable", label:"VT disponível com confiabilidade alta/média"},
          {id:"ards_context", label:"SARA sim/incompleto (relevância aumentada)"},
          {id:"high_effort_context", label:"Alto esforço/drive suspeito (contexto)"}
        ],
        inferText: (sel)=> {
          if(sel.size===0) return "";
          const val = computeVTperPBW();
          const pbw = computePBW();
          const band = (val<6) ? "faixa baixa" : (val<=8) ? "faixa intermediária" : "faixa alta";
          return [
            `VT/PBW calculado: ${val.toFixed(2)} mL/kg (PBW=${pbw?.toFixed(1) ?? "?"} kg) — ${band} (classificação interna, não prescritiva).`,
            "Leitura educacional: VT normalizado por PBW é um descritor usado para discutir proteção pulmonar em diretrizes, especialmente em SARA.",
            "Pendências típicas: qualidade da medida de VT e confirmação da altura."
          ].join("\n");
        }
      },
      {
        id:"M_OBSTRUCTION_FLOW_TIME",
        title:"Obstrução – fluxo×tempo / tempo expiratório (educacional)",
        eligibility: (st)=> st.obstructive_pattern_suspected!=="nao" || st.known_copd==="sim" || st.imaging_findings.includes("hiperinsuflacao"),
        signals: [
          {id:"exp_flow_not_zero", label:"Fluxo expiratório não zera"},
          {id:"long_exp_tail", label:"Cauda expiratória prolongada"},
          {id:"volume_stacking", label:"Empilhamento em volume×tempo"},
          {id:"cycle_trapping", label:"Aprisionamento sugerido por repetição ciclo a ciclo"}
        ],
        inferText: (sel)=> {
          if(sel.size===0) return "";
          const dyn = sel.has("exp_flow_not_zero") && sel.has("volume_stacking");
          return [
            "Leitura educacional: sinais selecionados sustentam fisiologia obstrutiva/limitação ao fluxo.",
            dyn ? "Combinação de sinais sugere hiperinsuflação dinâmica provável (educacional)." : "Risco de expiração incompleta/aprisionamento deve ser considerado como hipótese educacional.",
            "Pendências típicas: coerência com imagem, história de DPOC e tendência de CO₂."
          ].join("\n");
        }
      },
      {
        id:"M_RESTRICTION_PV_LOOP",
        title:"Restrição – pressão×tempo / loop P–V (educacional)",
        eligibility: (st)=> st.restrictive_pattern_suspected!=="nao" || st.known_or_suspected_restrictive_dz!=="nao" || st.imaging_findings.includes("intersticial_reticular"),
        signals: [
          {id:"small_vt_large_pressure", label:"Pequeno VT para grande variação de pressão (conceito)"},
          {id:"narrow_pv_loop", label:"Loop P–V estreito"},
          {id:"reduced_hysteresis", label:"Histerese reduzida"},
          {id:"no_obstructive_dominant", label:"Ausência de padrão obstrutivo predominante"}
        ],
        inferText: (sel)=> {
          if(sel.size===0) return "";
          const lowComp = sel.has("narrow_pv_loop") || sel.has("small_vt_large_pressure");
          return [
            "Leitura educacional: sinais selecionados sustentam fenótipo restritivo/baixa complacência como hipótese.",
            lowComp ? "Baixa complacência provável (educacional)." : "Restrição provável com necessidade de confirmação por coerência clínica e imagem.",
            "Pendências típicas: padrão intersticial, gravidade de hipoxemia e tendência temporal."
          ].join("\n");
        }
      },
      {
        id:"M_EFFORT_DRIVE",
        title:"Esforço/Drive – curvas (educacional)",
        eligibility: (st)=> st.high_effort_suspected!=="nao" || st.intubation_cause==="falha_niv_hfno",
        signals: [
          {id:"pressure_notches", label:"Entalhes/deflexões sugerindo esforço"},
          {id:"pressure_oscillation", label:"Oscilações de pressão durante o ciclo"},
          {id:"double_trigger", label:"Dupla ativação/empilhamento sugeridos"},
          {id:"irregular_timing", label:"Irregularidade consistente do timing do ciclo"}
        ],
        inferText: (sel)=> {
          if(sel.size===0) return "";
          return [
            "Leitura educacional: sinais selecionados sugerem esforço/drive elevado e/ou interação paciente–ventilador subótima.",
            "Pendências típicas: verificar coerência com assincronia, oxigenação e CO₂."
          ].join("\n");
        }
      },
      {
        id:"M_ASYNCHRONY_PATTERNS",
        title:"Assincronia – padrões (educacional)",
        eligibility: (st)=> st.major_asynchrony_suspected!=="nao",
        signals: [
          {id:"trigger_issue", label:"Padrão de disparo alterado (conceito)"},
          {id:"flow_mismatch", label:"Mismatch de fluxo (conceito)"},
          {id:"cycling_issue", label:"Ciclagem precoce/tardia (conceito)"},
          {id:"expiratory_issue", label:"Expiração incompleta (conceito)"}
        ],
        inferText: (sel)=> {
          if(sel.size===0) return "";
          return [
            "Leitura educacional: padrões de assincronia podem explicar desconforto, esforço elevado e instabilidade ventilatória.",
            "Pendências típicas: identificar padrão dominante e coerência com mecânica/tempo expiratório."
          ].join("\n");
        }
      },
      {
        id:"M_NEURO_VENT_CONFLICTS",
        title:"Neuro – conflitos ventilatórios (educacional)",
        eligibility: (st)=> st.neuro_critical==="sim" || st.intubation_cause==="protecao_via_aerea",
        signals: [
          {id:"co2_instability", label:"Oscilações relevantes de CO₂ (se disponível)"},
          {id:"hypervent_episodes", label:"Episódios de hiperventilação (descrição)"},
          {id:"cough_effort_bursts", label:"Tosse/esforço em rajadas (descrição)"},
          {id:"oxygenation_swings", label:"Instabilidade de oxigenação relevante"}
        ],
        inferText: (sel)=> {
          if(sel.size===0) return "";
          return [
            "Leitura educacional: em neurocríticos, variabilidade ventilatória (especialmente de CO₂) pode ser clinicamente relevante.",
            "Pendências típicas: estabilidade de ventilação, coerência com sedação/conforto (sem prescrever)."
          ].join("\n");
        }
      }
    ];

    function getEligibleModules(st){
      return MODULES.filter(m=>m.eligibility(st));
    }

    function buildModulesUI(){
      const st = getState();
      modulesContainer.innerHTML = "";
      if(st.adult_18_plus !== "sim"){
        pillModules.textContent = "bloqueado";
        return;
      }

      const eligible = getEligibleModules(st);
      pillModules.textContent = `${eligible.length} módulos`;

      eligible.forEach(mod=>{
        const box = document.createElement("div");
        box.className = "card";
        box.style.background = "rgba(0,0,0,.18)";
        box.style.boxShadow = "none";

        const title = document.createElement("h2");
        title.textContent = mod.title;

        const det = document.createElement("details");
        det.open = true;

        const sum = document.createElement("summary");
        sum.textContent = "Sinais observáveis (clique para marcar)";
        det.appendChild(sum);

        const ul = document.createElement("ul");
        ul.className = "sigList";

        mod.signals.forEach(sig=>{
          const li = document.createElement("li");
          li.className = "sigItem";

          const cb = document.createElement("input");
          cb.type = "checkbox";
          cb.id = `sig_${mod.id}_${sig.id}`;

          const sp = document.createElement("span");
          sp.textContent = sig.label;

          li.appendChild(cb);
          li.appendChild(sp);
          ul.appendChild(li);
        });

        det.appendChild(ul);
        box.appendChild(title);
        box.appendChild(det);

        modulesContainer.appendChild(box);
      });
    }

    function selectedSignalsForModule(mod){
      const sel = new Set();
      mod.signals.forEach(sig=>{
        const id = `sig_${mod.id}_${sig.id}`;
        const cb = document.getElementById(id);
        if(cb && cb.checked) sel.add(sig.id);
      });
      return sel;
    }

    /* ======== Compact synthesis ======== */
    function summarizeCompact(){
      const st = getState();
      refreshUI();

      if(st.adult_18_plus !== "sim"){
        pillConfidence.textContent = "bloqueado";
        compactResult.textContent = "Instrumento aplicável apenas a pacientes adultos (≥ 18 anos).";
        return;
      }

      // Basic validation: tube constraints
      if(st.support_type==="invasivo" && st.airway_device==="tet"){
        const tid = parseFloat(st.tube_id_mm);
        const rima = parseFloat(st.tube_rima_cm);
        if(isFinite(tid) && tid > 9.0){
          compactResult.textContent = "Erro: tamanho do tubo acima do máximo permitido (9,0).";
          pillConfidence.textContent = "dados inválidos";
          return;
        }
        if(isFinite(rima) && rima > 26){
          compactResult.textContent = "Erro: fixação na rima acima do máximo permitido (26 cm).";
          pillConfidence.textContent = "dados inválidos";
          return;
        }
      }

      const img = st.imaging_findings || [];
      const priorities = [];
      const risks = [];

      // Scenario line
      const parts = [];
      if(st.support_type==="invasivo"){
        parts.push("Suporte: invasivo");
        parts.push(`Causa intubação: ${labelIntubCause(st.intubation_cause)}`);
      } else {
        parts.push(`Suporte: ${st.support_type}`);
      }

      // Classifications
      let cls = [];
      if(st.ards_compatible==="sim") cls.push("SARA: compatível");
      if(st.ards_compatible==="incompleto") cls.push("SARA: incompleto");
      if(st.sepsis_status==="sim") cls.push("Sepse: sim");
      if(st.sepsis_status==="provavel") cls.push("Sepse: provável");
      if(st.septic_shock_probable==="sim") cls.push("Choque séptico: provável");

      // Imaging cues
      if(img.includes("bilateral_difuso")) risks.push("Hipoxemia/heterogeneidade (imagem bilateral).");
      if(img.includes("pneumotorax")) risks.push("Pneumotórax em imagem (relevante para coerência ventilatória).");
      if(img.includes("hiperinsuflacao")) risks.push("Hiperinsuflação em imagem (fenótipo obstrutivo como hipótese).");
      if(img.includes("intersticial_reticular")) risks.push("Padrão intersticial/reticular (restrição/ILD como hipótese).");

      // Phenotypes
      if(st.predominant_hypoxemia==="sim") priorities.push("Prioridade: rastrear mecanismos de hipoxemia e coerência com imagem (educacional).");
      if(st.predominant_hypercapnia==="sim") priorities.push("Prioridade: rastrear mecanismos de hipercapnia (hipoventilação vs espaço morto vs interação).");

      if(st.obstructive_pattern_suspected!=="nao" || st.known_copd==="sim"){
        priorities.push("Prioridade: avaliar sinais de obstrução/tempo expiratório e risco de expiração incompleta (educacional).");
      }
      if(st.restrictive_pattern_suspected!=="nao" || st.known_or_suspected_restrictive_dz!=="nao"){
        priorities.push("Prioridade: avaliar sinais compatíveis com restrição/baixa complacência e coerência com imagem (educacional).");
      }
      if(st.high_effort_suspected!=="nao" || st.major_asynchrony_suspected!=="nao"){
        priorities.push("Prioridade: caracterizar esforço/assincronia por sinais observáveis e impacto em estabilidade ventilatória (educacional).");
      }
      if(st.neuro_critical==="sim"){
        priorities.push("Prioridade: estabilidade ventilatória/CO₂ em cenário neurocrítico (educacional).");
      }
      if(st.support_type==="invasivo" && (st.airway_mechanical_impact!=="nao" || st.increased_resistance_suspected!=="nao")){
        priorities.push("Prioridade: considerar contribuição da via aérea artificial para resistência/carga ventilatória (educacional).");
      }

      // PBW/VT note (educational)
      const vtVal = computeVTperPBW();
      if(st.support_type==="invasivo" && vtVal && st.vt_reliability!=="nao_disponivel"){
        priorities.push("Prioridade: descrever VT normalizado por PBW como auditoria de coerência em cenários de risco pulmonar (educacional).");
      }

      // Confidence (heuristic)
      let conf = "média";
      const missingCore = (
        st.support_type!=="o2_conv" &&
        (!st.fio2 || (st.support_type==="invasivo" && !st.peep))
      );
      if(st.imaging_type==="nenhum" && st.ards_compatible!=="nao") conf = "baixa";
      if(missingCore) conf = "baixa";
      if(st.imaging_type!=="nenhum" && (st.ards_compatible==="sim" || st.sepsis_status==="sim")) conf = "média/alta";

      pillConfidence.textContent = conf;

      const out = [];
      out.push("SYNCVENT — SÍNTESE COMPACTA (educacional)");
      out.push("----------------------------------------");
      out.push(parts.join(" | "));
      if(cls.length) out.push("Classificações: " + cls.join(" • "));
      if(st.support_type==="invasivo"){
        out.push(`Via aérea: ${labelAirway(st.airway_device)}${(st.airway_device==="tet" ? ` | TET ${st.tube_id_mm || "?"} | rima ${st.tube_rima_cm || "?"} cm` : "")}`);
        if(st.days_on_invasive_mv) out.push(`Tempo: ${st.days_on_invasive_mv} dias em VM invasiva`);
      }
      if(st.imaging_type!=="nenhum"){
        out.push(`Imagem: ${st.imaging_type.toUpperCase()} | achados: ${img.length ? img.map(labelImg).join(", ") : "não informados"} | confiabilidade: ${st.imaging_reliability}`);
      } else {
        out.push("Imagem: não disponível");
      }

      out.push("");
      out.push("Top prioridades (metas):");
      const p = priorities.length ? priorities : ["Prioridade: completar dados mínimos para aumentar confiança (imagem/oxigenação/tempo)."];
      p.slice(0,5).forEach((x,i)=> out.push(`${i+1}. ${x}`));

      out.push("");
      out.push("Riscos e pontos de atenção (educacional):");
      const r = risks.length ? risks : ["Sem riscos adicionais inferidos a partir da imagem; depende dos módulos expandidos."];
      r.slice(0,6).forEach((x,i)=> out.push(`- ${x}`));

      out.push("");
      out.push("Pendências críticas típicas:");
      const pend = [];
      if(st.support_type!=="o2_conv" && !st.fio2) pend.push("FiO₂ não informada.");
      if(st.support_type==="invasivo" && !st.peep) pend.push("PEEP não informada.");
      if(st.ards_compatible!=="nao" && st.imaging_type==="nenhum") pend.push("Imagem ausente para coerência em SARA.");
      if(st.sepsis_status!=="nao") pend.push("Detalhamento por sistemas (SOFA) não documentado na compacta.");
      if(pend.length===0) pend.push("Sem pendências críticas obrigatórias detectadas na compacta.");
      pend.forEach(x=> out.push(`- ${x}`));

      compactResult.textContent = out.join("\n");

      // build modules based on state
      buildModulesUI();
    }

    function labelIntubCause(v){
      const map = {
        hipoxemia:"Hipoxemia",
        hipercapnia:"Hipercapnia",
        protecao_via_aerea:"Proteção de via aérea",
        choque:"Choque",
        pcr:"PCR",
        trauma:"Trauma",
        procedimento:"Procedimento",
        falha_niv_hfno:"Falha NIV/HFNO",
        outra:"Outra"
      };
      return map[v] || v;
    }
    function labelAirway(v){
      return v==="tet" ? "TET" : (v==="traqueostomia" ? "Traqueostomia" : v);
    }
    function labelImg(v){
      const map = {
        bilateral_difuso:"bilateral difuso",
        unilateral_predominante:"unilateral",
        consolidacao_focal:"consolidação focal",
        atelectasia:"atelectasia",
        derrame_pleural:"derrame pleural",
        pneumotorax:"pneumotórax",
        intersticial_reticular:"intersticial/reticular",
        hiperinsuflacao:"hiperinsuflação",
        incerto:"incerto"
      };
      return map[v] || v;
    }

    /* ======== Expanded synthesis ======== */
    function summarizeExpanded(){
      const st = getState();
      if(st.adult_18_plus !== "sim"){
        pillExpandedConfidence.textContent = "bloqueado";
        expandedResult.textContent = "Instrumento aplicável apenas a pacientes adultos (≥ 18 anos).";
        return;
      }

      const eligible = getEligibleModules(st);
      let lines = [];
      lines.push("SYNCVENT — JUSTIFICATIVA EXPANDIDA (educacional)");
      lines.push("------------------------------------------------");
      let any = false;
      let missingSignals = 0;

      eligible.forEach(mod=>{
        const sel = selectedSignalsForModule(mod);
        if(sel.size===0){
          missingSignals += 1;
          return;
        }
        any = true;
        lines.push("");
        lines.push(`• ${mod.title}`);
        lines.push(`Sinais selecionados: ${Array.from(sel).map(id=> mod.signals.find(s=>s.id===id)?.label || id).join("; ")}`);
        const txt = mod.inferText(sel);
        if(txt) lines.push(txt);
      });

      if(!any){
        lines.push("");
        lines.push("Nenhum módulo gerou justificativa (selecione ao menos 1 sinal observável em um módulo elegível).");
      }

      let conf = "média";
      if(missingSignals > 0 && any) conf = "média";
      if(!any) conf = "baixa";
      if(any && missingSignals===0) conf = "média/alta";
      pillExpandedConfidence.textContent = conf;

      expandedResult.textContent = lines.join("\n");
    }

    /* ======== Buttons ======== */
    E("btnRunCompact").onclick = ()=>{ computePBW(); computeDP(); autoVTForCalc(); computeVTperPBW(); summarizeCompact(); };
    E("btnRunExpanded").onclick = ()=> summarizeExpanded();

    E("btnGoExpanded").onclick = ()=>{ setTab("expanded"); buildModulesUI(); };
    E("btnSave").onclick = ()=> saveState();
    E("btnReset").onclick = ()=> resetState();

    /* ======== Events ======== */
    support_type.addEventListener("change", ()=>{
      refreshUI();
      autoVTForCalc();
      computePBW();
      computeVTperPBW();
      buildModulesUI();
    });
    airway_device.addEventListener("change", refreshUI);

    [pbw_sex, height_cm, vt_for_calc, vt_exhaled_ml].forEach(el=>{
      el.addEventListener("input", ()=>{
        computePBW();
        autoVTForCalc();
        computeVTperPBW();
      });
      el.addEventListener("change", ()=>{
        computePBW();
        autoVTForCalc();
        computeVTperPBW();
      });
    });
    [pplat, peep].forEach(el=>{
      el.addEventListener("input", computeDP);
      el.addEventListener("change", computeDP);
    });

    // Save on changes
    document.addEventListener("change", ()=>{
      refreshUI();
      saveState();
    });

    /* ======== Init ======== */
    (function init(){
      const saved = localStorage.getItem(LS_KEY);
      if(saved){
        try{ setState(JSON.parse(saved)); } catch(e){ /* ignore */ }
      } else {
        refreshUI();
        computePBW();
        computeDP();
        autoVTForCalc();
        computeVTperPBW();
      }
      summarizeCompact();
      buildModulesUI();
    })();
  </script>
</body>
</html>
