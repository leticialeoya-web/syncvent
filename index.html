<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SyncVent — Ventilação Mecânica (educacional)</title>

  <style>
    :root{
      --bg:#f6f8ff;
      --panel:#ffffff;
      --panel2:#f2f5ff;
      --text:#0b1220;
      --muted:#41516b;
      --line:#d9e2f3;
      --chip:#eef3ff;
      --blue:#2563eb;
      --blue2:#1d4ed8;
      --shadow: 0 18px 45px rgba(18,36,80,.12);
      --radius:16px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }

    html,body{ height:100%; }
    body{
      margin:0;
      font-family: var(--sans);
      background: var(--bg);
      color: var(--text);
    }

    /* Splash */
    #splash{
      position: fixed;
      inset: 0;
      background:
        radial-gradient(800px 500px at 20% 10%, rgba(37,99,235,.20), transparent 60%),
        radial-gradient(900px 600px at 85% 20%, rgba(37,99,235,.12), transparent 55%),
        var(--bg);
      display:flex;
      align-items:center;
      justify-content:center;
      z-index:9999;
      transition: opacity .35s ease;
    }
    #splash.hide{ opacity:0; pointer-events:none; }

    .splashCard{
      width:min(900px, 92vw);
      border:1px solid var(--line);
      border-radius: calc(var(--radius) + 10px);
      background: linear-gradient(180deg, rgba(37,99,235,.06), rgba(255,255,255,.78));
      box-shadow: var(--shadow);
      padding: 26px 22px;
    }
    .splashTop{
      display:flex; gap:16px; align-items:center; justify-content:space-between; flex-wrap:wrap;
    }
    .brand{ display:flex; gap:12px; align-items:center; }
    .logo{
      width:42px; height:42px; border-radius:12px;
      background: linear-gradient(135deg, var(--blue), rgba(37,99,235,.35));
      box-shadow: 0 10px 22px rgba(37,99,235,.18);
    }
    .brand h1{ margin:0; font-size:22px; letter-spacing:.2px; }
    .brand .tag{ margin-top:2px; color: var(--muted); font-size:13px; }

    .btn{
      border:1px solid var(--line);
      background: var(--panel);
      color: var(--text);
      border-radius: 12px;
      padding: 10px 12px;
      font-weight: 900;
      cursor:pointer;
      transition: transform .05s ease, background .15s ease, border .15s ease;
      user-select:none;
    }
    .btn:hover{ border-color: rgba(37,99,235,.55); }
    .btn:active{ transform: translateY(1px); }
    .btn.primary{
      background: linear-gradient(135deg, var(--blue), var(--blue2));
      border-color: rgba(37,99,235,.65);
      color:#fff;
    }

    .splashBody{
      margin-top:14px;
      border-top:1px solid var(--line);
      padding-top:14px;
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap:16px;
    }
    .splashBody p{ margin:0; color: var(--muted); line-height:1.5; font-size:14px; }
    .pillRow{ display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end; align-items:flex-start; }
    .pill{
      background: rgba(37,99,235,.10);
      border:1px solid rgba(37,99,235,.28);
      color: var(--text);
      font-size:12px;
      padding: 6px 10px;
      border-radius: 999px;
      font-weight: 900;
      white-space: nowrap;
    }
    .pill.neutral{
      background: var(--chip);
      border-color: var(--line);
      color: var(--muted);
      font-weight: 900;
    }
    @media (max-width: 860px){
      .splashBody{ grid-template-columns: 1fr; }
      .pillRow{ justify-content:flex-start; }
    }

    /* Header */
    header{
      position: sticky;
      top:0;
      z-index: 50;
      backdrop-filter: blur(10px);
      background: color-mix(in srgb, var(--bg) 75%, transparent);
      border-bottom: 1px solid var(--line);
    }
    .wrap{ width:min(1180px, 94vw); margin: 0 auto; }
    .topbar{
      display:flex; align-items:center; justify-content:space-between;
      padding: 10px 0;
      gap: 12px;
      flex-wrap:wrap;
    }
    .leftTop{ display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
    .miniLogo{
      width:28px; height:28px; border-radius:10px;
      background: linear-gradient(135deg, var(--blue), rgba(37,99,235,.25));
      box-shadow: 0 8px 18px rgba(37,99,235,.14);
    }
    .titleBlock{ display:flex; flex-direction:column; line-height:1.1; }
    .titleBlock b{ font-size: 14px; letter-spacing:.2px;}
    .titleBlock span{ font-size: 12px; color: var(--muted); margin-top:3px;}

    nav{ display:flex; gap: 8px; flex-wrap:wrap; align-items:center; }
    .tab{
      border:1px solid var(--line);
      background: var(--panel);
      color: var(--text);
      border-radius: 999px;
      padding: 8px 12px;
      font-weight: 1000;
      cursor:pointer;
      font-size: 13px;
    }
    .tab.active{
      background: rgba(37,99,235,.10);
      border-color: rgba(37,99,235,.40);
    }
    .tab.casos{
      padding: 10px 16px;
      font-size: 14px;
    }

    main{ padding: 16px 0 28px; }

    .grid2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px;
    }
    @media (max-width: 980px){
      .grid2{ grid-template-columns: 1fr; }
    }

    .card{
      border:1px solid var(--line);
      background: var(--panel);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 14px;
    }
    .card h2{ margin:0; font-size: 16px; letter-spacing:.2px; }
    .sub{ margin:6px 0 0; color: var(--muted); font-size: 13px; line-height:1.4; }
    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .hr{ height:1px; background: var(--line); margin:12px 0; }

    label{
      display:block;
      font-weight: 1000;
      font-size: 12px;
      color: var(--muted);
      margin-bottom:6px;
      letter-spacing:.2px;
      text-transform: uppercase;
    }
    input, select, textarea{
      width:100%;
      box-sizing:border-box;
      border-radius: 12px;
      border:1px solid var(--line);
      background: var(--panel2);
      color: var(--text);
      padding: 10px 10px;
      outline: none;
      font-weight: 900;
      font-size: 14px;
    }
    textarea{ min-height: 90px; resize: vertical; font-family: var(--sans); }
    .small{ font-size: 12px; color: var(--muted); margin-top:6px; line-height:1.4; }

    .chip{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid var(--line);
      background: var(--chip);
      color: var(--muted);
      font-weight: 1000;
      font-size: 12px;
    }
    .chip b{ color: var(--text); }

    details{
      border:1px solid var(--line);
      background: var(--panel2);
      border-radius: 14px;
      padding: 10px 12px;
    }
    summary{ cursor:pointer; font-weight: 1000; list-style:none; }
    summary::-webkit-details-marker{ display:none; }
    .klist{
      margin:10px 0 0;
      padding:0 0 0 18px;
      color: var(--muted);
      line-height:1.5;
      font-size: 13px;
    }
    .klist li{ margin: 6px 0; }
    .klist b{ color: var(--text); }

    a{ color: var(--text); text-decoration: none; border-bottom: 1px dashed rgba(37,99,235,.45); }
    a:hover{ border-bottom-color: rgba(37,99,235,.85); }

    .footer{
      margin-top: 14px;
      border-top: 1px solid var(--line);
      padding-top: 12px;
      color: var(--muted);
      font-size: 12px;
      line-height:1.45;
    }

    .mono{ font-family: var(--mono); }
    .hide{ display:none !important; }

    .checks{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    @media (max-width: 780px){
      .checks{ grid-template-columns: 1fr; }
    }
    .checkGroup{
      border:1px solid var(--line);
      background: var(--panel2);
      border-radius: 14px;
      padding: 10px 12px;
    }
    .checkGroup h3{ margin:0 0 8px; font-size: 13px; letter-spacing:.2px; }
    .opt{
      display:flex;
      gap:10px;
      align-items:flex-start;
      padding: 6px 0;
      border-top: 1px dashed color-mix(in srgb, var(--line) 70%, transparent);
    }
    .opt:first-of-type{ border-top: none; }
    .opt input{ width:auto; margin-top: 3px; }
    .opt div{ flex:1; }
    .opt b{ display:block; font-size: 13px; }
    .opt span{ display:block; color: var(--muted); font-size: 12px; line-height:1.35; margin-top:2px; }

    .outBox{
      border:1px solid var(--line);
      background: color-mix(in srgb, var(--panel2) 80%, transparent);
      border-radius: 14px;
      padding: 10px 12px;
    }
    .outBox h3{ margin:0 0 8px; font-size: 13px; }
    .outBox .txt{
      color: var(--muted);
      font-size: 13px;
      line-height:1.5;
      white-space:pre-wrap;
    }

    .note{
      border-left: 4px solid rgba(37,99,235,.55);
      padding: 10px 12px;
      border-radius: 12px;
      background: rgba(37,99,235,.07);
      color: var(--muted);
      font-size: 13px;
      line-height:1.45;
    }
    .note b{ color: var(--text); }

    /* Tabela simples */
    table{ width:100%; border-collapse: collapse; }
    th,td{ border-bottom:1px solid var(--line); padding:8px 10px; text-align:left; font-size:13px; }
    th{ color: var(--muted); text-transform:uppercase; font-size:12px; letter-spacing:.2px; }
    tr:last-child td{ border-bottom:none; }
    .tableWrap{ border:1px solid var(--line); background: var(--panel2); border-radius: 14px; overflow:hidden; }
  </style>
</head>

<body>

  <!-- SPLASH -->
  <div id="splash">
    <div class="splashCard">
      <div class="splashTop">
        <div class="brand">
          <div class="logo"></div>
          <div>
            <h1>SyncVent</h1>
            <div class="tag">Ventilação Mecânica — app educacional (não-prescritor)</div>
          </div>
        </div>
        <div class="splashBtns">
          <button class="btn primary" onclick="enterApp()">Entrar</button>
        </div>
      </div>

      <div class="splashBody">
        <p>
          Ferramenta educacional para organizar raciocínio por cenários clínicos e por leitura de curvas.
          Não substitui protocolos institucionais nem julgamento clínico.
        </p>
        <div class="pillRow">
          <span class="pill">Casos com definições + cálculos</span>
          <span class="pill">Assincronias (compacto → expandido)</span>
          <span class="pill">Mecânica (compacto → expandido)</span>
          <span class="pill neutral">Evidências por caso</span>
        </div>
      </div>
    </div>
  </div>

  <!-- HEADER -->
  <header>
    <div class="wrap">
      <div class="topbar">
        <div class="leftTop">
          <div class="miniLogo"></div>
          <div class="titleBlock">
            <b>SyncVent</b>
            <span>Compacto primeiro. Expandido só depois da análise.</span>
          </div>
        </div>

        <nav>
          <button class="tab casos active" id="tabCasos" onclick="showTab('casos')">Casos</button>
          <button class="tab" id="tabAssin" onclick="showTab('assin')">Assincronias</button>
          <button class="tab" id="tabMec" onclick="showTab('mec')">Mecânica</button>
          <button class="tab" id="tabRefs" onclick="showTab('refs')">Evidências</button>
          <button class="tab" id="tabSobre" onclick="showTab('sobre')">Sobre</button>
        </nav>
      </div>
    </div>
  </header>

  <main class="wrap">

    <!-- ===================== CASOS ===================== -->
    <section id="secCasos">
      <div class="card">
        <h2>Casos clínicos</h2>
        <p class="sub">
          Definições + pontos de atenção + calculadoras (quando aplicável). Sem prescrição.
        </p>

        <div class="hr"></div>

        <div class="row">
          <div style="flex:1; min-width:260px;">
            <label>Selecione o caso</label>
            <select id="caseSel" onchange="renderCase()">
              <option value="">Selecione…</option>
              <option value="sara">SARA (ARDS)</option>
              <option value="sepse">Sepse / Choque séptico</option>
              <option value="dpoc">DPOC (obstrutivo)</option>
              <option value="restritiva">Doença restritiva</option>
              <option value="cardiaca">Cardíaca (edema cardiogênico)</option>
              <option value="obeso">Obeso / OHS</option>
              <option value="neuro">Neuromuscular</option>
              <option value="neurocrit">Neurocrítico (TCE, tumor, etc.)</option>
              <option value="trauma">Trauma</option>
            </select>
          </div>
        </div>

        <div class="hr"></div>

        <div id="caseArea"></div>

        <div class="footer">
          Uso educacional. Não emite conduta, ajuste ou prescrição. Decisão clínica é da equipe assistente.
        </div>
      </div>
    </section>

    <!-- ===================== ASSINCRONIAS ===================== -->
    <section id="secAssin" class="hide">
      <div class="card">
        <h2>Assincronias — selecione o que você vê</h2>
        <p class="sub">
          O resultado compacto aparece após “Rodar análise”. O botão “expandido” só aparece depois disso.
        </p>

        <div class="hr"></div>

        <div class="row">
          <div style="flex:1; min-width:240px;">
            <label>Contexto (opcional)</label>
            <select id="assinContext">
              <option value="">Sem contexto</option>
              <option value="control">Controlado / mandatória</option>
              <option value="assist">Assistido (A/C, PSV, etc.)</option>
              <option value="wean">Desmame</option>
              <option value="obstruct">Obstrutivo (DPOC/asma)</option>
              <option value="lowC">Baixa complacência (SARA/restritiva)</option>
            </select>
          </div>
          <div style="flex:1; min-width:240px;">
            <label>Ação</label>
            <div class="row">
              <button class="btn primary" onclick="runAssinMotor()">Rodar análise</button>
              <button class="btn" onclick="resetChecks('assin')">Limpar</button>
            </div>
          </div>
        </div>

        <div class="hr"></div>

        <div class="checks">
          <div class="checkGroup">
            <h3>Pressão × tempo — disparo / início</h3>

            <div class="opt">
              <input type="checkbox" class="assin" value="pt_trigger_delay" />
              <div>
                <b>Antes do ciclo iniciar, aparece “esforço” e o ventilador demora a responder</b>
                <span>Atraso de disparo / dificuldade de trigger (interpretar no contexto).</span>
              </div>
            </div>

            <div class="opt">
              <input type="checkbox" class="assin" value="pt_negative_deflection" />
              <div>
                <b>Queda negativa marcada no início (o paciente “puxa” para disparar)</b>
                <span>Carga para disparar (limiar/auto-PEEP/drive alto).</span>
              </div>
            </div>

            <div class="opt">
              <input type="checkbox" class="assin" value="pt_double_trigger" />
              <div>
                <b>Dois ciclos quase colados, com pouco ou nenhum tempo expiratório</b>
                <span>Confirmar em fluxo e volume (empilhamento).</span>
              </div>
            </div>
          </div>

          <div class="checkGroup">
            <h3>Fluxo × tempo — inspiração / término</h3>

            <div class="opt">
              <input type="checkbox" class="assin" value="ft_flow_starvation" />
              <div>
                <b>Durante a inspiração, a curva sugere demanda maior que a entrega (concavidade)</b>
                <span>Demanda &gt; entrega (modo-dependente).</span>
              </div>
            </div>

            <div class="opt">
              <input type="checkbox" class="assin" value="ft_early_cycle" />
              <div>
                <b>A inspiração termina enquanto ainda há esforço inspiratório do paciente</b>
                <span>Esforço persiste após ciclar (término precoce).</span>
              </div>
            </div>

            <div class="opt">
              <input type="checkbox" class="assin" value="ft_late_cycle" />
              <div>
                <b>A inspiração se mantém quando o paciente já parece querer expirar</b>
                <span>Desconforto no fim da inspiração (término tardio).</span>
              </div>
            </div>
          </div>

          <div class="checkGroup">
            <h3>Fluxo × tempo — expiração</h3>

            <div class="opt">
              <input type="checkbox" class="assin" value="ft_exp_incomplete" />
              <div>
                <b>O fluxo expiratório não retorna a zero antes do próximo ciclo</b>
                <span>Expiração incompleta / air-trapping / auto-PEEP.</span>
              </div>
            </div>

            <div class="opt">
              <input type="checkbox" class="assin" value="ft_ineffective_effort" />
              <div>
                <b>Deflexões sugerem esforço em expiração, mas não ocorre disparo (ciclo não inicia)</b>
                <span>Esforço sem disparo (frequente com auto-PEEP + fraqueza).</span>
              </div>
            </div>

            <div class="opt">
              <input type="checkbox" class="assin" value="ft_auto_trigger" />
              <div>
                <b>O ventilador dispara ciclos sem padrão claro de esforço do paciente</b>
                <span>Auto-disparo/artefato (vazamento, condensado, sensibilidade).</span>
              </div>
            </div>
          </div>

          <div class="checkGroup">
            <h3>Volume × tempo</h3>

            <div class="opt">
              <input type="checkbox" class="assin" value="vt_breath_stacking" />
              <div>
                <b>O volume não retorna ao baseline antes de novo ciclo (empilhamento)</b>
                <span>Confirmar com ciclos colados e/ou expiração incompleta.</span>
              </div>
            </div>

            <div class="opt">
              <input type="checkbox" class="assin" value="vt_leak_suspicion" />
              <div>
                <b>Volume expirado muito menor que o inspirado (discrepância persistente)</b>
                <span>Vazamento/medição inconsistente (confirmar por alarmes/inspeção).</span>
              </div>
            </div>
          </div>
        </div>

        <div class="hr"></div>

        <div class="outBox">
          <h3>Resultado – Assincronias (compacto)</h3>
          <div class="txt" id="assinOut">Selecione os achados e clique em “Rodar análise”.</div>

          <button id="btnAssinExpand"
                  class="btn"
                  style="margin-top:10px; display:none;"
                  onclick="toggleAssinExpand()">
            Ver explicação fisiológica expandida
          </button>

          <div id="assinExpand" style="display:none; margin-top:10px;">
            <div class="note">
              <b>Explicação expandida (educacional)</b><br><br>
              <div id="assinExpandText"></div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- ===================== MECÂNICA ===================== -->
    <section id="secMec" class="hide">
      <div class="card">
        <h2>Mecânica — selecione o que você vê</h2>
        <p class="sub">
          O resultado compacto aparece após “Rodar análise”. O botão “expandido” só aparece depois disso.
        </p>

        <div class="hr"></div>

        <div class="row">
          <div style="flex:1; min-width:240px;">
            <label>Contexto (opcional)</label>
            <select id="mecContext">
              <option value="">Sem contexto</option>
              <option value="lowC">Baixa complacência (SARA/restritiva)</option>
              <option value="highR">Alta resistência (DPOC/asma)</option>
              <option value="wean">Desmame / esforço</option>
              <option value="obeso">Obesidade / parede torácica</option>
            </select>
          </div>
          <div style="flex:1; min-width:240px;">
            <label>Ação</label>
            <div class="row">
              <button class="btn primary" onclick="runMecMotor()">Rodar análise</button>
              <button class="btn" onclick="resetChecks('mec')">Limpar</button>
            </div>
          </div>
        </div>

        <div class="hr"></div>

        <div class="checks">
          <div class="checkGroup">
            <h3>Pressão × tempo</h3>

            <div class="opt">
              <input type="checkbox" class="mec" value="pt_high_plateau" />
              <div>
                <b>Pressão sustentada alta no final da inspiração / platô elevado (se medido)</b>
                <span>Baixa complacência do sistema (pulmão/parede).</span>
              </div>
            </div>

            <div class="opt">
              <input type="checkbox" class="mec" value="pt_high_peak_normal_plateau" />
              <div>
                <b>Pico desproporcional no início (maior que o final/platô, se disponível)</b>
                <span>Componente resistivo (via aérea/tubo/circuito).</span>
              </div>
            </div>

            <div class="opt">
              <input type="checkbox" class="mec" value="pt_sawtooth" />
              <div>
                <b>Serrilhado/oscilações (“dente de serra”) em pressão</b>
                <span>Secreção/condensado/turbulência/artefato.</span>
              </div>
            </div>
          </div>

          <div class="checkGroup">
            <h3>Fluxo × tempo</h3>

            <div class="opt">
              <input type="checkbox" class="mec" value="ft_exp_not_zero" />
              <div>
                <b>Fluxo expiratório não zera antes do próximo ciclo</b>
                <span>Expiração incompleta / auto-PEEP / obstrução / FR alta.</span>
              </div>
            </div>

            <div class="opt">
              <input type="checkbox" class="mec" value="ft_insp_decel_steep" />
              <div>
                <b>Fluxo inspiratório “cai rápido” durante a inspiração (modo-dependente)</b>
                <span>Pode sugerir baixa complacência dependendo do modo.</span>
              </div>
            </div>

            <div class="opt">
              <input type="checkbox" class="mec" value="ft_insp_decel_slow" />
              <div>
                <b>Fluxo inspiratório “cai lentamente” (modo-dependente)</b>
                <span>Pode sugerir resistência aumentada/constante de tempo alta.</span>
              </div>
            </div>
          </div>

          <div class="checkGroup">
            <h3>Volume × tempo</h3>

            <div class="opt">
              <input type="checkbox" class="mec" value="vt_slow_fill" />
              <div>
                <b>Subida do volume lenta/prolongada (enchimento lento)</b>
                <span>Resistência/limitação de fluxo/configuração do modo.</span>
              </div>
            </div>

            <div class="opt">
              <input type="checkbox" class="mec" value="vt_incomplete_empty" />
              <div>
                <b>Volume não retorna ao baseline antes do próximo ciclo</b>
                <span>Air-trapping/auto-PEEP/expiração curta.</span>
              </div>
            </div>

            <div class="opt">
              <input type="checkbox" class="mec" value="vt_leak" />
              <div>
                <b>Discrepância persistente entre volume inspirado e expirado</b>
                <span>Vazamento/medição inconsistente.</span>
              </div>
            </div>
          </div>

          <div class="checkGroup">
            <h3>Integração</h3>

            <div class="opt">
              <input type="checkbox" class="mec" value="met_asynchrony_suspect" />
              <div>
                <b>O padrão sugere assincronia coexistente</b>
                <span>Usar módulo “Assincronias”.</span>
              </div>
            </div>
          </div>
        </div>

        <div class="hr"></div>

        <div class="outBox">
          <h3>Resultado – Mecânica (compacto)</h3>
          <div class="txt" id="mecOut">Selecione os achados e clique em “Rodar análise”.</div>

          <button id="btnMecExpand"
                  class="btn"
                  style="margin-top:10px; display:none;"
                  onclick="toggleMecExpand()">
            Ver análise mecânica expandida
          </button>

          <div id="mecExpand" style="display:none; margin-top:10px;">
            <div class="note">
              <b>Análise expandida (educacional)</b><br><br>
              <div id="mecExpandText"></div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- ===================== EVIDÊNCIAS ===================== -->
    <section id="secRefs" class="hide">
      <div class="card">
        <h2>Evidências por caso (links)</h2>
        <p class="sub">
          Links organizados por cenário. Você pode substituir/expandir depois.
        </p>

        <div class="hr"></div>

        <details open>
          <summary>SARA (ARDS)</summary>
          <ul class="klist">
            <li><b>AMIB/SBPT 2024 — Orientações Práticas em VM</b>: <a target="_blank" href="https://d1xe7tfg0uwul9.cloudfront.net/amib-portal/wp-content/uploads/2024/09/12100249/Orientacoes-Praticas-de-Ventilacao-Mecanica-Interativo-SET-11-1.pdf">PDF</a></li>
            <li><b>ESICM ARDS Guidelines 2023 (open access)</b>: <a target="_blank" href="https://pmc.ncbi.nlm.nih.gov/articles/PMC10354163/">PMC</a></li>
            <li><b>Global Definition of ARDS (RCCM workshop)</b>: <a target="_blank" href="https://pmc.ncbi.nlm.nih.gov/articles/PMC10870872/">PMC</a> | <a target="_blank" href="https://www.atsjournals.org/doi/pdf/10.1164/rccm.202303-0558WS?download=true">PDF</a></li>
          </ul>
        </details>

        <details>
          <summary>Sepse / Choque séptico</summary>
          <ul class="klist">
            <li><b>Surviving Sepsis Campaign 2021 (página)</b>: <a target="_blank" href="https://www.sccm.org/clinical-resources/guidelines/guidelines/surviving-sepsis-guidelines-2021">SCCM</a></li>
            <li><b>SSC 2021 (PDF)</b>: <a target="_blank" href="https://sepsis.ch/wp-content/uploads/2024/09/Surviving-Sepsis-Campaign_International-Guidelines-for-Management-of-Sepsis-and-Septic-Shock-2021.pdf">PDF</a></li>
          </ul>
        </details>

        <details>
          <summary>DPOC (obstrutivo)</summary>
          <ul class="klist">
            <li><b>GOLD 2025 Report</b>: <a target="_blank" href="https://goldcopd.org/2025-gold-report/">Página</a> | <a target="_blank" href="https://goldcopd.org/wp-content/uploads/2024/11/GOLD-2025-Report-v1.0-15Nov2024_WMV.pdf">PDF</a></li>
            <li><b>AMIB/SBPT 2024 — VM</b>: <a target="_blank" href="https://d1xe7tfg0uwul9.cloudfront.net/amib-portal/wp-content/uploads/2024/09/12100249/Orientacoes-Praticas-de-Ventilacao-Mecanica-Interativo-SET-11-1.pdf">PDF</a></li>
          </ul>
        </details>

        <details>
          <summary>Obesidade / OHS</summary>
          <ul class="klist">
            <li><b>ERS Review 2025 — Ventilation in the obese</b>: <a target="_blank" href="https://publications.ersnet.org/content/errev/34/176/240190">ERRev</a> | <a target="_blank" href="https://pmc.ncbi.nlm.nih.gov/articles/PMC12076159/">PMC</a></li>
            <li><b>Respiratory Care 2021 — Transpulmonary pressure-guided LPV in obesity</b>: <a target="_blank" href="https://pubmed.ncbi.nlm.nih.gov/33879565/">PubMed</a></li>
          </ul>
        </details>

        <details>
          <summary>Cardíaca (edema cardiogênico)</summary>
          <ul class="klist">
            <li><b>Cochrane 2019 — NPPV/CPAP no edema cardiogênico</b>: <a target="_blank" href="https://www.cochranelibrary.com/cdsr/doi/10.1002/14651858.CD005351.pub4/full">Cochrane</a></li>
            <li><b>ERS/ATS 2017 — NIV em insuficiência respiratória aguda</b>: <a target="_blank" href="https://publications.ersnet.org/content/erj/50/2/1602426">ERJ</a></li>
          </ul>
        </details>

        <details>
          <summary>Neuromuscular</summary>
          <ul class="klist">
            <li><b>CHEST Guideline 2023 — Respiratory management in NMD</b>: <a target="_blank" href="https://journal.chestnet.org/article/S0012-3692%2823%2900353-7/fulltext">Full text</a></li>
            <li><b>ERS/ATS 2017 — NIV em insuficiência respiratória aguda</b>: <a target="_blank" href="https://publications.ersnet.org/content/erj/50/2/1602426">ERJ</a></li>
          </ul>
        </details>

        <details>
          <summary>Neurocrítico / TCE</summary>
          <ul class="klist">
            <li><b>ACS TQP — Best Practices Guidelines TBI (PDF)</b>: <a target="_blank" href="https://www.facs.org/media/vgfgjpfk/best-practices-guidelines-traumatic-brain-injury.pdf">PDF</a></li>
          </ul>
        </details>

        <details>
          <summary>HFNC (geral, quando aplicável)</summary>
          <ul class="klist">
            <li><b>ERS 2022 — HFNC em insuficiência respiratória aguda</b>: <a target="_blank" href="https://publications.ersnet.org/content/erj/59/4/2101574">ERJ</a></li>
          </ul>
        </details>

        <div class="footer">
          Observação: as evidências são listadas como fontes para estudo. O app não fornece conduta.
        </div>
      </div>
    </section>

    <!-- ===================== SOBRE ===================== -->
    <section id="secSobre" class="hide">
      <div class="card">
        <h2>Sobre</h2>
        <p class="sub">
          SyncVent é educacional e não-prescritor. Organiza raciocínio por cenários e por leitura de curvas.
        </p>

        <div class="hr"></div>

        <details open>
          <summary>Uso e limites</summary>
          <ul class="klist">
            <li><b>Não-prescritor:</b> não fornece ordens de ajuste.</li>
            <li><b>Expandido sob demanda:</b> só aparece depois da análise compacta, se o usuário clicar.</li>
            <li><b>Responsabilidade:</b> decisão clínica é do profissional e equipe.</li>
          </ul>
        </details>
      </div>
    </section>

  </main>

  <script>
    // Splash
    function enterApp(){
      const el = document.getElementById("splash");
      el.classList.add("hide");
      setTimeout(()=>{ el.style.display="none"; }, 420);
    }

    // Tabs
    function showTab(which){
      const secCasos = document.getElementById("secCasos");
      const secAssin = document.getElementById("secAssin");
      const secMec = document.getElementById("secMec");
      const secRefs = document.getElementById("secRefs");
      const secSobre = document.getElementById("secSobre");

      secCasos.classList.toggle("hide", which!=="casos");
      secAssin.classList.toggle("hide", which!=="assin");
      secMec.classList.toggle("hide", which!=="mec");
      secRefs.classList.toggle("hide", which!=="refs");
      secSobre.classList.toggle("hide", which!=="sobre");

      document.getElementById("tabCasos").classList.toggle("active", which==="casos");
      document.getElementById("tabAssin").classList.toggle("active", which==="assin");
      document.getElementById("tabMec").classList.toggle("active", which==="mec");
      document.getElementById("tabRefs").classList.toggle("active", which==="refs");
      document.getElementById("tabSobre").classList.toggle("active", which==="sobre");

      window.scrollTo({top:0, behavior:"smooth"});
    }

    // Helpers
    function num(v){
      if(v===null || v===undefined) return NaN;
      const s = String(v).replace(",", ".").trim();
      const n = Number(s);
      return Number.isFinite(n) ? n : NaN;
    }

    // ===================== CASOS (conteúdo + calculadoras) =====================
    const CASES = {
      sara: {
        title: "SARA (ARDS) — definição (Global) + ventilação protetora (educacional)",
        lead: "Inclui triagem de hipoxemia pela Global Definition (P/F ≤300 ou S/F ≤315 com SpO₂≤97%; HFNO ≥30 L/min) + calculadoras de VT/PBW e ΔP.",
        body: `
          <div class="grid2">
            <div class="card" style="box-shadow:none; background: var(--panel2);">
              <h2>Definidores (educacional)</h2>
              <ul class="klist">
                <li><b>Hipoxemia compatível (Global Definition):</b> PaO₂/FiO₂ ≤ 300, ou SpO₂/FiO₂ ≤ 315 quando SpO₂ ≤ 97%.</li>
                <li><b>HFNO:</b> considerado quando fluxo ≥ 30 L/min (para aplicação do critério Global).</li>
                <li><b>Outros critérios (fora da calculadora):</b> início agudo e achados de imagem (opacidades bilaterais) conforme diretrizes/consensos.</li>
              </ul>

              <div class="hr"></div>

              <h2>Calculadora — SARA (Global) (educacional)</h2>

              <div class="row">
                <div style="flex:1; min-width:220px;">
                  <label>Tipo de suporte</label>
                  <select id="ards_support" onchange="updateArds()">
                    <option value="">Selecione…</option>
                    <option value="imv">VM invasiva</option>
                    <option value="niv">NIV/CPAP</option>
                    <option value="hfno">HFNO</option>
                  </select>
                </div>
                <div style="flex:1; min-width:220px;">
                  <label>Fluxo HFNO (L/min) — se HFNO</label>
                  <input id="ards_hfflow" placeholder="ex.: 40" oninput="updateArds()" />
                </div>
              </div>

              <div style="height:10px;"></div>

              <div class="row">
                <div style="flex:1; min-width:220px;">
                  <label>FiO₂ (fração)</label>
                  <input id="ards_fio2" placeholder="ex.: 0,60" oninput="updateArds()" />
                </div>
                <div style="flex:1; min-width:220px;">
                  <label>PaO₂ (mmHg) — opcional</label>
                  <input id="ards_pao2" placeholder="ex.: 80" oninput="updateArds()" />
                </div>
              </div>

              <div style="height:10px;"></div>

              <div class="row">
                <div style="flex:1; min-width:220px;">
                  <label>SpO₂ (%) — opcional</label>
                  <input id="ards_spo2" placeholder="ex.: 92" oninput="updateArds()" />
                  <div class="small">S/F só vale para critério se SpO₂ ≤ 97%.</div>
                </div>
                <div style="flex:1; min-width:220px;">
                  <label>PEEP/CPAP (cmH₂O) — opcional</label>
                  <input id="ards_peep" placeholder="ex.: 10" oninput="updateArds()" />
                </div>
              </div>

              <div class="hr"></div>

              <label>Atalhos (após preenchimento)</label>
              <div class="row">
                <span class="chip">P/F <b class="mono" id="pfQuick">—</b></span>
                <span class="chip">S/F <b class="mono" id="sfQuick">—</b></span>
                <span class="chip">Compatível Global? <b class="mono" id="globalQuick">—</b></span>
              </div>

              <div style="height:10px;"></div>

              <div class="outBox">
                <h3>Resultado SARA (Global)</h3>
                <div class="txt" id="ardsOut">Preencha suporte + FiO₂ + PaO₂ e/ou SpO₂.</div>
              </div>
            </div>

            <div class="card" style="box-shadow:none; background: var(--panel2);">
              <h2>Ventilação protetora — calculadoras (educacional)</h2>
              <p class="sub">Calcula VT/PBW e ΔP. Não é prescrição.</p>

              <div class="hr"></div>

              <div class="row">
                <div style="flex:1; min-width:220px;">
                  <label>PBW (kg)</label>
                  <input id="prot_pbw" placeholder="ex.: 60" oninput="updateProtective()" />
                </div>
                <div style="flex:1; min-width:220px;">
                  <label>VT (mL)</label>
                  <input id="prot_vt" placeholder="ex.: 360" oninput="updateProtective()" />
                </div>
              </div>

              <div style="height:10px;"></div>

              <div class="row">
                <div style="flex:1; min-width:220px;">
                  <label>Pplat (cmH₂O) — opcional</label>
                  <input id="prot_pplat" placeholder="ex.: 28" oninput="updateProtective()" />
                </div>
                <div style="flex:1; min-width:220px;">
                  <label>PEEP (cmH₂O) — opcional</label>
                  <input id="prot_peep" placeholder="ex.: 10" oninput="updateProtective()" />
                </div>
              </div>

              <div style="height:10px;"></div>

              <div class="row">
                <div style="flex:1; min-width:220px;">
                  <label>Pinsp (cmH₂O) — opcional (modo pressórico)</label>
                  <input id="prot_pinsp" placeholder="ex.: 14 (pressão acima da PEEP)" oninput="updateProtective()" />
                  <div class="small">Se VC: ΔP = Pplat−PEEP. Se PC: ΔP ~ Pinsp (aprox. educacional).</div>
                </div>
              </div>

              <div class="hr"></div>

              <div class="row">
                <span class="chip">VT/PBW <b class="mono" id="vtkgQuick">—</b></span>
                <span class="chip">ΔP <b class="mono" id="dpQuick">—</b></span>
              </div>

              <div style="height:10px;"></div>

              <div class="outBox">
                <h3>Resultado protetora</h3>
                <div class="txt" id="protOut">Preencha PBW + VT e/ou Pplat+PEEP (ou Pinsp).</div>
              </div>

              <div class="hr"></div>

              <details open>
                <summary>Pontos de atenção (educacional)</summary>
                <ul class="klist">
                  <li><b>ΔP</b> é usado como “ponto de atenção” em ventilação protetora (exemplo de referência frequente: ~15 cmH₂O).</li>
                  <li><b>Curvas:</b> olhar demanda &gt; entrega, ciclos colados, expiração incompleta, esforço sem disparo.</li>
                </ul>
              </details>

              <details>
                <summary>Links (SARA)</summary>
                <ul class="klist">
                  <li><b>AMIB/SBPT 2024</b>: <a target="_blank" href="https://d1xe7tfg0uwul9.cloudfront.net/amib-portal/wp-content/uploads/2024/09/12100249/Orientacoes-Praticas-de-Ventilacao-Mecanica-Interativo-SET-11-1.pdf">PDF</a></li>
                  <li><b>ESICM 2023</b>: <a target="_blank" href="https://pmc.ncbi.nlm.nih.gov/articles/PMC10354163/">PMC</a></li>
                  <li><b>Global Definition</b>: <a target="_blank" href="https://pmc.ncbi.nlm.nih.gov/articles/PMC10870872/">PMC</a></li>
                </ul>
              </details>
            </div>
          </div>
        `
      },

      sepse: {
        title: "Sepse / Choque séptico — definições e pontos de atenção ventilatórios (educacional)",
        lead: "Foco em interação VM–hemodinâmica, drive elevado e risco de SARA associado à sepse.",
        body: `
          <div class="grid2">
            <div class="card" style="box-shadow:none; background: var(--panel2);">
              <h2>Definições (educacional)</h2>
              <ul class="klist">
                <li><b>Sepse:</b> disfunção orgânica ameaçadora à vida em resposta desregulada à infecção (Sepsis-3).</li>
                <li><b>Choque séptico:</b> necessidade de vasopressor para manter MAP ≥ 65 e lactato &gt; 2 mmol/L na ausência de hipovolemia (Sepsis-3).</li>
                <li><b>Sepse-induced ARDS:</b> usar bloco SARA para triagem de hipoxemia (Global).</li>
              </ul>

              <div class="hr"></div>

              <details open>
                <summary>Pontos de atenção (educacional)</summary>
                <ul class="klist">
                  <li><b>Drive alto:</b> aumenta demanda, esforço e risco de assincronias.</li>
                  <li><b>Curvas:</b> demanda &gt; entrega (concavidade), ciclos colados, expiração incompleta, esforço sem disparo.</li>
                  <li><b>VM–hemodinâmica:</b> reavaliar resposta clínica a mudanças ventilatórias (tendência).</li>
                </ul>
              </details>

              <details>
                <summary>Evidências (links)</summary>
                <ul class="klist">
                  <li><b>SSC 2021 (página)</b>: <a target="_blank" href="https://www.sccm.org/clinical-resources/guidelines/guidelines/surviving-sepsis-guidelines-2021">SCCM</a></li>
                  <li><b>SSC 2021 (PDF)</b>: <a target="_blank" href="https://sepsis.ch/wp-content/uploads/2024/09/Surviving-Sepsis-Campaign_International-Guidelines-for-Management-of-Sepsis-and-Septic-Shock-2021.pdf">PDF</a></li>
                </ul>
              </details>
            </div>

            <div class="card" style="box-shadow:none; background: var(--panel2);">
              <h2>Checklist por curvas</h2>
              <ul class="klist">
                <li><b>Pressão:</b> oscilações por esforço, ciclos colados.</li>
                <li><b>Fluxo:</b> concavidade (demanda &gt; entrega), expiração zera?</li>
                <li><b>Volume:</b> empilhamento / baseline não retorna.</li>
              </ul>
            </div>
          </div>
        `
      },

      dpoc: {
        title: "DPOC (obstrutivo) — definição e leitura por curvas (educacional)",
        lead: "Foco em resistência, expiração incompleta/auto-PEEP e esforço sem disparo.",
        body: `
          <div class="grid2">
            <div class="card" style="box-shadow:none; background: var(--panel2);">
              <h2>O que define o problema (educacional)</h2>
              <ul class="klist">
                <li><b>Fenótipo obstrutivo:</b> constante de tempo elevada → esvaziamento lento → risco de air-trapping/auto-PEEP.</li>
                <li><b>Interpretação por curvas:</b> principal “red flag” é fluxo expiratório não zerar.</li>
              </ul>

              <div class="hr"></div>

              <details open>
                <summary>Pontos de atenção (educacional)</summary>
                <ul class="klist">
                  <li><b>Expiração incompleta:</b> fluxo não zera antes do próximo ciclo.</li>
                  <li><b>Esforço sem disparo:</b> deflexões em expiração sem iniciar ciclo (auto-PEEP + fraqueza).</li>
                  <li><b>Resistência:</b> pico desproporcional (quando comparável) sugere componente resistivo.</li>
                </ul>
              </details>

              <details>
                <summary>Evidências (links)</summary>
                <ul class="klist">
                  <li><b>GOLD 2025</b>: <a target="_blank" href="https://goldcopd.org/2025-gold-report/">Página</a> | <a target="_blank" href="https://goldcopd.org/wp-content/uploads/2024/11/GOLD-2025-Report-v1.0-15Nov2024_WMV.pdf">PDF</a></li>
                  <li><b>AMIB/SBPT 2024 — VM</b>: <a target="_blank" href="https://d1xe7tfg0uwul9.cloudfront.net/amib-portal/wp-content/uploads/2024/09/12100249/Orientacoes-Praticas-de-Ventilacao-Mecanica-Interativo-SET-11-1.pdf">PDF</a></li>
                </ul>
              </details>
            </div>

            <div class="card" style="box-shadow:none; background: var(--panel2);">
              <h2>Checklist por curvas</h2>
              <ul class="klist">
                <li><b>Fluxo:</b> expiração zera? há “notches” sugerindo esforço sem disparo?</li>
                <li><b>Volume:</b> baseline retorna? há empilhamento?</li>
                <li><b>Pressão:</b> serrilhado pode sugerir secreção/condensado/artefato.</li>
              </ul>
            </div>
          </div>
        `
      },

      restritiva: {
        title: "Doença restritiva — definição e leitura por curvas (educacional)",
        lead: "Foco em baixa complacência do sistema respiratório e demanda variável.",
        body: `
          <div class="grid2">
            <div class="card" style="box-shadow:none; background: var(--panel2);">
              <h2>Definição (educacional)</h2>
              <ul class="klist">
                <li><b>Restrição / baixa complacência:</b> para volumes equivalentes, maior pressão é necessária (contexto-dependente).</li>
                <li><b>Interpretação por curvas:</b> pressão sustentada alta e “enchimento limitado” podem ocorrer (modo-dependente).</li>
              </ul>

              <div class="hr"></div>

              <details open>
                <summary>Pontos de atenção (educacional)</summary>
                <ul class="klist">
                  <li><b>Baixa complacência:</b> integrar pressões, volumes e conforto.</li>
                  <li><b>Se hipoxemia aguda:</b> avaliar compatibilidade com SARA (usar bloco SARA).</li>
                </ul>
              </details>

              <details>
                <summary>Evidências (links)</summary>
                <ul class="klist">
                  <li><b>ESICM ARDS 2023</b>: <a target="_blank" href="https://pmc.ncbi.nlm.nih.gov/articles/PMC10354163/">PMC</a></li>
                  <li><b>AMIB/SBPT 2024 — VM</b>: <a target="_blank" href="https://d1xe7tfg0uwul9.cloudfront.net/amib-portal/wp-content/uploads/2024/09/12100249/Orientacoes-Praticas-de-Ventilacao-Mecanica-Interativo-SET-11-1.pdf">PDF</a></li>
                </ul>
              </details>
            </div>

            <div class="card" style="box-shadow:none; background: var(--panel2);">
              <h2>Checklist por curvas</h2>
              <ul class="klist">
                <li><b>Pressão:</b> sustentada alta e variações com esforço.</li>
                <li><b>Fluxo:</b> concavidade se demanda &gt; entrega (assistidos).</li>
                <li><b>Volume:</b> empilhamento se ciclos colados/expiração curta.</li>
              </ul>
            </div>
          </div>
        `
      },

      cardiaca: {
        title: "Cardíaca (edema cardiogênico) — definição e suporte ventilatório (educacional)",
        lead: "Foco em VNI/CPAP como suporte em edema cardiogênico e integração hemodinâmica.",
        body: `
          <div class="grid2">
            <div class="card" style="box-shadow:none; background: var(--panel2);">
              <h2>Definição (educacional)</h2>
              <ul class="klist">
                <li><b>Edema cardiogênico:</b> insuficiência respiratória por congestão/pressões de enchimento elevadas.</li>
                <li><b>Curvas:</b> desconforto e assincronias podem coexistir; usar módulo de Assincronias para organizar hipóteses.</li>
              </ul>

              <div class="hr"></div>

              <details open>
                <summary>Pontos de atenção (educacional)</summary>
                <ul class="klist">
                  <li><b>Integração hemodinâmica:</b> reavaliar tendência clínica após mudanças de suporte.</li>
                  <li><b>Curvas:</b> esforço e ciclos colados aumentam variabilidade e desconforto.</li>
                </ul>
              </details>

              <details>
                <summary>Evidências (links)</summary>
                <ul class="klist">
                  <li><b>Cochrane 2019 — NPPV/CPAP em edema cardiogênico</b>: <a target="_blank" href="https://www.cochranelibrary.com/cdsr/doi/10.1002/14651858.CD005351.pub4/full">Cochrane</a></li>
                  <li><b>ERS/ATS 2017 — NIV em insuficiência respiratória aguda</b>: <a target="_blank" href="https://publications.ersnet.org/content/erj/50/2/1602426">ERJ</a></li>
                </ul>
              </details>
            </div>

            <div class="card" style="box-shadow:none; background: var(--panel2);">
              <h2>Checklist por curvas</h2>
              <ul class="klist">
                <li><b>Fluxo:</b> demanda &gt; entrega? (concavidade)</li>
                <li><b>Pressão:</b> oscilações por esforço / ciclos colados.</li>
                <li><b>Volume:</b> empilhamento em caso de ciclos muito próximos.</li>
              </ul>
            </div>
          </div>
        `
      },

      obeso: {
        title: "Obeso / OHS — particularidades fisiológicas (educacional)",
        lead: "Pressões podem refletir parede torácica; risco de colapso/atelectasia e desmame difícil.",
        body: `
          <div class="grid2">
            <div class="card" style="box-shadow:none; background: var(--panel2);">
              <h2>Definição (educacional)</h2>
              <ul class="klist">
                <li><b>Obesidade:</b> mecânica respiratória alterada (parede torácica/volume pulmonar reduzido).</li>
                <li><b>Interpretação:</b> pressão de via aérea nem sempre reflete estresse pulmonar isolado.</li>
              </ul>

              <div class="hr"></div>

              <details open>
                <summary>Pontos de atenção (educacional)</summary>
                <ul class="klist">
                  <li><b>Curvas:</b> sinais de colapso/atelectasia (modo-dependente), esforço elevado, expiração incompleta se obstrução coexistente.</li>
                  <li><b>Mecânica:</b> usar contexto “obesidade” no motor de Mecânica para interpretação expandida.</li>
                </ul>
              </details>

              <details>
                <summary>Evidências (links)</summary>
                <ul class="klist">
                  <li><b>ERS Review 2025 — Ventilation in the obese</b>: <a target="_blank" href="https://publications.ersnet.org/content/errev/34/176/240190">ERRev</a> | <a target="_blank" href="https://pmc.ncbi.nlm.nih.gov/articles/PMC12076159/">PMC</a></li>
                  <li><b>Respiratory Care 2021 — transpulmonary pressure-guided LPV</b>: <a target="_blank" href="https://pubmed.ncbi.nlm.nih.gov/33879565/">PubMed</a></li>
                </ul>
              </details>
            </div>

            <div class="card" style="box-shadow:none; background: var(--panel2);">
              <h2>Checklist por curvas</h2>
              <ul class="klist">
                <li><b>Pressão:</b> interpretar com contribuição de parede torácica.</li>
                <li><b>Fluxo:</b> demanda &gt; entrega e expiração completa.</li>
                <li><b>Volume:</b> baseline retorna? empilhamento?</li>
              </ul>
            </div>
          </div>
        `
      },

      neuro: {
        title: "Neuromuscular — risco de falha de trigger e fadiga (educacional)",
        lead: "Fraqueza aumenta chance de esforço sem disparo e ventilação inefetiva.",
        body: `
          <div class="grid2">
            <div class="card" style="box-shadow:none; background: var(--panel2);">
              <h2>Definição (educacional)</h2>
              <ul class="klist">
                <li><b>Fraqueza neuromuscular:</b> reduz capacidade de gerar fluxo/pressão para trigger e manter esforço.</li>
                <li><b>Curvas:</b> deflexões sem disparo e padrões de esforço irregular.</li>
              </ul>

              <div class="hr"></div>

              <details open>
                <summary>Pontos de atenção (educacional)</summary>
                <ul class="klist">
                  <li><b>Esforço sem disparo:</b> comum (especialmente se auto-PEEP coexistir).</li>
                  <li><b>Assincronias:</b> usar motor de Assincronias para hipóteses e diferenciais.</li>
                </ul>
              </details>

              <details>
                <summary>Evidências (links)</summary>
                <ul class="klist">
                  <li><b>CHEST 2023 — Respiratory management in NMD</b>: <a target="_blank" href="https://journal.chestnet.org/article/S0012-3692%2823%2900353-7/fulltext">Full text</a></li>
                  <li><b>ERS/ATS 2017 — NIV em insuficiência respiratória aguda</b>: <a target="_blank" href="https://publications.ersnet.org/content/erj/50/2/1602426">ERJ</a></li>
                </ul>
              </details>
            </div>

            <div class="card" style="box-shadow:none; background: var(--panel2);">
              <h2>Checklist por curvas</h2>
              <ul class="klist">
                <li><b>Deflexões sem disparo:</b> esforço inefetivo.</li>
                <li><b>Fluxo:</b> atraso de disparo, concavidades, ciclos sem esforço (artefato).</li>
              </ul>
            </div>
          </div>
        `
      },

      neurocrit: {
        title: "Neurocrítico / TCE — estabilidade ventilatória (educacional)",
        lead: "Evitar oscilações por assincronia; suporte depende do protocolo local e metas neurocríticas.",
        body: `
          <div class="grid2">
            <div class="card" style="box-shadow:none; background: var(--panel2);">
              <h2>Definição (educacional)</h2>
              <ul class="klist">
                <li><b>Neurocrítico:</b> metas ventilatórias dependem de ICP/CPP e estratégia institucional.</li>
                <li><b>Curvas:</b> assincronias e ciclos colados podem gerar instabilidade ventilatória.</li>
              </ul>

              <div class="hr"></div>

              <details open>
                <summary>Pontos de atenção (educacional)</summary>
                <ul class="klist">
                  <li><b>Assincronias:</b> identificar e reduzir variabilidade (módulo Assincronias).</li>
                  <li><b>Mecânica:</b> diferenciar resistência vs complacência vs artefato (módulo Mecânica).</li>
                </ul>
              </details>

              <details>
                <summary>Evidências (links)</summary>
                <ul class="klist">
                  <li><b>ACS TQP — Best Practices Guidelines TBI</b>: <a target="_blank" href="https://www.facs.org/media/vgfgjpfk/best-practices-guidelines-traumatic-brain-injury.pdf">PDF</a></li>
                </ul>
              </details>
            </div>

            <div class="card" style="box-shadow:none; background: var(--panel2);">
              <h2>Checklist por curvas</h2>
              <ul class="klist">
                <li><b>Pressão:</b> oscilações por esforço.</li>
                <li><b>Fluxo/Volume:</b> ciclos colados e empilhamento.</li>
              </ul>
            </div>
          </div>
        `
      },

      trauma: {
        title: "Trauma — fenótipos mistos e leitura por curvas (educacional)",
        lead: "Pode coexistir choque/contusão/obstrução/SARA; usar blocos específicos e motores por curvas.",
        body: `
          <div class="grid2">
            <div class="card" style="box-shadow:none; background: var(--panel2);">
              <h2>Definição (educacional)</h2>
              <ul class="klist">
                <li><b>Trauma:</b> heterogêneo; avaliar coexistência de obstrução, contusão e hipoxemia.</li>
                <li><b>Curvas:</b> demanda alta (dor/ansiedade), expiração incompleta, ciclos colados.</li>
              </ul>

              <div class="hr"></div>

              <details open>
                <summary>Pontos de atenção (educacional)</summary>
                <ul class="klist">
                  <li><b>Se hipoxemia aguda:</b> avaliar compatibilidade com SARA (usar bloco SARA).</li>
                  <li><b>Se padrão obstrutivo:</b> usar bloco DPOC (expiração incompleta/auto-PEEP).</li>
                </ul>
              </details>

              <details>
                <summary>Evidências (links)</summary>
                <ul class="klist">
                  <li><b>ACS TQP — Best Practices Guidelines TBI</b> (quando TCE associado): <a target="_blank" href="https://www.facs.org/media/vgfgjpfk/best-practices-guidelines-traumatic-brain-injury.pdf">PDF</a></li>
                </ul>
              </details>
            </div>

            <div class="card" style="box-shadow:none; background: var(--panel2);">
              <h2>Checklist por curvas</h2>
              <ul class="klist">
                <li><b>Fluxo:</b> expiração zera? concavidade?</li>
                <li><b>Volume:</b> baseline retorna? empilhamento?</li>
                <li><b>Assincronias:</b> usar motor por achados observáveis.</li>
              </ul>
            </div>
          </div>
        `
      }
    };

    function renderCase(){
      const v = document.getElementById("caseSel").value;
      const area = document.getElementById("caseArea");
      if(!v){ area.innerHTML = ""; return; }

      const c = CASES[v];
      area.innerHTML = `
        <div class="card" style="box-shadow:none; background: var(--panel2);">
          <div class="row" style="justify-content:space-between;">
            <div>
              <h2>${c.title}</h2>
              <p class="sub">${c.lead}</p>
            </div>
          </div>
          <div class="hr"></div>
          ${c.body}
        </div>
      `;

      // inicializa calculadoras se estiver em SARA
      if(v==="sara"){
        setTimeout(()=>{ updateArds(); updateProtective(); }, 0);
      }
    }

    // ===== Calculadora SARA (Global) =====
    function updateArds(){
      const support = document.getElementById("ards_support")?.value || "";
      const hfflow = num(document.getElementById("ards_hfflow")?.value);
      const fio2 = num(document.getElementById("ards_fio2")?.value);
      const pao2 = num(document.getElementById("ards_pao2")?.value);
      const spo2 = num(document.getElementById("ards_spo2")?.value);

      const out = document.getElementById("ardsOut");
      if(!out) return;

      let lines = [];
      let pf = NaN, sf = NaN;

      if(Number.isFinite(pao2) && Number.isFinite(fio2) && fio2>0){
        pf = pao2 / fio2;
        document.getElementById("pfQuick").textContent = pf.toFixed(0);
        lines.push(`PaO₂/FiO₂ = ${pf.toFixed(0)}`);
      }else{
        document.getElementById("pfQuick").textContent = "—";
      }

      if(Number.isFinite(spo2) && Number.isFinite(fio2) && fio2>0){
        sf = spo2 / fio2;
        document.getElementById("sfQuick").textContent = sf.toFixed(0);
        lines.push(`SpO₂/FiO₂ = ${sf.toFixed(0)} (válido p/ critério se SpO₂ ≤ 97%)`);
      }else{
        document.getElementById("sfQuick").textContent = "—";
      }

      if(support) lines.push(`Suporte: ${support.toUpperCase()}`);
      if(support==="hfno" && Number.isFinite(hfflow)) lines.push(`HFNO fluxo: ${hfflow.toFixed(0)} L/min`);

      // critério hipoxemia (Global)
      let hypoxemia = false;
      let why = [];

      if(Number.isFinite(pf) && pf <= 300){ hypoxemia = true; why.push("P/F ≤ 300"); }
      if(Number.isFinite(sf) && Number.isFinite(spo2) && spo2 <= 97 && sf <= 315){
        hypoxemia = true; why.push("S/F ≤ 315 com SpO₂ ≤ 97%");
      }

      // HFNO: precisa >=30 para “entrar” no critério Global de suporte
      let supportOk = true;
      if(support==="hfno"){
        supportOk = (Number.isFinite(hfflow) && hfflow >= 30);
      }

      let verdict = "—";
      if(!support){
        verdict = "Selecione o tipo de suporte.";
      }else if(!Number.isFinite(fio2)){
        verdict = "Preencha FiO₂.";
      }else if(support==="hfno" && !Number.isFinite(hfflow)){
        verdict = "Preencha o fluxo do HFNO.";
      }else if(support==="hfno" && !supportOk){
        verdict = "HFNO < 30 L/min (fora do critério Global para HFNO).";
      }else{
        verdict = hypoxemia ? "SIM (hipoxemia compatível pelo critério Global)" : "NÃO (sem hipoxemia pelo critério Global)";
      }

      document.getElementById("globalQuick").textContent =
        verdict.startsWith("SIM") ? "SIM" : (verdict.startsWith("NÃO") ? "NÃO" : "—");

      if(lines.length===0){
        out.textContent = "Preencha suporte + FiO₂ + PaO₂ e/ou SpO₂.";
        return;
      }

      out.textContent =
        lines.join("\n") +
        "\n\nCompatibilidade Global (hipoxemia): " + verdict +
        (why.length ? ("\nCritério(s): " + why.join(" + ")) : "") +
        (support==="hfno" ? ("\nHFNO ≥ 30 L/min: " + (supportOk ? "sim" : "não")) : "");
    }

    // ===== Calculadoras “protetora” (educacional) =====
    function updateProtective(){
      const pbw = num(document.getElementById("prot_pbw")?.value);
      const vt = num(document.getElementById("prot_vt")?.value);
      const pplat = num(document.getElementById("prot_pplat")?.value);
      const peep = num(document.getElementById("prot_peep")?.value);
      const pinsp = num(document.getElementById("prot_pinsp")?.value);

      const out = document.getElementById("protOut");
      if(!out) return;

      let lines = [];

      // VT/PBW
      if(Number.isFinite(pbw) && pbw>0 && Number.isFinite(vt) && vt>0){
        const vtkg = vt / pbw;
        document.getElementById("vtkgQuick").textContent = vtkg.toFixed(1) + " mL/kg";
        lines.push(`VT/PBW = ${vtkg.toFixed(1)} mL/kg`);
      }else{
        document.getElementById("vtkgQuick").textContent = "—";
      }

      // ΔP
      let dp = NaN;
      if(Number.isFinite(pplat) && Number.isFinite(peep)){
        dp = pplat - peep;
        lines.push(`ΔP (Pplat−PEEP) = ${dp.toFixed(1)} cmH₂O`);
      }else if(Number.isFinite(pinsp)){
        dp = pinsp;
        lines.push(`ΔP (aprox. em PC) ≈ Pinsp = ${dp.toFixed(1)} cmH₂O`);
      }

      if(Number.isFinite(dp)){
        document.getElementById("dpQuick").textContent = dp.toFixed(1) + " cmH₂O";
        lines.push(dp <= 15 ? "ΔP: abaixo de ~15 (ponto de atenção frequentemente citado)." :
                              "ΔP: acima de ~15 (ponto de atenção frequentemente citado).");
      }else{
        document.getElementById("dpQuick").textContent = "—";
      }

      out.textContent = lines.length ? lines.join("\n") : "Preencha PBW + VT e/ou Pplat+PEEP (ou Pinsp).";
    }

    // ===================== ASSINCRONIAS (compacto + expandido sob demanda) =====================
    const ASSIN_RULES = [
      {
        key: "ineffort",
        matchAny: ["ft_ineffective_effort"],
        compactTitle: "Esforço observado sem disparo (compatível com esforço inefetivo)",
        compactPhys: "Esforço ocorre sem gatilho. Em obstrutivos, auto-PEEP eleva o limiar; em fraqueza, o esforço pode não atingir o limiar.",
        hypos: ["Auto-PEEP/air-trapping", "Sensibilidade/atraso de trigger", "Fraqueza/fadiga", "Sedação/coordenação"],
        expanded: {
          why: [
            "O paciente gera esforço, mas não atinge o limiar de trigger (por limiar + auto-PEEP + fraqueza).",
            "Em obstrutivo, parte do esforço é “gasto” para vencer PEEP intrínseca antes de gerar fluxo/pressão mensurável."
          ],
          commonIn: ["DPOC/asma com expiração incompleta", "Neuromuscular/fadiga", "Suporte baixo com alta demanda"],
          pitfalls: ["Ruído/escala simulando deflexões", "Movimento/cardiogênico simulando ‘notches’", "Mandatórias confundidas com esforço"],
          howDifferent: [
            "Diferenciar de auto-disparo: no auto-disparo há ciclo sem esforço; aqui há esforço sem ciclo.",
            "Se coexistir atraso de disparo, pode haver deflexão prolongada antes do ciclo iniciar."
          ]
        }
      },
      {
        key: "doubletrigger",
        matchAny: ["pt_double_trigger", "vt_breath_stacking"],
        compactTitle: "Ciclos quase colados / empilhamento (compatível com duplo disparo)",
        compactPhys: "Demanda inspiratória pode exceder tempo/volume do ciclo, favorecendo novo disparo antes da expiração completa.",
        hypos: ["Drive elevado", "Tempo inspiratório insuficiente para demanda", "Término precoce em assistidos"],
        expanded: {
          why: [
            "Se o ventilador encerra a inspiração e o paciente mantém esforço, pode ocorrer novo disparo imediato.",
            "Empilhamento de volume indica pouca/nenhuma expiração entre ciclos."
          ],
          commonIn: ["SARA com drive alto", "Dor/ansiedade", "Assistidos com término precoce"],
          pitfalls: ["Auto-disparo por vazamento/condensado", "Trigger instável por artefatos"],
          howDifferent: [
            "Confirmar em fluxo: ausência de expiração entre ciclos reforça duplo disparo/empilhamento.",
            "Confirmar em volume: baseline não retorna."
          ]
        }
      },
      {
        key: "flowstarvation",
        matchAny: ["ft_flow_starvation"],
        compactTitle: "Demanda aparente maior que a entrega na inspiração (fluxo insuficiente)",
        compactPhys: "Concavidade sugere demanda > entrega naquele momento (modo-dependente).",
        hypos: ["Drive elevado (acidose/dor/ansiedade)", "Entrega limitada pelo modo/forma de fluxo", "Sincronia inadequada no término"],
        expanded: {
          why: [
            "Em VC, fluxo insuficiente pode gerar concavidade (paciente ‘puxa’ mais do que recebe).",
            "Em PSV, suporte pode ser insuficiente para demanda, produzindo padrão semelhante."
          ],
          commonIn: ["Sepse/acidose", "SARA com desconforto", "Transição de sedação/desmame"],
          pitfalls: ["Escala comprimida mascarando concavidade", "Mudança de modo alterando forma do traçado"],
          howDifferent: [
            "Se também houver término precoce, demanda alta + inspiração curta podem coexistir.",
            "Integrar com pressão (deflexões e desconforto)."
          ]
        }
      },
      {
        key: "earlycycle",
        matchAny: ["ft_early_cycle"],
        compactTitle: "Inspiração termina com esforço ainda presente (término precoce)",
        compactPhys: "Ventilador encerra inspiração antes do fim do esforço; esforço persiste após ciclar.",
        hypos: ["Ciclagem precoce (PSV)", "Tempo inspiratório curto", "Drive elevado"],
        expanded: {
          why: [
            "Critério de término encerra a inspiração antes do tempo neural do paciente.",
            "Pode levar a esforço na expiração imediata e instabilidade do padrão."
          ],
          commonIn: ["PSV com critério de ciclagem ‘alto’", "Drive elevado", "Ti neural prolongado"],
          pitfalls: ["Pode coexistir com duplo disparo; não são sinônimos.", "Interpretação depende do modo"],
          howDifferent: [
            "Procurar esforço pós-ciclagem (início da expiração).",
            "No término tardio, o conflito é no final da inspiração (paciente quer expirar)."
          ]
        }
      },
      {
        key: "latecycle",
        matchAny: ["ft_late_cycle"],
        compactTitle: "Inspiração se mantém quando o paciente já parece querer expirar (término tardio)",
        compactPhys: "Ventilador mantém inspiração quando paciente inicia expiração, gerando desconforto.",
        hypos: ["Ciclagem tardia (PSV)", "Tempo inspiratório excessivo", "Mudança do drive neural"],
        expanded: {
          why: [
            "Ventilador continua insuflando enquanto o paciente inicia expiração (sobreposição).",
            "Pode aparecer como irregularidade no fim da inspiração."
          ],
          commonIn: ["PSV com término tardio", "Obstrutivos com constante de tempo alta", "Desconforto"],
          pitfalls: ["Confundir com fluxo insuficiente (momento é diferente)"],
          howDifferent: [
            "No término tardio, o conflito é no fim da inspiração.",
            "No término precoce, o conflito aparece logo após ciclar para expiração."
          ]
        }
      },
      {
        key: "autotrigger",
        matchAny: ["ft_auto_trigger", "vt_leak_suspicion"],
        compactTitle: "Ciclos sem padrão claro de esforço (auto-disparo/artefato)",
        compactPhys: "Sensibilidade elevada ou artefatos (vazamento/condensado) podem gerar ciclos.",
        hypos: ["Vazamento", "Condensado/turbulência", "Sensibilidade excessiva"],
        expanded: {
          why: [
            "Vazamento e oscilações no circuito podem simular trigger.",
            "Condensado e vibração podem produzir disparos repetitivos."
          ],
          commonIn: ["NIV", "Circuito com condensado", "Leak em cuff/circuito"],
          pitfalls: ["Confundir com drive alto: aqui pode não haver esforço clínico proporcional."],
          howDifferent: [
            "Ciclos muito regulares e desacoplados da clínica favorecem auto-disparo.",
            "Checar coexistência de discrepância de volumes (leak)."
          ]
        }
      },
      {
        key: "expincomplete",
        matchAny: ["ft_exp_incomplete", "vt_breath_stacking"],
        compactTitle: "Expiração não completa (fluxo não zera / possível auto-PEEP)",
        compactPhys: "Fluxo expiratório não retorna a zero antes do próximo ciclo: sugere tempo expiratório insuficiente/obstrução/constante de tempo alta.",
        hypos: ["Obstrução (DPOC/asma, tubo)", "FR alta com Te curto", "Aprisionamento aéreo"],
        expanded: {
          why: [
            "Quando a expiração é curta para a constante de tempo, o pulmão não esvazia até o baseline.",
            "Auto-PEEP aumenta limiar de disparo e favorece esforço sem disparo."
          ],
          commonIn: ["DPOC/asma", "FR elevada", "Resistência elevada no circuito/tubo"],
          pitfalls: ["Ruído/escala pode simular fluxo ‘não zero’", "Sem volume, confirmar fica menos robusto"],
          howDifferent: [
            "Confirmar com volume: baseline não retorna.",
            "Correlacionar com esforço sem disparo no final da expiração."
          ]
        }
      }
    ];

    function toggleAssinExpand(){
      const box = document.getElementById("assinExpand");
      box.style.display = (box.style.display === "none" || box.style.display === "") ? "block" : "none";
    }

    function runAssinMotor(){
      const ctx = document.getElementById("assinContext").value;
      const picked = [...document.querySelectorAll("input.assin:checked")].map(x=>x.value);

      // Sempre reseta expandido
      document.getElementById("assinExpand").style.display = "none";
      document.getElementById("btnAssinExpand").style.display = "none";
      document.getElementById("assinExpandText").innerHTML = "";

      if(picked.length===0){
        document.getElementById("assinOut").textContent = "Selecione ao menos 1 achado e rode novamente.";
        return;
      }

      const hits = ASSIN_RULES.filter(r => r.matchAny.some(k => picked.includes(k)));

      // Compacto
      let lines = [];
      lines.push(`Contexto: ${ctx ? ctx : "não informado"}`);
      lines.push(`Achados: ${picked.join(", ")}`);
      lines.push("");

      hits.slice(0,5).forEach((r, i) => {
        lines.push(`(${i+1}) ${r.compactTitle}`);
        lines.push(`Fisiologia: ${r.compactPhys}`);
        lines.push(`Hipóteses:`);
        r.hypos.forEach(h => lines.push(`- ${h}`));
        lines.push("");
      });

      document.getElementById("assinOut").textContent = lines.join("\n");

      // Expandido (habilita só depois da análise compacta)
      const expandedHTML = buildAssinExpandedHTML(ctx, picked, hits.slice(0,3));
      document.getElementById("assinExpandText").innerHTML = expandedHTML;
      document.getElementById("btnAssinExpand").style.display = "inline-block";
    }

    function buildAssinExpandedHTML(ctx, picked, hitsTop){
      const esc = (s)=> String(s).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");
      let html = "";
      html += `<div><b>Contexto:</b> ${esc(ctx || "não informado")}</div>`;
      html += `<div><b>Achados selecionados:</b> ${esc(picked.join(", "))}</div>`;
      html += `<div style="height:10px;"></div>`;

      hitsTop.forEach((r, idx) => {
        html += `<div><b>(${idx+1}) ${esc(r.compactTitle)}</b></div>`;
        html += `<div style="margin-top:6px;"><b>Por que pode acontecer:</b><ul>`;
        r.expanded.why.forEach(x => html += `<li>${esc(x)}</li>`);
        html += `</ul></div>`;

        html += `<div><b>Mais frequente em:</b><ul>`;
        r.expanded.commonIn.forEach(x => html += `<li>${esc(x)}</li>`);
        html += `</ul></div>`;

        html += `<div><b>Armadilhas comuns:</b><ul>`;
        r.expanded.pitfalls.forEach(x => html += `<li>${esc(x)}</li>`);
        html += `</ul></div>`;

        html += `<div><b>Como diferenciar:</b><ul>`;
        r.expanded.howDifferent.forEach(x => html += `<li>${esc(x)}</li>`);
        html += `</ul></div>`;

        html += `<div style="height:10px;"></div>`;
      });

      html += `<div><b>Nota:</b> o expandido é aprofundamento didático do achado observado (não é conduta).</div>`;
      return html;
    }

    // ===================== MECÂNICA (compacto + expandido sob demanda) =====================
    const MEC_RULES = [
      {
        key:"lowC",
        matchAny:["pt_high_plateau","ft_insp_decel_steep"],
        compactTitle:"Baixa complacência provável (pulmão e/ou parede torácica)",
        compactPhys:"Pressão sustentada alta e padrões compatíveis podem sugerir sistema mais rígido. Interpretação depende de modo e contexto.",
        hypos:["SARA/edema/atelectasia", "Restritiva", "Obesidade/parede torácica"],
        expanded:{
          byScenario:{
            sara:[
              "Baixa complacência é frequente; integrar pressões com oxigenação e sinais de esforço.",
              "Curvas podem mostrar desconforto se demanda excede entrega."
            ],
            obeso:[
              "Pressões elevadas podem refletir parede torácica; separar ‘sistema’ de ‘pulmão’ exige contexto.",
              "Revisar sinais de colapso/atelectasia e esforço."
            ],
            restritiva:[
              "Padrões de baixa complacência podem ser persistentes; avaliar tendência e integração com demanda.",
              "Interpretar sempre com modo ventilatório."
            ],
            geral:[
              "Sem platô, a leitura é menos específica. Integrar com fluxo e volume."
            ]
          },
          pitfalls:[
            "Sem platô, separar resistência vs complacência fica menos específico.",
            "Escala do monitor pode mascarar diferenças.",
            "Mudanças de modo alteram forma do fluxo."
          ],
          whatToConfirm:[
            "Comparar pico vs final da inspiração quando disponível.",
            "Checar expiração completa e empilhamento.",
            "Correlacionar com sinais de esforço/desconforto."
          ]
        }
      },
      {
        key:"highR",
        matchAny:["pt_high_peak_normal_plateau","ft_insp_decel_slow"],
        compactTitle:"Resistência aumentada provável (componente resistivo)",
        compactPhys:"Pico desproporcional e padrões de fluxo compatíveis sugerem resistência elevada (via aérea/tubo/circuito).",
        hypos:["DPOC/asma/broncoespasmo", "Tubo/circuito (dobras, secreção, condensado)"],
        expanded:{
          byScenario:{
            dpoc:[
              "Constante de tempo alta favorece expiração prolongada e aprisionamento.",
              "Se fluxo expiratório não zera, reforça expiração incompleta/auto-PEEP."
            ],
            geral:[
              "Secreção/condensado pode aumentar resistência aparente e gerar serrilhado.",
              "Mudanças de calibre e posição do tubo alteram o padrão."
            ]
          },
          pitfalls:[
            "Pico alto pode ser tosse/artefato.",
            "Sem platô, a interpretação é menos específica."
          ],
          whatToConfirm:[
            "Fluxo expiratório zera? (auto-PEEP).",
            "Serrilhado sugere secreção/condensado/artefato.",
            "Integrar com assincronias (esforço sem disparo)."
          ]
        }
      },
      {
        key:"airtrap",
        matchAny:["ft_exp_not_zero","vt_incomplete_empty"],
        compactTitle:"Expiração incompleta / auto-PEEP provável",
        compactPhys:"Fluxo expiratório não zera e volume não retorna ao baseline sugerem aprisionamento aéreo (auto-PEEP).",
        hypos:["Obstrução + FR alta", "Tempo expiratório insuficiente", "Drive elevado"],
        expanded:{
          byScenario:{
            dpoc:[
              "Achado muito frequente: fluxo não zera e baseline de volume não retorna.",
              "Auto-PEEP aumenta limiar de disparo e favorece esforço sem disparo."
            ],
            geral:[
              "FR alta pode reduzir Te mesmo sem obstrução marcada.",
              "Empilhamento pode coexistir com ciclos colados."
            ]
          },
          pitfalls:[
            "Ruído/escala pode simular fluxo ‘não zero’.",
            "Sem volume disponível, confirmar fica mais difícil."
          ],
          whatToConfirm:[
            "Confirmar com volume: baseline não retorna.",
            "Buscar sinais de esforço sem disparo no final da expiração.",
            "Repetição consistente em múltiplos ciclos."
          ]
        }
      },
      {
        key:"leak",
        matchAny:["vt_leak","pt_sawtooth"],
        compactTitle:"Vazamento/artefato possível",
        compactPhys:"Discrepância persistente entre volumes e/ou serrilhado podem ocorrer por vazamento, condensado, secreção ou turbulência.",
        hypos:["Leak cuff/interface/circuito", "Condensado", "Secreção/turbulência"],
        expanded:{
          byScenario:{
            geral:[
              "Leak pode induzir auto-disparo e instabilidade do ciclo.",
              "Condensado e vibração geram serrilhado e falsos disparos."
            ]
          },
          pitfalls:[
            "Nem toda discrepância é leak (depende do método de medição).",
            "Serrilhado pode ser ruído."
          ],
          whatToConfirm:[
            "Checar se é persistente vs episódico.",
            "Correlacionar com alarmes e inspeção do circuito (fora do app).",
            "Se houver auto-disparo, usar módulo Assincronias."
          ]
        }
      }
    ];

    function toggleMecExpand(){
      const box = document.getElementById("mecExpand");
      box.style.display = (box.style.display === "none" || box.style.display === "") ? "block" : "none";
    }

    function runMecMotor(){
      const ctx = document.getElementById("mecContext").value;
      const picked = [...document.querySelectorAll("input.mec:checked")].map(x=>x.value);

      // Sempre reseta expandido
      document.getElementById("mecExpand").style.display = "none";
      document.getElementById("btnMecExpand").style.display = "none";
      document.getElementById("mecExpandText").innerHTML = "";

      if(picked.length===0){
        document.getElementById("mecOut").textContent = "Selecione ao menos 1 achado e rode novamente.";
        return;
      }

      const hits = MEC_RULES.filter(r => r.matchAny.some(k => picked.includes(k)));

      // Compacto
      let lines = [];
      lines.push(`Contexto: ${ctx ? ctx : "não informado"}`);
      lines.push(`Achados: ${picked.join(", ")}`);
      lines.push("");

      hits.slice(0,5).forEach((r, i) => {
        lines.push(`(${i+1}) ${r.compactTitle}`);
        lines.push(`Fisiologia: ${r.compactPhys}`);
        lines.push(`Hipóteses:`);
        r.hypos.forEach(h => lines.push(`- ${h}`));
        lines.push("");
      });

      if(picked.includes("met_asynchrony_suspect")){
        lines.push("Observação: o padrão sugere assincronia coexistente → use “Assincronias”.");
      }

      document.getElementById("mecOut").textContent = lines.join("\n");

      // Expandido (habilita só depois da análise compacta)
      const expandedHTML = buildMecExpandedHTML(ctx, picked, hits.slice(0,3));
      document.getElementById("mecExpandText").innerHTML = expandedHTML;
      document.getElementById("btnMecExpand").style.display = "inline-block";
    }

    function buildMecExpandedHTML(ctx, picked, hitsTop){
      const esc = (s)=> String(s).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");
      let html = "";
      html += `<div><b>Contexto:</b> ${esc(ctx || "não informado")}</div>`;
      html += `<div><b>Achados selecionados:</b> ${esc(picked.join(", "))}</div>`;
      html += `<div style="height:10px;"></div>`;

      const ctxKey =
        (ctx==="lowC") ? "sara" :
        (ctx==="highR") ? "dpoc" :
        (ctx==="obeso") ? "obeso" :
        "geral";

      hitsTop.forEach((r, idx) => {
        html += `<div><b>(${idx+1}) ${esc(r.compactTitle)}</b></div>`;

        const byScenario = r.expanded.byScenario || {};
        const list = byScenario[ctxKey] || byScenario["geral"] || [];

        if(list.length){
          html += `<div style="margin-top:6px;"><b>Interpretação no contexto selecionado:</b><ul>`;
          list.forEach(x => html += `<li>${esc(x)}</li>`);
          html += `</ul></div>`;
        }

        html += `<div><b>Armadilhas comuns:</b><ul>`;
        (r.expanded.pitfalls || []).forEach(x => html += `<li>${esc(x)}</li>`);
        html += `</ul></div>`;

        html += `<div><b>O que confirmar no traçado:</b><ul>`;
        (r.expanded.whatToConfirm || []).forEach(x => html += `<li>${esc(x)}</li>`);
        html += `</ul></div>`;

        html += `<div style="height:10px;"></div>`;
      });

      html += `<div><b>Nota:</b> o expandido é aprofundamento didático (não é conduta).</div>`;
      return html;
    }

    // ===================== RESET CHECKS =====================
    function resetChecks(which){
      if(which==="assin"){
        document.querySelectorAll("input.assin").forEach(x=> x.checked = false);
        document.getElementById("assinOut").textContent = "Selecione os achados e clique em “Rodar análise”.";
        document.getElementById("btnAssinExpand").style.display = "none";
        document.getElementById("assinExpand").style.display = "none";
        document.getElementById("assinExpandText").innerHTML = "";
      }
      if(which==="mec"){
        document.querySelectorAll("input.mec").forEach(x=> x.checked = false);
        document.getElementById("mecOut").textContent = "Selecione os achados e clique em “Rodar análise”.";
        document.getElementById("btnMecExpand").style.display = "none";
        document.getElementById("mecExpand").style.display = "none";
        document.getElementById("mecExpandText").innerHTML = "";
      }
    }

    // Init
    renderCase();
  </script>
</body>
</html>
