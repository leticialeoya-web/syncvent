<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SyncVent</title>
  <meta name="description" content="SyncVent — Plataforma educacional (adulto) para raciocínio clínico em ventilação mecânica, SARA e sepse." />

  <style>
    :root{
      --bg:#0b0f17; --panel:#0f1624; --panel2:#0c1320;
      --text:#eaf0ff; --muted:#a9b6d6; --line:rgba(180,200,255,.16);
      --blue:#2d7dff; --blue2:#5aa0ff; --shadow: 0 10px 30px rgba(0,0,0,.45);
      --radius:16px;
      --ok: rgba(60, 255, 160, .16);
      --warn: rgba(255, 200, 80, .14);
      --bad: rgba(255, 80, 80, .14);
    }
    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "Helvetica Neue", sans-serif;
      background: radial-gradient(1200px 600px at 20% 0%, rgba(45,125,255,.25), transparent 55%),
                  radial-gradient(900px 500px at 80% 20%, rgba(90,160,255,.18), transparent 55%),
                  linear-gradient(180deg, #070a10 0%, #0b0f17 100%);
      color:var(--text);
      overflow-x:hidden;
    }
    a{ color:var(--blue2); text-decoration:none; }
    a:hover{ text-decoration:underline; }

    /* Splash */
    #splash{
      position:fixed; inset:0; z-index:9999; padding:24px;
      background: linear-gradient(180deg, #000 0%, #070a10 45%, #0b0f17 100%);
      display:flex; align-items:center; justify-content:center;
    }
    .splashCard{
      width:min(960px, 100%);
      border:1px solid rgba(255,255,255,.10);
      border-radius:24px;
      background: rgba(15,22,36,.55);
      backdrop-filter: blur(10px);
      box-shadow: var(--shadow);
      padding:28px;
    }
    .brandRow{ display:flex; align-items:center; gap:14px; margin-bottom:10px; }
    .logo{
      width:48px; height:48px; border-radius:14px;
      background: linear-gradient(135deg, rgba(45,125,255,1) 0%, rgba(90,160,255,1) 55%, rgba(255,255,255,.9) 130%);
      box-shadow: 0 10px 30px rgba(45,125,255,.35);
      position:relative;
    }
    .logo:after{
      content:""; position:absolute; inset:10px; border-radius:10px;
      background: rgba(0,0,0,.25); border:1px solid rgba(255,255,255,.22);
    }
    .brandTitle h1{ margin:0; font-size:28px; letter-spacing:.4px; }
    .brandTitle .sub{ margin:2px 0 0 0; color:var(--muted); font-size:13px; line-height:1.35; }

    .splashBody{ margin-top:14px; display:grid; grid-template-columns: 1.2fr .8fr; gap:14px; }
    @media (max-width:860px){ .splashBody{ grid-template-columns:1fr; } }
    .splashBox{
      border:1px solid var(--line);
      border-radius:18px;
      background: rgba(12,19,32,.55);
      padding:14px;
    }
    .splashBox h2{ margin:0 0 8px 0; font-size:14px; color:#dce6ff; letter-spacing:.2px; }
    .splashBox p{ margin:0; color:var(--muted); line-height:1.5; font-size:13px; }

    .btnRow{ display:flex; gap:10px; justify-content:flex-end; margin-top:14px; }
    .btn{
      border:1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.06);
      color:var(--text);
      padding:10px 14px;
      border-radius:14px;
      cursor:pointer;
      font-weight:900;
      letter-spacing:.2px;
    }
    .btnPrimary{
      border-color: rgba(45,125,255,.55);
      background: linear-gradient(135deg, rgba(45,125,255,.95) 0%, rgba(90,160,255,.95) 100%);
      box-shadow: 0 12px 26px rgba(45,125,255,.22);
      color:#081022;
    }

    header{
      position:sticky; top:0; z-index:50;
      border-bottom:1px solid var(--line);
      background: rgba(7,10,16,.55);
      backdrop-filter: blur(10px);
    }
    .wrap{ width:min(1260px, 100%); margin:0 auto; padding:16px 16px; }
    .topRow{ display:flex; align-items:center; justify-content:space-between; gap:14px; }
    .topLeft{ display:flex; align-items:center; gap:12px; min-width:240px; }
    .miniLogo{
      width:34px; height:34px; border-radius:12px;
      background: linear-gradient(135deg, rgba(45,125,255,1) 0%, rgba(90,160,255,1) 55%, rgba(255,255,255,.9) 130%);
      border:1px solid rgba(255,255,255,.12);
    }
    .appName strong{ font-size:15px; letter-spacing:.2px; }
    .appName span{ font-size:12px; color:var(--muted); }

    nav{ display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end; }
    .tab{
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      color:var(--text);
      padding:9px 12px;
      border-radius:999px;
      cursor:pointer;
      font-weight:900;
      font-size:13px;
    }
    .tab.active{
      border-color: rgba(45,125,255,.55);
      background: rgba(45,125,255,.16);
      box-shadow: inset 0 0 0 1px rgba(45,125,255,.10);
    }

    main{ padding:18px 0 28px; }
    .grid{ display:grid; grid-template-columns: 1.12fr .88fr; gap:14px; }
    @media (max-width:980px){ .grid{ grid-template-columns:1fr; } }

    .card{
      border:1px solid var(--line);
      border-radius: var(--radius);
      background: rgba(15,22,36,.55);
      backdrop-filter: blur(8px);
      box-shadow: var(--shadow);
      padding:14px;
    }
    .card h2{
      margin:0 0 10px 0;
      font-size:14px;
      letter-spacing:.2px;
      color:#dce6ff;
      display:flex; align-items:center; justify-content:space-between; gap:8px;
    }
    .hint{ color:var(--muted); font-size:12px; line-height:1.5; margin:0 0 12px 0; }

    .row{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    @media (max-width:720px){ .row{ grid-template-columns:1fr; } }
    label{ display:block; font-size:12px; color:#cfe0ff; margin-bottom:6px; font-weight:900; letter-spacing:.15px; }
    select, input, textarea{
      width:100%;
      padding:10px 11px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.22);
      color:var(--text);
      outline:none;
    }
    select:focus, input:focus, textarea:focus{
      border-color: rgba(90,160,255,.75);
      box-shadow: 0 0 0 3px rgba(90,160,255,.16);
    }
    textarea{ min-height:92px; resize:vertical; }

    details{
      border:1px solid rgba(255,255,255,.10);
      border-radius: 16px;
      background: rgba(0,0,0,.18);
      padding:10px 12px;
      margin-top:12px;
    }
    details summary{
      cursor:pointer;
      font-weight:900;
      letter-spacing:.2px;
      color:#dce6ff;
      font-size:13px;
      list-style:none;
    }
    details summary::-webkit-details-marker{ display:none; }

    .pill{
      display:inline-flex; align-items:center; gap:6px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.04);
      color:#dce6ff;
      font-size:12px;
      font-weight:900;
    }
    .pill.ok{ background: var(--ok); }
    .pill.warn{ background: var(--warn); }
    .pill.bad{ background: var(--bad); }

    .actions{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:flex-end; margin-top:12px; }
    .btnSmall{
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color:var(--text);
      padding:9px 12px;
      border-radius:14px;
      cursor:pointer;
      font-weight:900;
      font-size:13px;
    }
    .btnSmall.primary{
      border-color: rgba(45,125,255,.55);
      background: rgba(45,125,255,.18);
    }
    .btnSmall.danger{ background: rgba(255,80,80,.12); }

    .resultBox{
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      border-radius: 16px;
      padding:12px;
      min-height: 240px;
      white-space: pre-wrap;
      line-height: 1.55;
      font-size: 13px;
      color:#eaf0ff;
    }

    .subgrid{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    @media (max-width:860px){ .subgrid{ grid-template-columns:1fr; } }

    .sigList{
      margin:10px 0 0 0; padding:0; list-style:none;
      display:grid; grid-template-columns: 1fr 1fr; gap:8px;
    }
    @media (max-width:720px){ .sigList{ grid-template-columns:1fr; } }
    .sigItem{
      display:flex; align-items:flex-start; gap:10px;
      border:1px solid rgba(255,255,255,.10);
      border-radius:14px;
      padding:10px;
      background: rgba(255,255,255,.03);
    }
    .sigItem input{ width:auto; margin-top:2px; }

    .tableWrap{
      overflow:auto;
      border:1px solid rgba(255,255,255,.12);
      border-radius:16px;
      background: rgba(0,0,0,.18);
    }
    table{ border-collapse:collapse; width:100%; min-width:720px; font-size:12px; }
    th, td{
      padding:10px 10px;
      border-bottom:1px solid rgba(255,255,255,.10);
      text-align:left;
      vertical-align:top;
      color:#eaf0ff;
    }
    th{ color:#dce6ff; letter-spacing:.2px; background: rgba(255,255,255,.03); }
    .hl{ background: rgba(45,125,255,.12); outline: 1px solid rgba(45,125,255,.35); }

    .refs{
      margin-top:8px;
      border:1px solid rgba(255,255,255,.10);
      border-radius:14px;
      background: rgba(0,0,0,.14);
      padding:10px;
      font-size:12px;
      color:var(--muted);
      line-height:1.5;
    }
    .refs b{ color:#dce6ff; }
    .tag{
      display:inline-block;
      margin-right:8px;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.03);
      color:#dce6ff;
      font-size:11px;
      font-weight:900;
    }

    .imgGrid{ display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
    @media (max-width:980px){ .imgGrid{ grid-template-columns:1fr; } }
    .imgCard{
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      border-radius: 18px;
      padding:12px;
    }
    .imgCard h3{ margin:0 0 8px 0; font-size:13px; color:#dce6ff; }
    .imgCard img{ width:100%; height:auto; border-radius: 14px; border:1px solid rgba(255,255,255,.10); background:#000; display:block; }

    footer{
      border-top:1px solid var(--line);
      margin-top:20px;
      padding:14px 0 24px;
      color:var(--muted);
      font-size:12px;
      line-height:1.55;
    }
  </style>
</head>

<body>
  <!-- Splash -->
  <div id="splash" aria-hidden="false">
    <div class="splashCard">
      <div class="brandRow">
        <div class="logo" aria-hidden="true"></div>
        <div class="brandTitle">
          <h1>SyncVent</h1>
          <p class="sub">Adulto • Definidores (SARA/sepse) • Mecânica e assincronia • Pontos de atenção com evidência (Guideline/Cochrane/PubMed)</p>
        </div>
      </div>

      <div class="splashBody">
        <div class="splashBox">
          <h2>Uso e limites</h2>
          <p>Instrumento exclusivamente educacional. Não orienta ajustes ventilatórios nem condutas terapêuticas. Use para estudo e discussão multiprofissional.</p>
        </div>
        <div class="splashBox">
          <h2>Autoria e direitos</h2>
          <p>© 2026 Leticia Moreira. Todos os direitos reservados. Proibida reprodução, distribuição, adaptação ou uso comercial sem autorização expressa e por escrito.</p>
        </div>
      </div>

      <div class="btnRow">
        <button class="btn" type="button" id="btnSplashTerms">Termos</button>
        <button class="btn btnPrimary" type="button" id="btnEnter">Entrar</button>
      </div>
    </div>
  </div>

  <header>
    <div class="wrap">
      <div class="topRow">
        <div class="topLeft">
          <div class="miniLogo" aria-hidden="true"></div>
          <div class="appName">
            <strong>SyncVent</strong><br/>
            <span>Adulto • Pontos de atenção por cenário</span>
          </div>
        </div>

        <nav aria-label="Navegação principal">
          <button class="tab active" id="tabCompact" type="button">Checklist & Definidores</button>
          <button class="tab" id="tabExpanded" type="button">Mecânica & Assincronia</button>
          <button class="tab" id="tabPeepWean" type="button">PEEP & Desmame</button>
          <button class="tab" id="tabNormals" type="button">Curvas normais</button>
          <button class="tab" id="tabAbout" type="button">Sobre & Termos</button>
        </nav>
      </div>
    </div>
  </header>

  <main class="wrap">
    <!-- =================== Compact =================== -->
    <section id="secCompact">
      <div class="grid">
        <div class="card">
          <h2>Checklist & Definidores <span class="pill" id="pillAdultOnly">Adulto-only</span></h2>
          <p class="hint">Preencha os definidores. A saída entrega pontos de atenção em VM por cenário, cada um com evidência robusta (Guideline/Cochrane/PubMed).</p>

          <div class="row">
            <div>
              <label>Adulto (≥ 18 anos)</label>
              <select id="adult_18_plus">
                <option value="sim">Sim</option>
                <option value="nao">Não</option>
              </select>
            </div>
            <div>
              <label>Tipo de suporte</label>
              <select id="support_type">
                <option value="invasivo">Invasivo</option>
                <option value="niv">NIV</option>
                <option value="hfno">HFNO</option>
                <option value="o2_conv">O₂ convencional</option>
              </select>
            </div>
          </div>

          <details open>
            <summary>Painel ventilatório atual (dados)</summary>
            <div class="row" id="panelInvasive" style="margin-top:10px;">
              <div><label>FiO₂ (fração)</label><input id="fio2" type="number" step="0.01" min="0.21" max="1" placeholder="Ex.: 0.50" /></div>
              <div><label>PEEP (cmH₂O)</label><input id="peep" type="number" step="1" min="0" max="30" placeholder="Ex.: 8" /></div>
              <div><label>VT exalado (mL)</label><input id="vt_exhaled_ml" type="number" step="1" min="0" max="1200" placeholder="Ex.: 420" /></div>
              <div><label>Pplat (cmH₂O)</label><input id="pplat" type="number" step="1" min="0" max="80" placeholder="Ex.: 22" /></div>
              <div><label>ΔP (auto)</label><input id="dp_auto" type="text" readonly /></div>
              <div><label>FR total (rpm)</label><input id="rr_total" type="number" step="1" min="0" max="80" placeholder="Ex.: 22" /></div>
            </div>

            <div class="row" id="panelNIV" style="display:none; margin-top:10px;">
              <div><label>FiO₂ (fração)</label><input id="fio2_niv" type="number" step="0.01" min="0.21" max="1" placeholder="Ex.: 0.50" /></div>
              <div><label>EPAP/CPAP (cmH₂O)</label><input id="epap" type="number" step="1" min="0" max="30" placeholder="Ex.: 10" /></div>
              <div><label>FR total (rpm)</label><input id="rr_total_niv" type="number" step="1" min="0" max="80" placeholder="Ex.: 28" /></div>
              <div><label>VT (se disponível)</label><input id="vt_niv" type="number" step="1" min="0" max="1200" placeholder="Ex.: 380" /></div>
            </div>

            <div class="row" id="panelHFNO" style="display:none; margin-top:10px;">
              <div><label>Fluxo (L/min)</label><input id="hfno_flow" type="number" step="1" min="0" max="80" placeholder="Ex.: 50" /></div>
              <div><label>FiO₂ (fração)</label><input id="fio2_hfno" type="number" step="0.01" min="0.21" max="1" placeholder="Ex.: 0.60" /></div>
              <div><label>FR total (rpm)</label><input id="rr_total_hfno" type="number" step="1" min="0" max="80" placeholder="Ex.: 30" /></div>
              <div></div>
            </div>
          </details>

          <details open>
            <summary>PBW + VT normalizado (ferramenta)</summary>
            <div class="row" style="margin-top:10px;">
              <div>
                <label>Sexo para PBW</label>
                <select id="pbw_sex">
                  <option value="nao">Não disponível</option>
                  <option value="m">Masculino</option>
                  <option value="f">Feminino</option>
                </select>
              </div>
              <div><label>Altura (cm)</label><input id="height_cm" type="number" step="0.1" min="120" max="220" placeholder="Ex.: 168" /></div>
              <div><label>PBW (kg) (auto)</label><input id="pbw_kg" type="text" readonly /></div>
              <div><label>VT (mL) para cálculo</label><input id="vt_for_calc" type="number" step="1" min="0" max="1200" placeholder="Pode copiar do VT exalado" /></div>
              <div><label>VT (mL/kg PBW) (auto)</label><input id="vt_mlkg" type="text" readonly /></div>
              <div>
                <label>Confiabilidade do VT</label>
                <select id="vt_reliability">
                  <option value="nao">Não disponível</option>
                  <option value="alta">Alta</option>
                  <option value="media">Média</option>
                  <option value="baixa">Baixa</option>
                </select>
              </div>
            </div>
          </details>

          <details open>
            <summary>Definidor de SARA (Berlin) + P/F</summary>
            <div class="row" style="margin-top:10px;">
              <div>
                <label>Início ≤ 7 dias</label>
                <select id="ards_onset_7d">
                  <option value="sim">Sim</option>
                  <option value="nao">Não</option>
                  <option value="incerto">Incerto</option>
                </select>
              </div>
              <div>
                <label>Opacidades bilaterais</label>
                <select id="ards_bilateral_imaging">
                  <option value="sim">Sim</option>
                  <option value="nao">Não</option>
                  <option value="incerto">Incerto</option>
                </select>
              </div>
              <div>
                <label>Edema cardiogênico dominante?</label>
                <select id="ards_cardiogenic_dominant">
                  <option value="nao">Não</option>
                  <option value="sim">Sim</option>
                  <option value="incerto">Incerto</option>
                </select>
              </div>
              <div><label>PaO₂ (mmHg)</label><input id="pao2" type="number" step="1" min="0" max="600" placeholder="Ex.: 80" /></div>
              <div><label>FiO₂ (fração) (para P/F)</label><input id="fio2_pf" type="number" step="0.01" min="0.21" max="1" placeholder="Ex.: 0.50" /></div>
              <div><label>PEEP/CPAP (cmH₂O) (Berlin usa ≥5)</label><input id="peep_pf" type="number" step="1" min="0" max="30" placeholder="Ex.: 8" /></div>
              <div><label>P/F (auto)</label><input id="pf_ratio" type="text" readonly /></div>
              <div><label>SARA (auto)</label><input id="ards_result" type="text" readonly /></div>
            </div>
          </details>

          <details open>
            <summary>Definidor de Sepse/Choque (Sepsis-3 operacional)</summary>
            <div class="row" style="margin-top:10px;">
              <div>
                <label>Infecção suspeita/confirmada</label>
                <select id="infection_suspected">
                  <option value="sim">Sim</option>
                  <option value="nao">Não</option>
                  <option value="incerto">Incerto</option>
                </select>
              </div>
              <div><label>ΔSOFA (numérico)</label><input id="sofa_delta" type="number" step="1" min="0" max="24" placeholder="Ex.: 3" /></div>
              <div>
                <label>Vasopressor para PAM ≥65</label>
                <select id="vasopressor_pam65">
                  <option value="nao">Não</option>
                  <option value="sim">Sim</option>
                  <option value="incerto">Incerto</option>
                </select>
              </div>
              <div><label>Lactato (mmol/L)</label><input id="lactate" type="number" step="0.1" min="0" max="30" placeholder="Ex.: 3.2" /></div>
              <div><label>Sepse (auto)</label><input id="sepsis_result" type="text" readonly /></div>
              <div><label>Choque séptico (auto)</label><input id="shock_result" type="text" readonly /></div>
            </div>
          </details>

          <details open>
            <summary>Gatilhos: mecânica, assincronia e cenários</summary>
            <div class="row" style="margin-top:10px;">
              <div><label>Fenótipo obstrutivo (suspeita)</label>
                <select id="obstructive_suspected"><option value="nao">Não</option><option value="sim">Sim</option><option value="incerto">Incerto</option></select>
              </div>
              <div><label>Fenótipo restritivo (suspeita)</label>
                <select id="restrictive_suspected"><option value="nao">Não</option><option value="sim">Sim</option><option value="incerto">Incerto</option></select>
              </div>
              <div><label>Alto esforço (suspeita)</label>
                <select id="high_effort"><option value="nao">Não</option><option value="sim">Sim</option><option value="incerto">Incerto</option></select>
              </div>
              <div><label>Assincronia relevante (suspeita)</label>
                <select id="major_async"><option value="nao">Não</option><option value="sim">Sim</option><option value="incerto">Incerto</option></select>
              </div>
              <div><label>DPOC conhecida</label>
                <select id="copd_known"><option value="nao">Não</option><option value="sim">Sim</option></select>
              </div>
              <div><label>Doença neuromuscular</label>
                <select id="neuromuscular"><option value="nao">Não</option><option value="sim">Sim</option></select>
              </div>
              <div><label>Neurocrítico</label>
                <select id="neuro_critical"><option value="nao">Não</option><option value="sim">Sim</option></select>
              </div>
              <div><label>Unilateral grave</label>
                <select id="unilateral_severe"><option value="nao">Não</option><option value="sim">Sim</option></select>
              </div>
            </div>
          </details>

          <div class="actions">
            <button class="btnSmall danger" type="button" id="btnReset">Limpar</button>
            <button class="btnSmall" type="button" id="btnSave">Salvar</button>
            <button class="btnSmall primary" type="button" id="btnRun">Gerar análise</button>
          </div>
        </div>

        <div class="card">
          <h2>Saída (pontos de atenção + evidência) <span class="pill" id="pillConfidence">confiança</span></h2>
          <p class="hint">A saída é educacional: prioriza o que observar e como organizar raciocínio, sem prescrever ajustes.</p>
          <div class="resultBox" id="outCompact"></div>
          <div class="actions" style="justify-content:flex-start;">
            <button class="btnSmall primary" type="button" id="btnGoExpanded">Abrir Mecânica & Assincronia</button>
          </div>
        </div>
      </div>
    </section>

    <!-- =================== Expanded =================== -->
    <section id="secExpanded" style="display:none;">
      <div class="grid">
        <div class="card">
          <h2>Mecânica & Assincronia (módulos) <span class="pill" id="pillModules">módulos</span></h2>
          <p class="hint">Marque ≥1 sinal observável por módulo. Isso gera justificativa e melhora a confiança do raciocínio.</p>
          <div class="subgrid" id="modulesContainer"></div>
          <div class="actions">
            <button class="btnSmall primary" type="button" id="btnRunExpanded">Gerar justificativa expandida</button>
          </div>
        </div>

        <div class="card">
          <h2>Justificativa expandida (gerada) <span class="pill" id="pillExpConf">confiança</span></h2>
          <p class="hint">Foco: assincronia e mecânica (sinais → inferências educacionais → impacto nos pontos de atenção).</p>
          <div class="resultBox" id="outExpanded"></div>
        </div>
      </div>
    </section>

    <!-- =================== PEEP & Weaning =================== -->
    <section id="secPeepWean" style="display:none;">
      <div class="grid">
        <div class="card">
          <h2>PEEP/FiO₂ tables (referência) + evidência</h2>
          <p class="hint">Tabelas refletem estratégias usadas em ensaios. O destaque por FiO₂ é educacional. Não prescreve ajuste.</p>

          <div class="row">
            <div><label>FiO₂ atual (fração)</label><input id="peep_fio2_input" type="number" step="0.01" min="0.21" max="1" placeholder="Ex.: 0.60" /></div>
            <div>
              <label>Estratégia (para destaque)</label>
              <select id="peep_strategy">
                <option value="lower">Lower PEEP / Higher FiO₂ (ARDSNet)</option>
                <option value="higher">Higher PEEP / Lower FiO₂ (referência)</option>
              </select>
            </div>
          </div>

          <details open>
            <summary>Lower PEEP / Higher FiO₂ (ARDSNet – referência)</summary>
            <div class="tableWrap" style="margin-top:10px;">
              <table id="tblLower">
                <thead><tr><th>Faixa FiO₂</th><th>PEEP na tabela (cmH₂O)</th></tr></thead>
                <tbody>
                  <tr data-min="0.30" data-max="0.40"><td>0.30–0.40</td><td>5</td></tr>
                  <tr data-min="0.40" data-max="0.50"><td>0.40–0.50</td><td>5–8</td></tr>
                  <tr data-min="0.50" data-max="0.60"><td>0.50–0.60</td><td>8–10</td></tr>
                  <tr data-min="0.60" data-max="0.70"><td>0.60–0.70</td><td>8–10</td></tr>
                  <tr data-min="0.70" data-max="0.80"><td>0.70–0.80</td><td>10–14</td></tr>
                  <tr data-min="0.80" data-max="0.90"><td>0.80–0.90</td><td>14</td></tr>
                  <tr data-min="0.90" data-max="1.00"><td>0.90–1.00</td><td>14–18</td></tr>
                  <tr data-min="1.00" data-max="1.01"><td>1.00</td><td>18–24</td></tr>
                </tbody>
              </table>
            </div>
          </details>

          <details>
            <summary>Higher PEEP / Lower FiO₂ (referência)</summary>
            <div class="tableWrap" style="margin-top:10px;">
              <table id="tblHigher">
                <thead><tr><th>Faixa FiO₂</th><th>PEEP na tabela (cmH₂O)</th></tr></thead>
                <tbody>
                  <tr data-min="0.30" data-max="0.40"><td>0.30–0.40</td><td>5–14</td></tr>
                  <tr data-min="0.40" data-max="0.50"><td>0.40–0.50</td><td>14–16</td></tr>
                  <tr data-min="0.50" data-max="0.51"><td>0.50</td><td>16–18</td></tr>
                  <tr data-min="0.50" data-max="0.80"><td>0.50–0.80</td><td>18–20</td></tr>
                  <tr data-min="0.80" data-max="1.00"><td>0.80–1.00</td><td>22</td></tr>
                  <tr data-min="1.00" data-max="1.01"><td>1.00</td><td>24</td></tr>
                </tbody>
              </table>
            </div>
          </details>

          <details open>
            <summary>Recrutamento, titulação e PEEP — síntese + evidência robusta</summary>
            <div class="refs" id="peepEvidenceBox"></div>
          </details>
        </div>

        <div class="card">
          <h2>Desmame difícil/prolongado + IMT (educacional)</h2>
          <p class="hint">Definidor e pontos de atenção com evidência (Cochrane/PubMed/guidelines), sem prescrição.</p>

          <details open>
            <summary>Definidor (estrutura educacional)</summary>
            <div class="row" style="margin-top:10px;">
              <div>
                <label>SBT já iniciado?</label>
                <select id="wean_sbt_started">
                  <option value="nao">Não</option>
                  <option value="sim">Sim</option>
                </select>
              </div>
              <div><label>Nº tentativas de SBT</label><input id="wean_sbt_attempts" type="number" step="1" min="0" max="10" value="0" /></div>
              <div><label>Dias desde 1º SBT</label><input id="wean_days_since_first_sbt" type="number" step="1" min="0" max="30" value="0" /></div>
              <div>
                <label>Traqueostomia</label>
                <select id="wean_trach">
                  <option value="nao">Não</option>
                  <option value="sim">Sim</option>
                </select>
              </div>
            </div>

            <div class="refs" style="margin-top:10px;" id="weanResultBox"></div>
          </details>

          <details open>
            <summary>Treino muscular inspiratório (IMT) — síntese + evidência</summary>
            <div class="refs" id="imtEvidenceBox"></div>
          </details>
        </div>
      </div>
    </section>

    <!-- =================== Normals =================== -->
    <section id="secNormals" style="display:none;">
      <div class="card">
        <h2>Curvas normais – PCV e VCV</h2>
        <p class="hint">Arquivos esperados na raiz do repositório: <b>pcv_normal.png</b> e <b>vcv_normal.png</b>.</p>
        <div class="imgGrid">
          <div class="imgCard">
            <h3>PCV – curvas normais</h3>
            <img src="pcv_normal.png" alt="Curvas normais PCV" />
          </div>
          <div class="imgCard">
            <h3>VCV – curvas normais</h3>
            <img src="vcv_normal.png" alt="Curvas normais VCV" />
          </div>
        </div>
      </div>
    </section>

    <!-- =================== About =================== -->
    <section id="secAbout" style="display:none;">
      <div class="card">
        <h2>Sobre & Termos</h2>

        <div class="card" style="background:rgba(0,0,0,.18); box-shadow:none;">
          <h2>Uso educacional</h2>
          <p class="hint" style="margin:0;">
            SyncVent não fornece prescrição, ajuste ventilatório ou decisão terapêutica. É um organizador de raciocínio e estudo.
          </p>
        </div>

        <div class="card" style="margin-top:12px; background:rgba(0,0,0,.18); box-shadow:none;">
          <h2>Direitos autorais</h2>
          <p class="hint" style="margin:0;">
            © 2026 Leticia Moreira. Todos os direitos reservados. Proibida reprodução, distribuição, adaptação, disponibilização pública
            ou uso comercial do conteúdo, estrutura, textos, lógica e interface sem autorização expressa e por escrito.
          </p>
        </div>
      </div>
    </section>

    <footer>
      <strong>SyncVent</strong> — © 2026 <strong>Leticia Moreira</strong>. Todos os direitos reservados.<br/>
      Uso educacional. Não constitui orientação clínica. Proibida reprodução e uso comercial sem autorização expressa.
    </footer>
  </main>

  <script>
    "use strict";

    // UX barriers (não é proteção técnica real; reduz cópia casual)
    document.addEventListener("contextmenu", (e) => e.preventDefault());
    document.addEventListener("dragstart", (e) => e.preventDefault());

    const $ = (id)=>document.getElementById(id);

    // Tabs
    const tabCompact=$("tabCompact"), tabExpanded=$("tabExpanded"), tabPeepWean=$("tabPeepWean"), tabNormals=$("tabNormals"), tabAbout=$("tabAbout");
    const secCompact=$("secCompact"), secExpanded=$("secExpanded"), secPeepWean=$("secPeepWean"), secNormals=$("secNormals"), secAbout=$("secAbout");

    function setTab(which){
      const tabs=[
        {b:tabCompact,s:secCompact,k:"compact"},
        {b:tabExpanded,s:secExpanded,k:"expanded"},
        {b:tabPeepWean,s:secPeepWean,k:"peepwean"},
        {b:tabNormals,s:secNormals,k:"normals"},
        {b:tabAbout,s:secAbout,k:"about"},
      ];
      tabs.forEach(t=>{
        const on=t.k===which;
        t.b.classList.toggle("active",on);
        t.s.style.display=on?"block":"none";
      });
      window.scrollTo({top:0, behavior:"smooth"});
    }
    tabCompact.onclick=()=>setTab("compact");
    tabExpanded.onclick=()=>setTab("expanded");
    tabPeepWean.onclick=()=>setTab("peepwean");
    tabNormals.onclick=()=>setTab("normals");
    tabAbout.onclick=()=>setTab("about");

    // Splash
    const splash=$("splash");
    $("btnEnter").onclick=()=>{ splash.style.display="none"; splash.setAttribute("aria-hidden","true"); };
    $("btnSplashTerms").onclick=()=>{ splash.style.display="none"; splash.setAttribute("aria-hidden","true"); setTab("about"); };

    // Inputs
    const adult_18_plus=$("adult_18_plus");
    const support_type=$("support_type");
    const panelInvasive=$("panelInvasive"), panelNIV=$("panelNIV"), panelHFNO=$("panelHFNO");

    const fio2=$("fio2"), peep=$("peep"), vt_exhaled_ml=$("vt_exhaled_ml"), pplat=$("pplat"), dp_auto=$("dp_auto");
    const pbw_sex=$("pbw_sex"), height_cm=$("height_cm"), pbw_kg=$("pbw_kg"), vt_for_calc=$("vt_for_calc"), vt_mlkg=$("vt_mlkg"), vt_reliability=$("vt_reliability");

    const ards_onset_7d=$("ards_onset_7d"), ards_bilateral_imaging=$("ards_bilateral_imaging"), ards_cardiogenic_dominant=$("ards_cardiogenic_dominant");
    const pao2=$("pao2"), fio2_pf=$("fio2_pf"), peep_pf=$("peep_pf"), pf_ratio=$("pf_ratio"), ards_result=$("ards_result");

    const infection_suspected=$("infection_suspected"), sofa_delta=$("sofa_delta"), vasopressor_pam65=$("vasopressor_pam65"), lactate=$("lactate");
    const sepsis_result=$("sepsis_result"), shock_result=$("shock_result");

    const obstructive_suspected=$("obstructive_suspected"), restrictive_suspected=$("restrictive_suspected"), high_effort=$("high_effort"), major_async=$("major_async");
    const copd_known=$("copd_known"), neuromuscular=$("neuromuscular"), neuro_critical=$("neuro_critical"), unilateral_severe=$("unilateral_severe");

    const outCompact=$("outCompact"), outExpanded=$("outExpanded");
    const pillConfidence=$("pillConfidence"), pillExpConf=$("pillExpConf"), pillModules=$("pillModules");
    const modulesContainer=$("modulesContainer");

    // PEEP tab
    const peep_fio2_input=$("peep_fio2_input");
    const peep_strategy=$("peep_strategy");
    const tblLower=$("tblLower");
    const tblHigher=$("tblHigher");
    const peepEvidenceBox=$("peepEvidenceBox");

    // Weaning/IMT tab
    const wean_sbt_started=$("wean_sbt_started");
    const wean_sbt_attempts=$("wean_sbt_attempts");
    const wean_days_since_first_sbt=$("wean_days_since_first_sbt");
    const wean_trach=$("wean_trach");
    const weanResultBox=$("weanResultBox");
    const imtEvidenceBox=$("imtEvidenceBox");

    // Storage
    const LS="syncvent_html_final_v1";

    function num(x){ const v=parseFloat(x); return Number.isFinite(v)?v:null; }

    function saveState(){ localStorage.setItem(LS, JSON.stringify(getState())); }
    function resetAll(){ localStorage.removeItem(LS); location.reload(); }

    function getState(){
      return {
        adult: adult_18_plus.value,
        support: support_type.value,
        fio2: fio2.value, peep: peep.value, vt: vt_exhaled_ml.value, pplat: pplat.value,

        pbwSex: pbw_sex.value, h: height_cm.value, vtCalc: vt_for_calc.value, vtRel: vt_reliability.value,

        ards_onset: ards_onset_7d.value,
        ards_bilat: ards_bilateral_imaging.value,
        ards_card: ards_cardiogenic_dominant.value,
        pao2: pao2.value, fio2pf: fio2_pf.value, peeppf: peep_pf.value,

        inf: infection_suspected.value,
        sofa: sofa_delta.value,
        vaso: vasopressor_pam65.value,
        lact: lactate.value,

        obs: obstructive_suspected.value,
        res: restrictive_suspected.value,
        effort: high_effort.value,
        async: major_async.value,
        copd: copd_known.value,
        nm: neuromuscular.value,
        neuro: neuro_critical.value,
        uni: unilateral_severe.value,

        peepFio2: peep_fio2_input.value,
        peepStrat: peep_strategy.value,

        weanStarted: wean_sbt_started.value,
        weanAttempts: wean_sbt_attempts.value,
        weanDays: wean_days_since_first_sbt.value,
        weanTrach: wean_trach.value
      };
    }

    function setState(st){
      if(!st) return;

      adult_18_plus.value = st.adult ?? "sim";
      support_type.value = st.support ?? "invasivo";

      fio2.value = st.fio2 ?? "";
      peep.value = st.peep ?? "";
      vt_exhaled_ml.value = st.vt ?? "";
      pplat.value = st.pplat ?? "";

      pbw_sex.value = st.pbwSex ?? "nao";
      height_cm.value = st.h ?? "";
      vt_for_calc.value = st.vtCalc ?? "";
      vt_reliability.value = st.vtRel ?? "nao";

      ards_onset_7d.value = st.ards_onset ?? "sim";
      ards_bilateral_imaging.value = st.ards_bilat ?? "incerto";
      ards_cardiogenic_dominant.value = st.ards_card ?? "incerto";
      pao2.value = st.pao2 ?? "";
      fio2_pf.value = st.fio2pf ?? "";
      peep_pf.value = st.peeppf ?? "";

      infection_suspected.value = st.inf ?? "incerto";
      sofa_delta.value = st.sofa ?? "";
      vasopressor_pam65.value = st.vaso ?? "incerto";
      lactate.value = st.lact ?? "";

      obstructive_suspected.value = st.obs ?? "nao";
      restrictive_suspected.value = st.res ?? "nao";
      high_effort.value = st.effort ?? "nao";
      major_async.value = st.async ?? "nao";
      copd_known.value = st.copd ?? "nao";
      neuromuscular.value = st.nm ?? "nao";
      neuro_critical.value = st.neuro ?? "nao";
      unilateral_severe.value = st.uni ?? "nao";

      peep_fio2_input.value = st.peepFio2 ?? "";
      peep_strategy.value = st.peepStrat ?? "lower";

      wean_sbt_started.value = st.weanStarted ?? "nao";
      wean_sbt_attempts.value = st.weanAttempts ?? "0";
      wean_days_since_first_sbt.value = st.weanDays ?? "0";
      wean_trach.value = st.weanTrach ?? "nao";
    }

    function refreshUI(){
      const inv = support_type.value==="invasivo";
      panelInvasive.style.display = inv ? "grid" : "none";
      panelNIV.style.display = (support_type.value==="niv") ? "grid" : "none";
      panelHFNO.style.display = (support_type.value==="hfno") ? "grid" : "none";

      if(adult_18_plus.value!=="sim"){
        outCompact.textContent="Instrumento aplicável apenas a pacientes adultos (≥18 anos).";
        outExpanded.textContent="";
        modulesContainer.innerHTML="";
        pillConfidence.textContent="bloqueado";
        pillExpConf.textContent="bloqueado";
        pillModules.textContent="bloqueado";
      }
    }

    // --- Calculations ---
    function calcDP(){
      const Pplat=num(pplat.value), PEEP=num(peep.value);
      if(Pplat!=null && PEEP!=null){
        const dp=Pplat-PEEP;
        dp_auto.value = dp.toFixed(1)+" cmH₂O";
        return dp;
      }
      dp_auto.value="";
      return null;
    }

    function calcPBW(){
      const sex=pbw_sex.value;
      const h=num(height_cm.value);
      if(!(sex==="m"||sex==="f") || h==null){ pbw_kg.value=""; return null; }
      const base=(sex==="m")?50:45.5;
      const pbw=base + 0.91*(h-152.4);
      const v=Math.round(pbw*10)/10;
      pbw_kg.value=String(v);
      return v;
    }

    function calcVTmlkg(){
      const pbw=calcPBW();
      const vt = num(vt_for_calc.value) ?? num(vt_exhaled_ml.value);
      if(pbw!=null && vt!=null && pbw>0){
        const val=vt/pbw;
        vt_mlkg.value=val.toFixed(2);
        return val;
      }
      vt_mlkg.value="";
      return null;
    }

    function calcPF(){
      const PaO2=num(pao2.value), FiO2=num(fio2_pf.value);
      if(PaO2!=null && FiO2!=null && FiO2>0){
        const pf=PaO2/FiO2;
        pf_ratio.value=String(Math.round(pf));
        return pf;
      }
      pf_ratio.value="";
      return null;
    }

    function defineARDS(){
      const onset=ards_onset_7d.value;
      const bilat=ards_bilateral_imaging.value;
      const cardi=ards_cardiogenic_dominant.value;
      const pf=calcPF();
      const PEEP=num(peep_pf.value);

      let status="SARA: indefinida (dados incompletos)";
      let sev="";

      const coreOk = (onset==="sim" && bilat==="sim" && cardi!=="sim");
      const coreNo = (onset==="nao" || bilat==="nao" || cardi==="sim");

      if(coreNo){
        status="SARA: não (critério essencial ausente)";
      } else if(coreOk && pf!=null && PEEP!=null && PEEP>=5 && pf<=300){
        status="SARA: sim (Berlin)";
        if(pf<=100) sev="Grave (P/F ≤100)";
        else if(pf<=200) sev="Moderada (P/F 101–200)";
        else sev="Leve (P/F 201–300)";
      } else if(coreOk){
        status="SARA: provável (faltam P/F e/ou PEEP/CPAP ≥5 ou P/F ≤300)";
      }

      ards_result.value = sev ? `${status} — ${sev}` : status;
      return {status, severity: sev, pf, peep: PEEP};
    }

    function defineSepsis(){
      const inf=infection_suspected.value;
      const sofa=num(sofa_delta.value);
      const vaso=vasopressor_pam65.value;
      const lact=num(lactate.value);

      let seps="Sepse: indefinida (dados incompletos)";
      if(inf==="nao") seps="Sepse: não (infecção ausente)";
      else if(inf==="sim" && sofa!=null){
        seps = (sofa>=2) ? "Sepse: sim (operacional)" : "Sepse: não (ΔSOFA < 2)";
      } else if(inf!=="nao"){
        seps="Sepse: provável (faltam dados)";
      }

      let shock="Choque séptico: não aplicável";
      const lactHigh = (lact!=null && lact>2);

      if(seps.startsWith("Sepse: sim")){
        if(vaso==="sim" && lact!=null){
          shock = lactHigh ? "Choque séptico: provável (vasopressor + lactato elevado)" : "Choque séptico: não sugerido (lactato não elevado)";
        } else if(vaso==="sim" && lact==null){
          shock = "Choque séptico: possível (vasopressor; lactato ausente)";
        } else {
          shock = "Choque séptico: não sugerido (sem vasopressor)";
        }
      } else if(seps.includes("provável")){
        shock = (vaso==="sim") ? "Choque séptico: possível (sepse provável + vasopressor)" : "Choque séptico: não sugerido";
      }

      sepsis_result.value=seps;
      shock_result.value=shock;
      return {seps, shock, sofa, lact, vaso, inf};
    }

    // --- Evidence library (anchors) ---
    // URLs are inside code (as requested). They are links, not citations.
    const EVID = {
      // ARDS
      ESICM_2023: {tag:"Guideline", label:"ESICM ARDS Guidelines 2023 (PMC)", url:"https://pmc.ncbi.nlm.nih.gov/articles/PMC10354163/"},
      ATS_2024: {tag:"Guideline", label:"ATS ARDS Update 2024 (AJRCCM)", url:"https://www.atsjournals.org/doi/10.1164/rccm.202311-2011ST"},
      COCHRANE_PEEP_2021: {tag:"Cochrane", label:"Cochrane 2021 — Higher vs lower PEEP in ARDS", url:"https://www.cochranelibrary.com/cdsr/doi/10.1002/14651858.CD009098.pub3/full"},
      COCHRANE_RECRUIT_2021: {tag:"Cochrane", label:"Cochrane 2021 — Recruitment maneuvers strategies", url:"https://www.cochranelibrary.com/cdsr/doi/10.1002/14651858.CD006667.pub4/full"},
      ARDSNET_ARMA_2000: {tag:"PubMed/RCT", label:"ARDSNet ARMA (NEJM 2000) low VT trial (PDF)", url:"https://www.nejm.org/doi/pdf/10.1056/NEJM200005043421801"},
      ALVEOLI_2004: {tag:"PubMed/RCT", label:"ALVEOLI Trial (NEJM 2004) PEEP strategy (PDF mirror)", url:"https://medschool.cuanschutz.edu/docs/librariesprovider60/education-docs/heartbeat-im-res/suggested-read/alveoli-peep-in-ards-nejm-2004.pdf"},
      RECRUITMENT_ART_HARM: {tag:"PubMed/RCT", label:"ART trial-related analysis (recruitment + PEEP titration) — potential harm (PDF mirror)", url:"https://www.hcor.com.br/wp-content/uploads/2022/09/BJA-2019-epub-HTE-in-ART.pdf"},
      BERLIN_2012: {tag:"Definition", label:"Berlin Definition of ARDS (PubMed)", url:"https://pubmed.ncbi.nlm.nih.gov/22797452/"},

      // Sepsis
      SEPSIS3_2016: {tag:"Definition", label:"Sepsis-3 definitions (JAMA 2016)", url:"https://jamanetwork.com/journals/jama/fullarticle/2492881"},
      SSC_2021: {tag:"Guideline", label:"Surviving Sepsis Campaign 2021 (landing)", url:"https://www.sccm.org/clinical-resources/guidelines/guidelines/surviving-sepsis-campaign-guidelines-2021"},

      // Weaning/SBT
      AARC_SBT_2024: {tag:"Guideline", label:"AARC CPG 2024 — Spontaneous Breathing Trial (PDF)", url:"https://www.aarc.org/wp-content/uploads/2023/11/CPG2024SpontaneousBreathingTrial.pdf"},
      PROLONGED_WEAN_2024: {tag:"Review", label:"Review 2024 — Prolonged weaning (PMC)", url:"https://pmc.ncbi.nlm.nih.gov/articles/PMC11629167/"},
      COCHRANE_PROTOCOL_WEAN: {tag:"Cochrane", label:"Cochrane — Protocolized weaning (search landing)", url:"https://www.cochranelibrary.com/search?searchBy=1&searchText=protocolized%20weaning%20mechanical%20ventilation"},
      COCHRANE_SBT_PSV_TTUBE: {tag:"Cochrane", label:"Cochrane — PSV vs T-tube SBT (search landing)", url:"https://www.cochranelibrary.com/search?searchBy=1&searchText=pressure%20support%20versus%20T-tube%20spontaneous%20breathing%20trial"},

      // IMT
      IMT_PUBMED_SR_2025: {tag:"PubMed/SR", label:"IMT systematic review 2025 (PubMed)", url:"https://pubmed.ncbi.nlm.nih.gov/40566408/"},
      IMT_EINSTEIN_2023: {tag:"SR", label:"IMT systematic review 2023 (einstein)", url:"https://journal.einstein.br/article/effects-of-inspiratory-muscle-training-on-weaning-from-mechanical-ventilation-and-other-aspects-a-systematic-review/"}
    };

    function refLines(keys){
      return keys.map(k=>{
        const e=EVID[k];
        return `• [${e.tag}] ${e.label}\n  ${e.url}`;
      }).join("\n");
    }

    // --- Points of attention generator (each point with robust evidence anchors) ---
    function buildPoints(st, ards, seps){
      const points = [];

      // Universal VM (auditability)
      points.push({
        title:"Sempre: coerência e rastreabilidade do suporte",
        why:[
          "Organizar o raciocínio com tendência (oxigenação, ventilação, mecânica, esforço) antes de concluir mecanismos.",
          "Priorizar assincronia/mecânica quando houver instabilidade ou desconforto."
        ],
        evidence:["ARDSNET_ARMA_2000"]
      });

      // ARDS
      if(ards.status.startsWith("SARA: sim") || ards.status.startsWith("SARA: provável")){
        points.push({
          title:"SARA: definição e severidade (Berlin) + proteção pulmonar como auditoria",
          why:[
            "Usar critérios Berlin para consistência diagnóstica e para comunicar gravidade (P/F com PEEP/CPAP ≥5).",
            "Descrever VT/PBW e ΔP como métricas de auditoria (sem prescrever ajuste)."
          ],
          evidence:["BERLIN_2012","ARDSNET_ARMA_2000","ESICM_2023"]
        });

        points.push({
          title:"SARA: PEEP (alto vs baixo) — evidência é contextual",
          why:[
            "High vs low PEEP tem efeito pequeno/incerto em mortalidade global; o contexto e a gravidade importam.",
            "Diretrizes recentes discutem PEEP mais alto em ARDS moderada-grave sem recrutamento de rotina."
          ],
          evidence:["COCHRANE_PEEP_2021","ATS_2024","ESICM_2023","ALVEOLI_2004"]
        });

        points.push({
          title:"SARA: recrutamento e titulação — evitar rotinização de manobras agressivas",
          why:[
            "Manobras de recrutamento prolongadas/alta pressão não são recomendadas de rotina.",
            "Há dados de potencial dano em estratégias de recrutamento+titulação em certos perfis."
          ],
          evidence:["ESICM_2023","ATS_2024","COCHRANE_RECRUIT_2021","RECRUITMENT_ART_HARM"]
        });
      }

      // Sepsis
      if(seps.seps.startsWith("Sepse: sim") || seps.seps.includes("provável")){
        points.push({
          title:"Sepse/choque: definição operacional e integração hemodinâmica–ventilatória",
          why:[
            "Definir sepse por infecção + disfunção orgânica (ΔSOFA) e choque por vasopressor + hiperlactatemia (quando disponível).",
            "Em sepse/choque, a instabilidade circulatória pode alterar a leitura de oxigenação, mecânica e tolerância ao suporte."
          ],
          evidence:["SEPSIS3_2016","SSC_2021"]
        });
      }

      // Obstructive / COPD
      if(st.copd==="sim" || st.obs!=="nao"){
        points.push({
          title:"Fenótipo obstrutivo/DPOC: expiração incompleta, aprisionamento e assincronia",
          why:[
            "Atenção a sinais de expiração incompleta/hiperinsuflação dinâmica (curvas) e seu impacto em disparo e conforto.",
            "Assincronia pode dominar o quadro de esforço e instabilidade."
          ],
          evidence:["ESICM_2023"]
        });
      }

      // Restrictive
      if(st.res!=="nao"){
        points.push({
          title:"Fenótipo restritivo: baixa complacência como hipótese e coerência com imagem",
          why:[
            "Baixa complacência sugere maior risco de carga mecânica; reforça necessidade de coerência entre imagem, oxigenação e mecânica.",
            "Oscilações de esforço e assincronia podem amplificar instabilidade."
          ],
          evidence:["ESICM_2023","ATS_2024"]
        });
      }

      // Neuro
      if(st.neuro==="sim"){
        points.push({
          title:"Neurocrítico: estabilidade ventilatória/PaCO₂ como objetivo educacional",
          why:[
            "Oscilações ventilatórias (especialmente de CO₂) podem ser relevantes em neurocríticos; o foco é estabilidade, não um número fixo.",
            "Esforço/assincronia podem aumentar variação ventilatória."
          ],
          evidence:["ATS_2024"]
        });
      }

      // Neuromuscular / prolonged MV (proxy by neuromuscular flag or SBT tab values)
      const daysSbt = num(wean_days_since_first_sbt?.value);
      const sbtStarted = wean_sbt_started?.value === "sim";
      if(st.nm==="sim" || sbtStarted || (daysSbt!=null && daysSbt>=7)){
        points.push({
          title:"VM prolongada / desmame difícil: rastreabilidade e reabilitação respiratória (IMT como módulo)",
          why:[
            "Classificar padrão de desmame melhora comunicação e rastreabilidade (educacional).",
            "IMT tem evidência de melhora de força; impacto em desfechos de desmame é variável (heterogeneidade)."
          ],
          evidence:["PROLONGED_WEAN_2024","AARC_SBT_2024","IMT_PUBMED_SR_2025","IMT_EINSTEIN_2023"]
        });
      }

      // Unilateral/seletiva (conceito)
      if(st.uni==="sim"){
        points.push({
          title:"Doença unilateral grave: heterogeneidade e risco regional (conceito)",
          why:[
            "Assimetria pode gerar risco de lesão regional; reforça coerência com imagem e observação cuidadosa de curvas.",
            "Discussão de ventilação diferencial é avançada e depende de contexto; aqui é apenas reconhecimento do cenário."
          ],
          evidence:["ESICM_2023"]
        });
      }

      return points;
    }

    // --- Expanded modules (focus: mechanics + asynchrony) ---
    const MODULES = [
      {
        id:"M_ASYNC",
        title:"Assincronia — disparo/fluxo/ciclagem/expiração",
        elig:(st)=> st.async!=="nao" || st.effort!=="nao" || st.copd==="sim",
        signals:[
          {id:"trigger_issue", label:"Compatível com problema de disparo"},
          {id:"flow_mismatch", label:"Compatível com mismatch de fluxo"},
          {id:"cycling_issue", label:"Compatível com ciclagem precoce/tardia (conceito)"},
          {id:"exp_incomplete", label:"Compatível com expiração incompleta (conceito)"}
        ],
        infer:(sel)=>[
          "Inferência educacional: assincronia pode explicar desconforto, variação ventilatória e esforço elevado.",
          "Impacto: priorizar identificação do padrão dominante e coerência com mecânica/tempo expiratório."
        ].join("\n"),
        evidence:["ESICM_2023"]
      },
      {
        id:"M_OBSTRUCTION",
        title:"Mecânica (obstrução) — tempo expiratório/hiperinsuflação dinâmica",
        elig:(st)=> st.obs!=="nao" || st.copd==="sim",
        signals:[
          {id:"exp_flow_not_zero", label:"Fluxo expiratório não zera"},
          {id:"long_exp_tail", label:"Cauda expiratória prolongada"},
          {id:"volume_stacking", label:"Empilhamento em volume×tempo"},
          {id:"cycle_trapping", label:"Aprisionamento por repetição ciclo a ciclo"}
        ],
        infer:(sel)=>{
          const dyn = sel.has("exp_flow_not_zero") && sel.has("volume_stacking");
          return [
            "Inferência educacional: sinais sustentam limitação ao fluxo/expiração incompleta.",
            dyn ? "Combinação sugere hiperinsuflação dinâmica provável (educacional)." : "Risco de aprisionamento deve ser considerado como hipótese educacional."
          ].join("\n");
        },
        evidence:["ESICM_2023"]
      },
      {
        id:"M_RESTRICTION",
        title:"Mecânica (restrição) — baixa complacência como hipótese",
        elig:(st)=> st.res!=="nao",
        signals:[
          {id:"small_vt_large_p", label:"Pequeno VT para grande variação de pressão (conceito)"},
          {id:"pv_loop_narrow", label:"Loop P–V estreito (conceito)"},
          {id:"hysteresis_low", label:"Histerese reduzida (conceito)"},
          {id:"no_obstr_dominant", label:"Ausência de padrão obstrutivo predominante"}
        ],
        infer:(sel)=>{
          const lowComp = sel.has("pv_loop_narrow") || sel.has("small_vt_large_p");
          return [
            "Inferência educacional: fenótipo restritivo/baixa complacência como hipótese.",
            lowComp ? "Baixa complacência provável (educacional)." : "Restrição provável com necessidade de coerência clínica."
          ].join("\n");
        },
        evidence:["ESICM_2023","ATS_2024"]
      },
      {
        id:"M_EFFORT",
        title:"Esforço/drive — sinais e impacto ventilatório (educacional)",
        elig:(st)=> st.effort!=="nao" || st.neuro==="sim",
        signals:[
          {id:"pressure_notches", label:"Entalhes/deflexões sugerindo esforço"},
          {id:"double_trigger", label:"Dupla ativação/empilhamento sugeridos"},
          {id:"irregular_timing", label:"Irregularidade consistente do timing"},
          {id:"pressure_osc", label:"Oscilações de pressão durante o ciclo"}
        ],
        infer:(sel)=>[
          "Inferência educacional: esforço/drive elevado pode aumentar instabilidade e interagir com assincronia e mecânica.",
          "Impacto: reforçar rastreabilidade do padrão e coerência com oxigenação/CO₂."
        ].join("\n"),
        evidence:["ESICM_2023","ATS_2024"]
      }
    ];

    function eligibleModules(st){
      return MODULES.filter(m=>m.elig(st));
    }

    function buildModules(){
      const st = getCompactState();
      modulesContainer.innerHTML="";
      if(st.adult!=="sim"){ pillModules.textContent="bloqueado"; return; }

      const mods=eligibleModules(st);
      pillModules.textContent = mods.length + " módulos";

      mods.forEach(mod=>{
        const box=document.createElement("div");
        box.className="card";
        box.style.background="rgba(0,0,0,.18)";
        box.style.boxShadow="none";

        const h=document.createElement("h2");
        h.textContent=mod.title;

        const det=document.createElement("details");
        det.open=true;

        const sum=document.createElement("summary");
        sum.textContent="Sinais observáveis (marque ≥1)";
        det.appendChild(sum);

        const ul=document.createElement("ul");
        ul.className="sigList";

        mod.signals.forEach(sig=>{
          const li=document.createElement("li");
          li.className="sigItem";

          const cb=document.createElement("input");
          cb.type="checkbox";
          cb.id=`sig_${mod.id}_${sig.id}`;

          const sp=document.createElement("span");
          sp.textContent=sig.label;

          li.appendChild(cb); li.appendChild(sp);
          ul.appendChild(li);
        });

        det.appendChild(ul);

        const ev=document.createElement("div");
        ev.className="refs";
        ev.innerHTML = `<b>Evidência (âncoras):</b><br/>` + renderRefs(mod.evidence);

        box.appendChild(h);
        box.appendChild(det);
        box.appendChild(ev);

        modulesContainer.appendChild(box);
      });
    }

    function selectedSignals(mod){
      const s=new Set();
      mod.signals.forEach(sig=>{
        const cb=document.getElementById(`sig_${mod.id}_${sig.id}`);
        if(cb && cb.checked) s.add(sig.id);
      });
      return s;
    }

    function renderRefs(keys){
      return keys.map(k=>{
        const e=EVID[k];
        return `<span class="tag">${e.tag}</span> <a href="${e.url}" target="_blank" rel="noopener">${e.label}</a>`;
      }).join("<br/>");
    }

    // compact state (subset for decision)
    function getCompactState(){
      return {
        adult: adult_18_plus.value,
        support: support_type.value,
        obs: obstructive_suspected.value,
        res: restrictive_suspected.value,
        effort: high_effort.value,
        async: major_async.value,
        copd: copd_known.value,
        nm: neuromuscular.value,
        neuro: neuro_critical.value,
        uni: unilateral_severe.value
      };
    }

    // PEEP table highlighting
    function clearHL(tbl){
      Array.from(tbl.querySelectorAll("tbody tr")).forEach(tr=>tr.classList.remove("hl"));
    }
    function highlightForFiO2(tbl, fio2){
      clearHL(tbl);
      if(fio2==null) return;
      const rows=Array.from(tbl.querySelectorAll("tbody tr"));
      for(const tr of rows){
        const mn=parseFloat(tr.getAttribute("data-min"));
        const mx=parseFloat(tr.getAttribute("data-max"));
        if(fio2>=mn && fio2<=mx){
          tr.classList.add("hl");
          return;
        }
      }
      // If FiO2=1.0 sometimes doesn't match due to 1.01 max
      if(Math.abs(fio2-1.0)<0.0001){
        const last=rows[rows.length-1];
        if(last) last.classList.add("hl");
      }
    }

    // Weaning definidor (educational categories)
    function classifyWeaning(){
      const started = wean_sbt_started.value === "sim";
      const attempts = num(wean_sbt_attempts.value) ?? 0;
      const days = num(wean_days_since_first_sbt.value) ?? 0;
      const trach = wean_trach.value === "sim";

      let label="Desmame: não iniciado";
      let notes=[];

      if(!started){
        label="Desmame: não iniciado (SBT não iniciado)";
      } else {
        // Simplified educational mapping: simple vs difficult vs prolonged (conceptual)
        if(attempts<=1 && days<=1){
          label="Desmame: simples (educacional)";
        } else if(attempts>=2 && attempts<=3 && days<7){
          label="Desmame: difícil (educacional)";
        } else if(attempts>=3 || days>=7){
          label="Desmame: prolongado (educacional)";
        } else {
          label="Desmame: indeterminado (dados incompletos)";
        }
      }

      if(trach){
        notes.push("Traqueostomia presente: pode alterar trajetória e métricas clássicas; manter rastreabilidade educacional.");
      }

      return {label, notes};
    }

    // Populate evidence boxes (static)
    function populateStaticEvidence(){
      // PEEP evidence box
      peepEvidenceBox.innerHTML =
        `<b>Síntese educacional:</b><br/>
         • PEEP alto vs baixo: efeito em mortalidade global é pequeno/incerto; depende de contexto e gravidade.<br/>
         • Diretrizes recentes discutem PEEP mais alto em ARDS moderada-grave sem recrutamento rotineiro.<br/>
         • Recrutamento prolongado/alta pressão não é recomendado de rotina; há dados de potencial dano em estratégias específicas.<br/>
         <div style="margin-top:8px;"><b>Evidência (robusta):</b><br/>
         ${renderRefs(["COCHRANE_PEEP_2021","ATS_2024","ESICM_2023","ALVEOLI_2004","COCHRANE_RECRUIT_2021","RECRUITMENT_ART_HARM"])}</div>`;

      // IMT evidence box
      imtEvidenceBox.innerHTML =
        `<b>Síntese educacional:</b><br/>
         • IMT tende a melhorar força inspiratória; efeitos em sucesso/tempo de desmame variam conforme populações e protocolos.<br/>
         • Tratar como módulo de reabilitação em VM prolongada/desmame difícil, com monitorização multiprofissional (conceito).<br/>
         <div style="margin-top:8px;"><b>Evidência (robusta):</b><br/>
         ${renderRefs(["IMT_PUBMED_SR_2025","IMT_EINSTEIN_2023"])}</div>`;
    }

    // Main compact compute
    function computeCompact(){
      refreshUI();
      if(adult_18_plus.value!=="sim") return;

      calcDP();
      calcVTmlkg();
      const ards=defineARDS();
      const seps=defineSepsis();

      // Confidence heuristic
      let conf="média";
      const pf = num(pf_ratio.value);
      if(ards.status.includes("provável") && !pf) conf="baixa";
      if(seps.seps.includes("provável") && (num(sofa_delta.value)==null)) conf="baixa";
      if(ards.status.startsWith("SARA: sim") || seps.seps.startsWith("Sepse: sim")) conf="média/alta";
      pillConfidence.textContent=conf;

      const st = getState();
      const compact = getCompactState();
      const points = buildPoints(compact, ards, seps);

      const lines=[];
      lines.push("SYNCVENT — SAÍDA EDUCACIONAL");
      lines.push("--------------------------------");
      lines.push(`SARA (Berlin): ${ards_result.value || "—"}`);
      lines.push(`Sepse: ${sepsis_result.value || "—"}`);
      lines.push(`Choque séptico: ${shock_result.value || "—"}`);
      lines.push("");

      // Vent audit descriptors (if present)
      const vtkg = num(vt_mlkg.value);
      const dp = num(dp_auto.value);
      const hasVT = (vtkg!=null && vt_reliability.value!=="nao");
      const hasDP = (pplat.value && peep.value);
      lines.push("Descritores (auditoria educacional):");
      lines.push(`- VT/PBW: ${hasVT ? vt_mlkg.value + " mL/kg (conf.: " + vt_reliability.value + ")" : "não disponível"}`);
      lines.push(`- ΔP: ${hasDP ? dp_auto.value : "não disponível"}`);
      lines.push("");

      lines.push("PONTOS DE ATENÇÃO (por cenário) + evidência robusta:");
      points.forEach((p, i)=>{
        lines.push("");
        lines.push(`${i+1}) ${p.title}`);
        p.why.forEach(w=>lines.push(`- ${w}`));
        lines.push("Evidência:");
        p.evidence.forEach(k=>{
          const e=EVID[k];
          lines.push(`• [${e.tag}] ${e.label}`);
          lines.push(`  ${e.url}`);
        });
      });

      lines.push("");
      lines.push("Próximo passo: abrir 'Mecânica & Assincronia' e marcar sinais observáveis para justificar hipóteses (educacional).");

      outCompact.textContent = lines.join("\n");

      // Modules refresh
      buildModules();

      // PEEP highlight
      updatePeepHighlight();

      // Weaning box
      updateWeaningBox();

      saveState();
    }

    function updateWeaningBox(){
      const w = classifyWeaning();
      let html = `<b>${w.label}</b><br/>`;
      if(w.notes.length){
        html += w.notes.map(n=>`• ${n}`).join("<br/>") + "<br/>";
      }
      html += `<div style="margin-top:8px;"><b>Evidência (robusta):</b><br/>${renderRefs(["AARC_SBT_2024","PROLONGED_WEAN_2024","COCHRANE_PROTOCOL_WEAN","COCHRANE_SBT_PSV_TTUBE"])}</div>`;
      weanResultBox.innerHTML = html;
    }

    function updatePeepHighlight(){
      const v = num(peep_fio2_input.value);
      highlightForFiO2(tblLower, v);
      highlightForFiO2(tblHigher, v);
      // show only chosen strategy highlighted? We'll highlight both but user can focus.
      if(peep_strategy.value==="lower"){
        tblLower.closest("details").open = true;
      } else {
        tblHigher.closest("details").open = true;
      }
    }

    // Expanded compute
    function computeExpanded(){
      if(adult_18_plus.value!=="sim"){
        pillExpConf.textContent="bloqueado";
        outExpanded.textContent="";
        return;
      }
      const st = getCompactState();
      const ards = defineARDS();
      const seps = defineSepsis();

      const mods = eligibleModules(st);
      let any=false;
      let missing=0;

      const lines=[];
      lines.push("SYNCVENT — JUSTIFICATIVA EXPANDIDA (educacional)");
      lines.push("------------------------------------------------");
      mods.forEach(mod=>{
        const sel = selectedSignals(mod);
        if(sel.size===0){ missing++; return; }
        any=true;
        lines.push("");
        lines.push(`• ${mod.title}`);
        lines.push("Sinais selecionados:");
        sel.forEach(id=>{
          const label = mod.signals.find(s=>s.id===id)?.label || id;
          lines.push(`- ${label}`);
        });
        lines.push(mod.infer(sel));
        lines.push("Evidência (âncoras):");
        mod.evidence.forEach(k=>{
          const e=EVID[k];
          lines.push(`• [${e.tag}] ${e.label}`);
          lines.push(`  ${e.url}`);
        });
      });

      if(!any){
        lines.push("");
        lines.push("Nenhum módulo gerou justificativa: marque ≥1 sinal observável em pelo menos 1 módulo elegível.");
      }

      let conf="média";
      if(!any) conf="baixa";
      if(any && missing===0) conf="média/alta";
      pillExpConf.textContent=conf;

      // Tie-back impact
      lines.push("");
      lines.push("Impacto educacional nos pontos de atenção:");
      if(ards.status.startsWith("SARA: sim")) lines.push("- Em SARA, sinais de mecânica/assincronia reforçam vigilância de estabilidade e coerência de suporte.");
      if(seps.seps.startsWith("Sepse: sim")) lines.push("- Em sepse/choque, esforço/assincronia podem aumentar variabilidade e demandam rastreabilidade.");
      if(st.copd==="sim" || st.obs!=="nao") lines.push("- Em obstrução/DPOC, expiração incompleta e assincronia frequentemente dominam a leitura do caso.");
      if(st.res!=="nao") lines.push("- Em restrição, coerência com imagem e carga mecânica (educacional) ganham prioridade.");
      if(st.neuro==="sim") lines.push("- Em neurocrítico, estabilidade de ventilação/CO₂ é central como objetivo educacional.");

      outExpanded.textContent = lines.join("\n");
      saveState();
    }

    // Button wiring
    $("btnRun").onclick=()=>computeCompact();
    $("btnRunExpanded").onclick=()=>computeExpanded();
    $("btnGoExpanded").onclick=()=>{ setTab("expanded"); buildModules(); };
    $("btnSave").onclick=()=>saveState();
    $("btnReset").onclick=()=>resetAll();

    // PEEP tab events
    peep_fio2_input.addEventListener("input", ()=>{ updatePeepHighlight(); saveState(); });
    peep_strategy.addEventListener("change", ()=>{ updatePeepHighlight(); saveState(); });

    // Change events
    document.addEventListener("change", ()=>{
      refreshUI();
      computeCompact();
    });
    document.addEventListener("input", ()=>{
      // keep calculated fields responsive without full rebuild
      calcDP(); calcPF(); defineARDS(); defineSepsis(); calcPBW(); calcVTmlkg();
    });
    support_type.addEventListener("change", refreshUI);

    // Init
    (function init(){
      // restore
      const saved = localStorage.getItem(LS);
      if(saved){
        try{ setState(JSON.parse(saved)); }catch(e){}
      }
      refreshUI();
      populateStaticEvidence();
      computeCompact();
      buildModules();
      updatePeepHighlight();
      updateWeaningBox();
    })();
  </script>
</body>
</html>
